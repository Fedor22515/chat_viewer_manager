<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ChatGPT 对话查看器 ·  · V1.9.2</title>
<style>
  :root{
    --bg:#f6f7f9;
    --panel:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --assistant:#f7f7f8;
    --user:#d2f9ee;
    --border:#e5e7eb;
    --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:14px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Noto Sans CJK SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
  }
  .app{
    display:grid;
    grid-template-columns:320px 1fr;
    grid-template-rows:auto 1fr;
    height:100%;
  }
  header{
    grid-column:1 / -1;
    background:var(--panel);
    border-bottom:1px solid var(--border);
    padding:10px 14px;
    display:flex;
    flex-wrap:wrap;
    gap:10px 16px;
    align-items:center;
  }
  header .title{font-weight:600; margin-right:auto}
  header .group{display:flex; gap:8px; align-items:center;}
  header label{font-size:12px; color:var(--muted)}
  header input[type="text"]{padding:6px 8px; border:1px solid var(--border); border-radius:8px; min-width:120px}
  header input[type="file"]{font-size:12px}
  header select{padding:6px 8px; border:1px solid var(--border); border-radius:8px; background:#fff}
  header .avatar{width:28px; height:28px; border-radius:50%; object-fit:cover; border:1px solid var(--border)}
  header .btn{padding:6px 10px; border:1px solid var(--border); border-radius:8px; background:#fff; cursor:pointer}
  header .btn.danger{border-color:#fecaca; color:#991b1b; background:#fff5f5}
  .status{margin-left:auto; font-size:12px; color:var(--muted)}

  aside{
    background:var(--panel);
    border-right:1px solid var(--border);
    overflow:auto;
    display:flex; flex-direction:column;
  }
  .sidebar-controls{
    padding:10px; border-bottom:1px solid var(--border); display:flex; flex-wrap:wrap; gap:8px; align-items:center;
  }
  .sidebar-controls .btn{padding:4px 8px; border:1px solid var(--border); border-radius:6px; background:#fff; cursor:pointer; font-size:12px}
  .sidebar-controls .btn.danger{border-color:#fecaca; color:#991b1b; background:#fff5f5}
  .list{flex:1; overflow:auto}
  .conv-item{
    display:grid; grid-template-columns:22px 1fr auto;
    gap:8px; align-items:center;
    padding:10px 12px; border-bottom:1px solid var(--border); cursor:grab; user-select:none;
  }
  .conv-item.active{background:#eefbf6}
  .conv-item .handle{font-size:16px; color:#c0c4cc; cursor:grab}
  .conv-title{font-weight:600; font-size:14px}
  .conv-sub{font-size:12px; color:var(--muted)}
  .conv-meta{font-size:11px; color:var(--muted)}
  .conv-check{margin:0}
  .drag-over{outline:2px dashed #a7f3d0; outline-offset:-6px;}

  main{ overflow:auto; padding:16px; }
  .chat{max-width:960px; margin:0 auto; display:flex; flex-direction:column; gap:12px}
  .msg{ display:grid; grid-template-columns:40px minmax(0,1fr); gap:10px; align-items:flex-start; }
  .msg.right{ grid-template-columns:minmax(0,1fr) 40px; }
  .bubble{
    padding:12px 14px;
    border:1px solid var(--border);
    border-radius:14px;
    background:var(--assistant);
    overflow-wrap:anywhere;
    max-width:min(820px,85%);
  }
  .right .bubble{ background:var(--user); justify-self:end; }
  .meta{
    font-size:12px; color:var(--muted); margin-bottom:6px; display:flex; gap:8px; align-items:center;
  }
  .avatar{width:36px; height:36px; border-radius:50%; object-fit:cover; border:1px solid var(--border)}
  .custom{background:#faf5ff; border-color:#e9d5ff} /* 自定义内容 */
  .memory{background:#ecfeff; border-color:#bae6fd} /* 记忆更新 */
  .hidden{display:none}
  .hint{font-size:12px; color:var(--muted)}
  /* markdown-ish */
  .bubble h1,.bubble h2,.bubble h3{margin:8px 0}
  .bubble h1{font-size:20px}
  .bubble h2{font-size:18px}
  .bubble h3{font-size:16px}
  .bubble pre{background:#0b1020; color:#f8fafc; padding:10px; border-radius:10px; overflow:auto}
  .bubble code{background:#f1f5f9; padding:2px 4px; border-radius:4px}
  .bubble blockquote{border-left:3px solid #e5e7eb; margin:6px 0; padding:6px 10px; color:#374151; background:#f9fafb; border-radius:8px}
  .bubble ul, .bubble ol{padding-left:22px}

/* === V2.4 UI adjustments === */
#themePanel{ display:flex; flex-direction:column; max-height:min(84vh, 760px); }
#themePanel .hd{ flex:0 0 auto; }
#themePanel .sec{ flex:1 1 auto; overflow:auto; padding-right:8px; }
body:has(#themePanel[data-open="1"]){ overflow:hidden; }

#themePanel .row-names{ display:grid; grid-template-columns: 80px 1fr 80px 1fr; gap:12px; align-items:center; margin:10px 0; }
#themePanel .row-names label{ font-weight:600; }
#themePanel .row-names input{ height: 2em; line-height: 2em; padding: 0 .6em; font-size: inherit; }

/* 头像双列，与上面的两列对应 */
#themePanel .avatars-dual{ display:grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items:center; }
#themePanel .avatars-dual .col{ display:flex; flex-direction:column; align-items:center; }
#themePanel .mt8{ margin-top:8px; }

/* 头像预览：直径约等于两倍 UI 字号（>=28px） */
#themePanel .avatar-box.small{ 
  --avatar-d: calc(max(28px, var(--ui-font-size, 14px) * 2.0));
  width: var(--avatar-d); height: var(--avatar-d); 
  border-radius:50%; background: var(--nav-bg, #f3f4f6); 
  display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative;
}
#themePanel .avatar-img[src=""]{ display:none; }  /* 未设置时隐藏图片 */
#themePanel .avatar-box.small:has(img[src^="data:"]) .avatar-default{ display:none; }
#themePanel .avatar-box.small:has(img[src^="blob:"]) .avatar-default{ display:none; }
#themePanel .avatar-box.small:has(img[src^="http"]) .avatar-default{ display:none; }

/* 默认字母底色更柔和 */
#themePanel .avatar-default{ font-weight:600; display:flex; align-items:center; justify-content:center; }
#themePanel #userAvatarDefault{ color:#374151; background: var(--user-solid, #d2f9ee); }
#themePanel #assistantAvatarDefault{ color:#111827; background: var(--assistant-solid, #f7f7f8); }

/* 调整色板与行间距以减少整体高度 */
#themePanel .row3{ margin: 8px 0; }
#themePanel .row3 .label{ white-space:nowrap; }
#themePanel .divider{ border-top:1px solid #e5e7eb; margin:12px 0; }

/* === V2.4.1 Compact identity & background row === */
#themePanel .sec{ overflow:auto; padding-right:4px; }
#themePanel .row3{ margin: 6px 0; }
#themePanel .divider{ margin:10px 0; }

#themePanel .row-identity{
  display:grid;
  grid-template-columns: 64px 1fr auto auto 64px 1fr auto auto;
  gap: 8px 12px;
  align-items:center;
  margin: 6px 0 0;
}
#themePanel .row-identity .lbl{ 
  font-weight:600; 
  color: var(--text-strong, #111827);
  font-size: inherit; 
}
#themePanel .row-identity input{ height: 2em; line-height:2em; padding: 0 .6em; font-size: inherit; }

#themePanel .btn.linklike{ 
  border: 1px solid #e5e7eb; border-radius: 8px; padding: 4px 10px; 
  font-size: .95em; background: #fff; box-shadow: 0 1px 0 rgba(0,0,0,.02);
}

#themePanel .avatar-box.xs{ 
  --avatar-d: calc(max(24px, var(--ui-font-size, 14px) * 2.0));
  width: var(--avatar-d); height: var(--avatar-d);
  border-radius: 50%; background: var(--nav-bg, #f3f4f6);
  display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative;
}
#themePanel .avatar-img[src=""]{ display:none; }
#themePanel .avatar-box.xs:has(img[src^="data:"]) .avatar-default{ display:none; }
#themePanel .avatar-box.xs:has(img[src^="blob:"]) .avatar-default{ display:none; }
#themePanel .avatar-box.xs:has(img[src^="http"]) .avatar-default{ display:none; }
#themePanel .avatar-default{ font-weight:600; display:flex; align-items:center; justify-content:center; }
#themePanel #userAvatarDefault{ color:#374151; background: var(--user-solid, #d2f9ee); }
#themePanel #assistantAvatarDefault{ color:#111827; background: var(--assistant-solid, #f7f7f8); }

/* Responsive: when panel narrower, split into two rows */
@media (max-width: 760px){
  #themePanel .row-identity{ grid-template-columns: 64px 1fr auto auto; }
}

/* === V2.4.1r compact refinements === */
#themePanel .sec{ overflow-y:auto; overflow-x:hidden; padding-right:4px; }
#themePanel .row3{ margin:4px 0; }
#themePanel .row-identity{ 
  grid-template-columns: auto 1fr auto auto auto 1fr auto auto;
  gap: 6px 10px;
  margin: 4px 0 2px;
}
#themePanel .row-identity .lbl{ font-size: inherit; }
#themePanel .row-identity input{ height: 2em; line-height:2em; padding:0 .55em; }
#themePanel .avatar-box.xs{ 
  --avatar-d: calc(max(20px, var(--ui-font-size, 14px) * 1.8));
}
#themePanel .btn.linklike{ padding: 2px 8px; border-radius:6px; }

/* === V2.4.2 4x2 identity grid === */
#themePanel .row-identity-2r{
  display:grid;
  grid-template-columns: 64px 1fr 64px 1fr;
  grid-auto-rows: auto;
  gap: 6px 12px;
  align-items:center;
  margin: 2px 0 4px;
}
#themePanel .row-identity-2r .lbl{ font-weight:600; font-size: inherit; }
#themePanel .row-identity-2r input{ height: 2em; line-height:2em; padding: 0 .55em; font-size: inherit; min-width: 0; }
#themePanel .row-identity-2r .avatar-cell{ display:flex; align-items:center; }
#themePanel .row-identity-2r .upload-cell{ display:flex; align-items:center; }
#themePanel .btn.linklike{ padding: 2px 8px; border-radius:6px; }
#themePanel .avatar-box.xs{ 
  --avatar-d: calc(max(20px, var(--ui-font-size, 14px) * 1.8));
  width: var(--avatar-d); height: var(--avatar-d);
  border-radius:50%; background: var(--nav-bg, #f3f4f6);
  display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative;
}
#themePanel .avatar-img[src=""]{ display:none; }
#themePanel .avatar-box.xs:has(img[src^="data:"]) .avatar-default{ display:none; }
#themePanel .avatar-box.xs:has(img[src^="blob:"]) .avatar-default{ display:none; }
#themePanel .avatar-box.xs:has(img[src^="http"]) .avatar-default{ display:none; }
#themePanel .avatar-default{ font-weight:600; display:flex; align-items:center; justify-content:center; }
#themePanel #userAvatarDefault{ color:#374151; background: var(--user-solid, #d2f9ee); }
#themePanel #assistantAvatarDefault{ color:#111827; background: var(--assistant-solid, #f7f7f8); }

/* Reduce vertical spacing for whole panel to keep it flat */
#themePanel .row3{ margin: 4px 0; }
#themePanel .divider{ margin: 8px 0; }
#themePanel .sec{ overflow-y:auto; overflow-x:hidden; padding-right:4px; }
@media (max-width: 760px){
  #themePanel .row-identity-2r{ grid-template-columns: 56px 1fr 56px 1fr; gap: 6px 8px; }
}

/* === V2.4.3 alignment tweaks === */
#themePanel .row-identity-2r{ margin: 0; gap: 6px 12px; }
#themePanel .row3.color .val{ display:flex; align-items:center; gap:8px; }
#themePanel .row3.color .ctrl{ display:flex; align-items:center; gap:8px; }
#themePanel .row3 .swatch{ width: 24px; height: 24px; border-radius:4px; border:1px solid #e5e7eb; }

/* === V2.4.6: page background image layer (non-intrusive) === */
:root{
  --page-bg-image: none;
}
/* Keep color as base, layer image on top */
.app, #cg_nb_stage, :is(#cg_nb_stage .nb-right, .nb-right, .notes-main, .nb-content){
  background-image: var(--page-bg-image) !important;
  background-position: center !important;
  background-size: cover !important;
  background-repeat: no-repeat !important;
}
/* In nav-hidden mode keep same behavior */
body[data-layout="nav-hidden"] #cg_nb_stage{
  background-image: var(--page-bg-image) !important;
}

/* === V2.4.6-fix1: compact linklike buttons in lower controls === */
#themePanel .sec--controls .ctrl .btn.linklike,
#themePanel .sec--controls .ctrl label.btn.linklike{
  font-size: 12.5px;
  line-height: 1.1;
  padding: 3px 8px;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
#themePanel .sec--controls .ctrl{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:nowrap;
}

/* V2.4.6-fix2: tighter buttons to prevent wrapping */
#themePanel .sec--controls .ctrl .btn.linklike,
#themePanel .sec--controls .ctrl label.btn.linklike{
  font-size: 12.5px;
  line-height: 1.1;
  padding: 3px 8px;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
#themePanel .sec--controls .ctrl{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:nowrap;
}
</style>
<style id="theme-1_8_5a">
:root{
  --ui-font-size: 18px;
  --font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei", sans-serif;
  --font-size: 15px;
  --line-height: 1.6;
  --assistant: rgba(240,244,255,1);
  --user: rgba(210,249,238,1);
  --bubble-radius: 14px;
  --bubble-maxw: 85%;
  --bubble-shadow: 0;
  --bg-base: #FAFAFA;
  --nav-bg: #FFFFFF;
  --nav-opacity: 0.92;
  --nav-bg-rgba: rgba(255,255,255,0.92);
  --notes-maxw: 1600px;
  --notes-min: 360px;
  --notes-width-pct: 1;
  --notes-ideal: calc(100vw * var(--notes-width-pct));
}

/* UI 与正文分离 */
body{ font-size: var(--ui-font-size); font-family: var(--font-family); background: var(--bg-base); }
.chat, .messages, .msg, .bubble, .note-body, .note-page, #cg_nb_stage .nb-right, #cg_nb_stage .nb-right .page{
  font-size: var(--font-size); line-height: var(--line-height);
}

/* 气泡视觉（顺序很重要：先助手，后我方，提高优先级） */
.msg .bubble{ background: var(--assistant) !important; }
.msg.right .bubble, .right .bubble{ background: var(--user) !important; }
.bubble{ border-radius: var(--bubble-radius); max-width: min(820px, var(--bubble-maxw)); box-shadow: 0 1px 2px rgba(0,0,0,calc(var(--bubble-shadow)*0.35)); }

/* 侧栏（对话 + 笔记），主区背景与铺满 */
:is(aside, #cg_nb_stage .nb-left, .nb-left, .notes-nav){ background: var(--nav-bg-rgba) !important; }
:is(#cg_nb_stage .nb-right, .nb-right, .notes-main, .nb-content){ background: var(--bg-base) !important; }
:is(#cg_nb_stage .nb-right .page, .nb-right .page, .notes-main .page){ background-color: transparent !important; }
/* 让更外围容器也吃到页面背景，保证铺满 */
.app, #cg_nb_stage{ background: var(--bg-base); }

/* 隐藏侧栏并让笔记主区居中 */
body[data-layout="nav-hidden"] .app{ grid-template-columns: 0 1fr; }
body[data-layout="nav-hidden"] aside{ width:0; min-width:0; overflow:hidden; border:none; padding:0; }
body[data-layout="nav-hidden"] #cg_nb_stage{ grid-template-columns: 0 1fr; background: var(--bg-base); }
body[data-layout="nav-hidden"] #cg_nb_stage .nb-left{ width:0; min-width:0; overflow:hidden; border:none; padding:0; }
body[data-layout="nav-hidden"] #cg_nb_stage .nb-right{ margin-left:auto; margin-right:auto; max-width: var(--notes-maxw, 980px); }

/* 固定对话/笔记切换字号 */
#cg_view_tabs .tab{ font-size:14px !important; line-height:1.1; }

/* 设置面板（整齐三列） */
.settings-fab{ position: fixed; right: 16px; bottom: 16px; z-index: 9999; background:#111827; color:#fff; border:0; border-radius:999px; width:44px; height:44px; cursor:pointer; box-shadow: 0 4px 10px rgba(0,0,0,.18); }
#themePanel{ position: fixed; right: 20px; bottom: 72px; width: 420px; max-height: 80vh; overflow:auto; background:#fff; color:#111; border:1px solid #e5e7eb; border-radius:12px; box-shadow: 0 12px 28px rgba(0,0,0,.18); z-index: 9999; display:none; }
#themePanel[data-open="1"]{ display:block; }
#themePanel header{ position:sticky; top:0; background:#fff; padding:12px 14px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; }
#themePanel .sec{ padding:12px 14px; }
#themePanel .row3{ display:grid; grid-template-columns: 120px 32px 1fr; gap:12px; align-items:center; margin:10px 0; }
#themePanel .row3 .label{ color:#374151; }
#themePanel .row3 .val{ text-align:center; }
#themePanel .row3:not(.color) .val{ visibility:hidden; } /* 保留列宽，避免控件掉到第2列 */
#themePanel .row3 .ctrl{ display:flex; gap:8px; }
#themePanel input[type="range"]{ width:100%; }
#themePanel input[type="color"]{ width: 36px; height: 28px; border:1px solid #ddd; border-radius:6px; padding:0; }

/* === V2.3 UI: 外观设置面板分区与四列布局 === */
#themePanel .divider{ border-top:1px solid #e5e7eb; margin:12px 0; }
#themePanel .subsec-title{ font-weight:600; color:#374151; margin:10px 0 4px; }
#themePanel .row-names{ display:grid; grid-template-columns: 100px 1fr 100px 1fr; gap:12px; align-items:center; margin:10px 0; }
#themePanel .row4{ display:grid; grid-template-columns: 1fr 100px 160px 1fr; gap:12px; align-items:center; margin:10px 0; }
#themePanel .row4 .label{ color:#374151; }
#themePanel .row4 .ctrl{ display:flex; gap:8px; align-items:center; }
#themePanel .row4 .file-name{ color:#6b7280; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* 头像预览区域 */
#themePanel .avatar-initial{ width: 100%; max-width: 120px; padding:6px 8px; }
#themePanel .avatar-box{ width:64px; height:64px; position:relative; border-radius:50%; background: var(--nav-bg, #f3f4f6); display:flex; align-items:center; justify-content:center; overflow:hidden; }
#themePanel .avatar-img{ width:100%; height:100%; object-fit:cover; display:block; }
#themePanel .avatar-default{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:600; color:#fff; background: var(--assistant, #818cf8); }
#themePanel .avatars .btn{ white-space:nowrap; }

/* 背景行补充 */
#themePanel .row4.color #bgSwatch.swatch{ width: 24px; height: 24px; border-radius:4px; border:1px solid #e5e7eb; }

#themePanel .swatch{ width:32px; height:24px; border-radius:6px; border:1px solid #e5e7eb; display:inline-block; }
#themePanel .btn{ padding:6px 10px; border-radius:8px; border:1px solid #e5e7eb; background:#f9fafb; cursor:pointer; }

@media (max-width: 420px){
  #themePanel{ width: 92vw; right: 4vw; }
  #themePanel .row3{ grid-template-columns: 1fr 28px 1fr; }
}

/* === V1.8.6: 笔记右侧内容在隐藏侧栏时居中，并按 --notes-maxw 限宽 === */
body[data-layout="nav-hidden"] #cg_nb_stage{
  grid-template-columns: 0 1fr;
  justify-items: center;
  align-items: start;
  background: var(--bg-base);
}
#cg_nb_stage .nb-right,
#cg_nb_stage .notes-main,
#cg_nb_stage .nb-content{
  width: min(100%, clamp(var(--notes-min), var(--notes-ideal), 100vw)) !important;
  justify-self: center;
}
#cg_nb_stage .nb-right .page,
#cg_nb_stage .notes-main .page,
#cg_nb_stage .nb-content .page{
  margin-left: auto; margin-right: auto;
  max-width: clamp(var(--notes-min), var(--notes-ideal), 100vw);
  background-color: transparent !important;
}
main .chat{ max-width: clamp(var(--notes-min), var(--notes-ideal), 100vw); margin-left:auto; margin-right:auto; }
/* BG propagate */
body, .app, main, #cg_nb_stage, #cg_nb_stage > * { background: var(--bg-base) !important; }

/* === V1.8.6: 对话主视窗 2/3 内容区（两侧各 1/6 空白） === */
@media (min-width: 900px){
  .tab[data-mode="conversation"] .chat{
    box-sizing: border-box;
    padding-left: 16.6667%;
    padding-right: 16.6667%;
  }
}

</style>



<style id="nb-177-rename-style">
#cg_nb_tree input.rename-input{
  font: inherit; color: inherit; background: #fff;
  border: 1px solid #e5e7eb; border-radius: 6px; padding: 2px 6px;
  width: 90%; outline: none;
}
#cg_nb_tree input.rename-input:focus{
  border-color: #93c5fd; box-shadow: 0 0 0 2px rgba(59,130,246,.15);
}
</style>

<style id="nb-176c-style">
#cg_nb_tree .nb-item .row{ cursor: pointer; }
#cg_nb_tree .nb-item .row input[type="checkbox"]{ cursor: auto; }
#cg_nb_tree .nb-item .row .act button{ cursor: pointer; }
</style>

<style id="nb-hide-x">
#cg_nb_tree button.nb-x,
#cg_nb_tree button.pg-x { display:none !important; }
</style>

<style id="nb-176a-style">
#cg_nb_toolbar{ display:flex; align-items:center; gap:12px; margin:8px 0 6px; }
#cg_nb_toolbar .nb-select-all{ display:flex; align-items:center; gap:6px; color:#374151; }
#cg_nb_toolbar .btn[disabled]{ opacity:.5; cursor:not-allowed; }
#cg_nb_tree .nb-item .row{ display:flex; align-items:center; gap:8px; }
#cg_nb_tree .nb-item .row .nb-check{ margin-right:4px; display:flex; align-items:center; }
#cg_nb_tree .nb-item .row .act{ margin-left:auto; display:flex; align-items:center; gap:8px; }
#cg_nb_tree .nb-item .row .nb-toggle{ border:0; background:transparent; font-size:14px; cursor:pointer; color:#6B7280; }
#cg_nb_tree .nb-item .row .nb-toggle:hover{ color:#111827; transform:scale(1.06); }
#cg_nb_tree .page{ display:flex; align-items:center; gap:8px; padding:4px 0; }
#cg_nb_tree .page .pg-check{ display:flex; align-items:center; }
#cg_nb_tree .page .pg-name{ flex:1; }
</style>
<style id="nb-delx-style">
#cg_nb_tree .nb-item .row,
#cg_nb_tree .page { background:#fff; }
#cg_nb_tree .nb-item .row .act { margin-left:auto; display:flex; align-items:center; gap:6px; }
#cg_nb_tree button.nb-x,
#cg_nb_tree button.pg-x {
  border:0; background:transparent; color:#9CA3AF; font-weight:600; padding:0 4px;
  cursor:pointer; line-height:1; font-size:14px;
}
#cg_nb_tree button.nb-x:hover,
#cg_nb_tree button.pg-x:hover { color:#EF4444; transform:scale(1.08); }
#cg_nb_tree .page .pg-x { margin-left:8px; }
</style><script>(function(){
  if(window.__BUS__) return;
  const listeners = Object.create(null);
  window.__BUS__ = {
    on: function(ev, fn){ (listeners[ev]||(listeners[ev]=[])).push(fn); },
    emit: function(ev, payload){
      const arr = listeners[ev]; if(!arr) return;
      for(let i=0;i<arr.length;i++){ try{ arr[i](payload); }catch(e){} }
    }
  };
  if(!document.getElementById('cg_toast')){
    const el=document.createElement('div'); el.id='cg_toast';
    el.style.cssText='position:fixed;left:50%;top:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:8px 12px;border-radius:10px;font-size:12px;box-shadow:0 6px 20px rgba(0,0,0,.2);opacity:0;transition:opacity .2s;z-index:9999';
    document.documentElement.appendChild(el);
    window.toast=function(msg){
      try{
        el.textContent=String(msg||''); el.style.opacity='1';
        clearTimeout(window.__toastTimer__); window.__toastTimer__=setTimeout(()=>{ el.style.opacity='0'; }, 1500);
      }catch(e){}
    }
  }
})();</script>
<style id="v254re-patch">
/* V2.5.4re patch: hide the native file input text ("未选择文件") */
.visually-hidden{
  position:absolute !important;
  width:1px;height:1px;padding:0;margin:-1px;
  overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
}
</style>
<style id="v255re-toolbar-order">
/* V2.5.5re: Toolbar layout reorder (Plan A, CSS-only) */
header{display:flex; flex-wrap:wrap; align-items:center;}
/* Cancel the old "push-all-right" behavior from title */
header .title{order:0; margin-right:12px !important;}
/* Keep file button early on the left */
header .group:has(#fileInput){order:10;}
/* Status stays around the middle and pushes following items to the right */
header #status{order:98; margin-left:auto;}
/* Move the "显示：下拉" group to the right block */
header .group:has(#viewMode){order:99;}
/* Ensure reset button (and any other right-side actions) stay at the far right */
header #resetOrder{order:100;}
</style>
<style id="v256-toolbar-order">
/* V2.9.1: toolbar fine-tune via CSS only (A-scheme) */
/* Keep file chooser near left (tabs' right) */
header .group:has(#fileInput){ order:10; }

/* Status stays in the center-right and pushes the rest to far right */
header #status{ order:50; flex:1 1 auto; text-align:center; }

/* Right cluster: 选择(批量选择) -> 书签 -> 显示下拉 */
header #cg_select_toggle{ order:80; margin-left:0 !important; }
header #cg_bm_toggle{ order:81; margin-left:8px !important; }

/* Ensure the view-mode group remains on the far right of the cluster */
header .group:has(#viewMode){ order:85; }

/* Defensive reset: avoid unexpected margins that break equal spacing */
#cg_nb_toggle{ margin-left:0 !important; }
</style>
<style id="v2_9_15-appearance-btn-order">
  /* V2.9.15: move 外观设置 button into toolbar (left of 书签) */
  header #openTheme{ order:81; margin-left:8px !important; }
  header #cg_bm_toggle{ order:82 !important; } /* push 书签 to the right of 外观设置 */
</style>


<!-- Chat Web UI – v2.5.7 (2025-08-18)
     Incremental patch: notebook view tweaks -->
<style id="v257-notes-view">
  /* 1. Hide the in-view toolbar ("笔记" + "导出当前页") */
  #cg_nb_head,
  #cg_nb_full .cg-view-bar,
  #cg_nb_stage .cg-view-bar{display:none!important;}

  /* Re-claim the vertical space that toolbar occupied */
  #cg_nb_full .nb-grid{height:calc(100vh - 40px)!important;}
  #cg_nb_stage .nb-layout{min-height:calc(100vh - 40px)!important;}

  /* 2. Highlight currently opened notebook/page */
  #cg_nb_list .nb.active,
  #cg_page_list .pg.active,
  #cg_nb_tree .nb-item.active .row,
  #cg_nb_tree .page.active{background:#f1f5f9!important;}

  /* 3. Enlarge "新建笔记本" input */
  #cg_nb_list .add input,
  #cg_nb_tree .mini input{
    flex:1 1 auto;
    height:34px;
    line-height:1.2;
  }
</style>

<script id="v257-notes-view-js">
  (function(){
    document.addEventListener('DOMContentLoaded',()=>{
      document.querySelectorAll('#cg_nb_head,.cg-view-bar')
              .forEach(el=>el.remove());
    });
  })();
</script>


<!-- Chat Web UI – v2.5.8 (2025-08-18)
     Fix: enlarge "新建笔记本" input to match button height -->
<style id="v258-notes-input">
  /* ensure container uses flex layout */
  #cg_nb_list .add,
  #cg_nb_tree .mini{display:flex;align-items:stretch;}

  /* unify heights */
  #cg_nb_list .add input,
  #cg_nb_tree .mini input{
    flex:1 1 auto;
    height:2.5rem;            /* ≈40px */
    padding:0 0.75rem;        /* match .btn horizontal padding */
    border-radius:0.5rem;     /* visual harmony */
    line-height:1.25rem;
  }

  #cg_nb_list .add .btn,
  #cg_nb_tree .mini .btn{
    height:2.5rem!important;
    display:flex;
    align-items:center;
  }
</style>


<!-- Chat Web UI – v2.5.9 (2025-08-18)
     Hot‑fix: force height of "新建笔记本" input via CSS + runtime JS -->
<style id="v259-notes-input-fix">
  /* stronger selector + !important */
  input[id^="cg_nb_new"]{
    height:2.5rem!important;          /* 40px */
    padding:0 0.75rem!important;
    border-radius:0.5rem!important;
    box-sizing:border-box;
  }
  /* keep buttons same height */
  button[id^="cg_nb_add"]{
    height:2.5rem!important;
    padding:0 1rem;
    display:flex;
    align-items:center;
  }
</style>

<script id="v259-notes-input-fix-js">
  (function(){
    const adjust=()=>document.querySelectorAll('input[id^="cg_nb_new"]').forEach(el=>{
      el.style.height='40px';
      el.style.padding='0 12px';
      el.style.borderRadius='8px';
    });
    document.addEventListener('DOMContentLoaded', adjust);
    document.addEventListener('click', e=>{
      if(e.target&&e.target.id&&e.target.id.startsWith('cg_nb_add')) setTimeout(adjust,30);
    });
  })();
</script>


<!-- Chat Web UI – v2.6.0 (2025-08-18)
     Layout: align "新建笔记本" input and "添加" button in single row -->
<style id="v260-notes-add-row">
  /* Ensure container row flex & full width */
  #cg_nb_list .add,
  #cg_nb_tree .mini{
    display:flex!important;
    align-items:stretch;
    width:100%;
    gap:8px;
  }

  /* Input flex-grow to fill remaining width */
  #cg_nb_list .add input,
  #cg_nb_tree .mini input{
    flex:1 1 0%;
    min-width:0; /* allow shrinking */
  }

  /* Button keep fixed min-width but allow shrink */
  #cg_nb_list .add button,
  #cg_nb_tree .mini button{
    flex:0 0 auto;
    padding:0 1rem;
  }
</style>


<!-- Chat Web UI – v2.6.1 (2025-08-18)
     Fix row alignment: override width:100% on notebook-input -->
<style id="v261-notes-add-row-fix">
  #cg_nb_list .add input,
  #cg_nb_tree .mini input{
    width:auto!important;   /* cancel previous 100% rule so flex row can align */
  }
</style>


<!-- Chat Web UI – v2.6.3 (2025-08-18)
     Selector complete: handle stage/full notebook add row -->
<style id="v263-notes-add-row-wide">
  /* Cover all notebook add rows in every view */
  #cg_nb_list .add,
  #cg_nb_page .add,
  #cg_nb_body .add,
  #cg_nb_tree .mini,
  #cg_nb_stage .mini,
  #cg_nb_full .mini{
    display:flex!important;
    align-items:stretch!important;
    width:100%!important;
    gap:8px;
  }
  /* Input fills remaining space, allows shrink */
  #cg_nb_list .add input,
  #cg_nb_tree .mini input,
  #cg_nb_stage .mini input,
  #cg_nb_full .mini input{
    flex:1 1 0!important;
    min-width:0!important;
    width:auto!important;
    height:40px!important;
    padding:0 12px!important;
    border-radius:8px!important;
    box-sizing:border-box!important;
  }
  /* Button constant height */
  #cg_nb_list .add button,
  #cg_nb_tree .mini button,
  #cg_nb_stage .mini button,
  #cg_nb_full .mini button{
    flex:0 0 auto!important;
    height:40px!important;
    padding:0 1rem!important;
    display:flex!important;
    align-items:center!important;
  }
</style>


<!-- V2.6.4 Theme Switcher (light/dark/custom) -->
<style id="v264-theme-mode">
  /* Preset variables for light/dark; custom uses user's own picks via existing controls */
  [data-theme="light"] :root, [data-theme="light"]{
    --bg:#ffffff; --bg-base:#ffffff; --panel:#ffffff; --text:#111827;
    --muted:#6b7280; --border:#e5e7eb; --nav-bg:rgba(255,255,255,.92); --nav-bg-rgba:rgba(255,255,255,.92);
  }
  [data-theme="dark"] :root, [data-theme="dark"]{
    --bg:#0b1220; --bg-base:#0b1220; --panel:#111827; --text:#e5e7eb;
    --muted:#9ca3af; --border:#374151; --nav-bg:rgba(17,24,39,.92); --nav-bg-rgba:rgba(17,24,39,.92);
  }
  #themePanel .row3.thememode .ctrl label{ display:inline-flex; align-items:center; gap:6px; margin-right:10px; cursor:pointer; }
  #themePanel .row3.thememode input[type="radio"]{ transform:translateY(1px); }
</style>


<!-- V2.6.5 Theming & UI refinements -->
<style id="v265-theme-and-ui">
  .msg .bubble{ background: var(--assistant) !important; color: var(--assistant-text, var(--text)) !important; }
  .msg.right .bubble, .right .bubble{ background: var(--user) !important; color: var(--user-text, var(--text)) !important; }

  #cg_nb_tree .nb-item .row, #cg_nb_tree .page{ background: transparent !important; }
  #cg_nb_tree .nb-item.active .row, #cg_nb_tree .page.active{ background: var(--active-bg, rgba(0,0,0,.04)) !important; color: var(--text) !important; }

  #themePanel .row3.thememode{ margin:4px 0 !important; grid-template-columns: 80px 1fr !important; align-items:center !important; }
  #themePanel .sec{ padding-top:8px !important; }

  #themePanel .seg{ display:inline-flex; gap:6px; align-items:center; }
  #themePanel .seg .segbtn{
    position: relative;
    display:inline-flex; align-items:center; justify-content:center;
    min-width: 58px; height: 32px; padding: 0 12px;
    border:1px solid var(--border); border-radius:8px;
    background: var(--nav-bg, var(--panel)); color: var(--text);
    font-size: .92em; cursor:pointer; user-select:none;
  }
  #themePanel .seg .segbtn input{ position:absolute; inset:0; opacity:0; pointer-events:none; }
  #themePanel .seg .segbtn:has(input:checked){
    background: var(--active-bg, rgba(0,0,0,.06));
    border-color: var(--border); box-shadow: inset 0 0 0 1px var(--border);
  }

  #themePanel{ background: var(--panel) !important; color: var(--text) !important; border-color: var(--border) !important; }
  #themePanel header{ background: var(--panel) !important; color: var(--text) !important; border-bottom: 1px solid var(--border) !important; }
  #themePanel .row3 .label, #themePanel .subsec-title{ color: var(--text) !important; }
  #themePanel .btn{ background: var(--nav-bg, var(--panel)) !important; color: var(--text) !important; border-color: var(--border) !important; }
  #themePanel input[type="text"], #themePanel select{ background: var(--panel); color: var(--text); border:1px solid var(--border); border-radius:8px; padding:.3em .6em; }

  [data-theme="light"]{ --assistant:#f7f7f8; --assistant-text:#111827; --user:#d2f9ee; --user-text:#111827; --active-bg:#f1f5f9; }
  [data-theme="dark"]{ --assistant:#1f2937; --assistant-text:#e5e7eb; --user:#134e4a; --user-text:#e5e7eb; --active-bg:rgba(255,255,255,.08); }
</style>


<!-- V2.6.6 theme + bubbles + UI fixes -->
<style id="v266-theme-and-ui-fixes">
  /* --- Segmented buttons align with label in the same row --- */
  #themePanel .row3.thememode{
    margin: 4px 0 !important;
    grid-template-columns: 80px 1fr !important;
    align-items: center !important;
  }
  #themePanel .row3.thememode .ctrl{ display:flex; align-items:center; }
  #themePanel .seg{ display:inline-flex; gap:8px; align-items:center; flex-wrap:nowrap; }
  #themePanel .seg .segbtn{
    white-space: nowrap;
    display:inline-flex; align-items:center; justify-content:center;
    padding:6px 10px;              /* match .btn */
    min-height:32px;               /* approx .btn height */
    border:1px solid var(--border);
    border-radius:8px;
    background: var(--nav-bg, var(--panel));
    color: var(--text);
    font-size: .9em;
    cursor:pointer; user-select:none;
  }
  #themePanel .seg .segbtn:has(input:checked){
    background: var(--active-bg, rgba(0,0,0,.06));
    box-shadow: inset 0 0 0 1px var(--border);
  }
  #themePanel .seg .segbtn input{ position:absolute; inset:0; opacity:0; pointer-events:none; }

  /* --- Bubble text color safeguard --- */
  .msg .bubble{ color: var(--assistant-text, var(--text)) !important; }
  .msg.right .bubble, .right .bubble{ color: var(--user-text, var(--text)) !important; }
</style>


<!-- V2.6.7 UI grid fix: Theme row on one line & compact top spacing -->
<style id="v267-theme-row-grid">
  /* Force theme row to be 2-column grid (label | controls) */
  #themePanel .row3.thememode{
    display:grid !important;
    grid-template-columns: 80px 1fr !important;
    align-items:center !important;
    margin: 4px 0 !important;
  }
  /* Remove the middle placeholder cell so controls stay on the first row */
  #themePanel .row3.thememode .val{ display:none !important; }

  /* Keep segmented buttons inline and consistent with header buttons */
  #themePanel .row3.thememode .ctrl{ display:flex; align-items:center; }
  #themePanel .seg{ display:inline-flex; gap:8px; flex-wrap:nowrap; }
  #themePanel .seg .segbtn{ white-space:nowrap; }

  /* Compact the empty space above the Theme row */
  #themePanel hr{ margin:8px 0 !important; }
  #themePanel .sec.sec--controls{ padding-top:6px !important; }
</style>


<!-- V2.6.8 ThemePanel spacing + button color isolation -->
<style id="v268-themePanel-compact-and-btnfix">
  /* 1) Compact the identity/avatar section (the first .sec) */
  #themePanel .sec:first-of-type{
    padding-top:6px !important;
    padding-bottom:6px !important;
  }
  #themePanel .row-identity-2r{ margin: 0 0 4px !important; }
  #themePanel .divider{ margin: 6px 0 !important; }

  /* 2) Ensure themePanel buttons do NOT inherit nav color */
  #themePanel .btn,
  #themePanel header .btn,
  #themePanel .seg .segbtn{
    background: var(--panel) !important;
    color: var(--text) !important;
    border-color: var(--border) !important;
    box-shadow: none !important;
  }
</style>


<!-- V2.6.9 Notebook tree separators -->
<style id="v269-notes-tree-separators">
  /* visual dividers for notebook rows and page items */
  #cg_nb_tree .nb-item > .row{
    position: relative;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
  }
  #cg_nb_tree .nb-item:first-child > .row{
    border-top: 1px solid var(--border);
  }
  /* pages: only bottom divider */
  #cg_nb_tree .page{
    position: relative;
    border-bottom: 1px solid var(--border);
  }
  /* keep active highlight visible while still showing divider */
  #cg_nb_tree .nb-item.active > .row,
  #cg_nb_tree .page.active{
    background: var(--active-bg, rgba(0,0,0,.04));
    /* borders stay */
  }
</style>


<style id="v290-hide-pages">
/* V2.9.1: hide page-level UI; notebook renders a single default page */
#cg_nb_stage .pages,
#cg_nb_tree .pages,
#cg_nb_tree .icon-btn[data-act="add-page"],
#cg_nb_tree .page .icon-btn[data-act="del-page"]{ display: none !important; }
</style>


<style id="v291-hide-modal-pages">
/* V2.9.1: hide page selection/new page fields in add-to-notebook modal */
#cg_nb_select_modal #cg_nb_sel_pg,
#cg_nb_select_modal #cg_nb_new_pg { display: none !important; }
</style>


<style id="v291-hide-page-ui-stage">
#cg_nb_stage .pages,
#cg_nb_tree .pages { display:none !important; }
</style>



<style id="v299-rename-css">
.nb-entry-head .entry-title .rename-input{
  font: inherit;
  padding: 2px 6px;
  border: 1px solid var(--border, #ddd);
  border-radius: 6px;
  width: min(1260px, 60%);
}
</style>


<style id="v2_9_11-mobile">
/* --- Mobile responsive (<=900px) --- */
.mobile-only{ display:none; }
@media (max-width: 900px){
  .mobile-only{ display:inline-flex; }

  /* Stack layout; sidebar becomes drawer */
  .app{ grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
  aside{
    position: fixed; left:0; top:0; bottom:0;
    width: min(86vw, 360px); max-width: 90vw;
    transform: translateX(-100%);
    transition: transform .25s ease;
    z-index: 9998; background: var(--panel);
    border-right: 1px solid var(--border);
    box-shadow: 0 6px 24px rgba(0,0,0,.18);
  }
  body[data-drawer="open"] aside{ transform: translateX(0); }

  /* Backdrop under drawer */
  #drawerBackdrop{
    position: fixed; inset: 0;
    background: rgba(0,0,0,.35);
    z-index: 9997; display: none;
  }
  body[data-drawer="open"] #drawerBackdrop{ display:block; }
  body[data-nbdrawer="open"] #drawerBackdrop{ display:block; }

  /* Tighten header, hide verbose status */
  header{ gap: 8px 10px; }
  header .status{ display:none; }

  /* Chat width & bubbles */
  main{ padding: 12px; }
  .chat{ max-width: 100%; }
  .bubble{ max-width: 100% !important; }
  .msg{ grid-template-columns: 28px minmax(0,1fr); gap: 8px; }
  .msg.right{ grid-template-columns: minmax(0,1fr) 28px; }
  .avatar{ width:28px; height:28px; }

  /* Theme variables can also shrink UI text a bit (optional) */
  :root{
    --ui-font-size: 16px;
    --font-size: 15px;
    --bubble-maxw: 100%;
  }
}
</style>


<style id="v2_9_12-nb-mobile">
@media (max-width: 900px){
  #cg_nb_full .nb-grid, #cg_nb_full .nb-layout, #cg_nb_stage .nb-layout, #cg_nb_stage .nb-grid{
    display: grid;
    grid-template-columns: 1fr !important;
    grid-template-rows: auto 1fr !important;
  }
  .nb-left{
    position: fixed !important; left:0; top:0; bottom:0;
    width: min(86vw, 360px); max-width: 90vw;
    transform: translateX(-100%) !important;
    transition: transform .25s ease;
    z-index: 9998 !important; background: var(--panel, #fff) !important;
    border-right: 1px solid var(--border, rgba(0,0,0,.1)) !important;
    box-shadow: 0 6px 24px rgba(0,0,0,.18);
    padding: 12px !important;
    overflow: auto !important;
  }
  body[data-nbdrawer="open"] .nb-left{ transform: translateX(0) !important; }
  .nb-right{ min-width: 0 !important; padding: 10px !important; width: 100% !important; }
  .mobile-only{ display:inline-flex; }
}
</style>

<style id="v2_9_14-toolbar-fold">
  @media (max-width: 900px){
    /* 默认折叠：只显示 汉堡、对话/笔记 tabs、折叠按钮 */
    header .title,
    header .group,
    header #resetOrder,
    header .status { display: none; }
  
    header #navToggle,
    header #cg_view_tabs,
    header #toolbarCaret { display: inline-flex; }
  
    /* 展开：显示全部功能区 */
    body[data-tbar='open'] header .title,
    body[data-tbar='open'] header .group,
    body[data-tbar='open'] header #resetOrder,
    body[data-tbar='open'] header .status { display: initial; }
  
    /* 移动端的小布局优化 */
    header{ row-gap: 8px; }
    #cg_view_tabs{ margin-left: 2px; }
    #toolbarCaret{ margin-left: auto; } /* 小箭头靠右 */
  }
  </style>
  

<style id="v2_9_15-hide-fab-initial">
  /* Prevent flash of floating gear before it is moved into toolbar */
  .settings-fab{ display:none !important; }
</style>

<style id="custom-mobile">
/* ① 先确保对话侧栏不会再插入旧的提示 */
aside .sidebar-controls::after{
  content: none !important;
}

/* ② 调整笔记本工具栏 (#cg_nb_toolbar) 允许换行 */
#cg_nb_toolbar{
  flex-wrap: wrap;                /* 让伪元素能掉到下一行 */
}

/* ③ 在笔记本工具栏下方插入提示行 */
#cg_nb_toolbar::after{
  content: "注意：笔记本不支持合并导出";
  display: block;

  flex: 0 0 100%;                 /* 独占整行 */
  width: 100%;

  margin-top: 4px;                /* 与按钮区留间距 */
  color: #6b7280;                 /* 同“新建笔记本”灰色 */
  font-size: 16px;                /* 比默认 14px 大两号 */
  line-height: 1.3;
  font-weight: 400;
}
/* 仅移动端生效 */
 @media (max-width: 900px)
 { /* ① 折叠 & 展开都彻底隐藏标题和状态栏 */ 
 header .title, 
 header .status, 
 body[data-tbar='open'] 
 header .title, 
 body[data-tbar='open'] 
 header .status { display:none !important; } 
 /* ② 禁掉笔记抽屉——隐藏两个触发按钮 */ 
 #nbToggle_stage, #nbToggle_full { display:none !important; } 
 /* 折叠状态(= 没有 data-tbar="open") 时隐藏“书签”按钮 */ 
 body:not([data-tbar='open']) 
 #cg_bm_toggle{ display:none !important; } 
 /* ③ 让外观按钮 (#openTheme) 在折叠态可见 */ 
 #openTheme.settings-fab{ 
   display:inline-flex !important; 
   margin-left:4px; 
   /* 轻微留白 */ 
   } 
   /* ❶ 对话视窗 —— 右侧 conv 列表的 <aside> */ 
   aside{ --mb-sbar: 220px; /* ◄ 把 220 改成想要的宽度即可 */ 
   width: var(--mb-sbar) !important; 
   max-width: var(--mb-sbar) !important; 
   flex: 0 0 var(--mb-sbar) !important; } 
   /* ❷ 笔记本视窗 —— 左侧抽屉外层 (#cg_nb_stage) 与列表 (.nb-left) */ 
   #cg_nb_stage, #cg_nb_stage .nb-left{ 
     width: var(--mb-sbar) !important; 
     max-width: var(--mb-sbar) !important; 
     flex: 0 0 var(--mb-sbar) !important; } 
}

  </style>
  

<!-- Charlie Fix B: mobile drawer click-through/z-index -->
<style>
@media (max-width: 900px) {
  /* Hide the global backdrop when drawer is open to prevent it from eating clicks */
  body[data-nbdrawer="open"] #drawerBackdrop {
    display: none !important;
  }
  /* Raise the whole notes stage above most layers to ensure the drawer is clickable */
  #cg_nb_stage {
    z-index: 10000 !important;
  }
}
</style>
<!-- /Charlie Fix B -->


<!-- Charlie Fix 2.9.17: mobile notebook drawer fixed width (50% viewport) -->
<style>
:root {
  /* unify width token; change here if you want 45vw/60vw later */
  --nb-mobile-drawer-width: 50vw;
}
@media (max-width: 900px) {
  /* When notebook drawer is open, keep left nav at exactly 50% width */
  body[data-nbdrawer="open"] #cg_nb_stage .nb-left {
    width: var(--nb-mobile-drawer-width) !important;
    min-width: var(--nb-mobile-drawer-width) !important;
    max-width: var(--nb-mobile-drawer-width) !important;
    /* make sure content inside can scroll */
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch;
    box-shadow: 2px 0 12px rgba(0,0,0,.12);
  }

  /* Ensure right side remains visible/clickable as the "blank area" to close */
  body[data-nbdrawer="open"] #cg_nb_stage .nb-right {
    pointer-events: auto;
  }
}
</style>
<!-- /Charlie Fix 2.9.17 -->


<!-- Charlie Fix 2.9.18: Appearance panel overlays notes/conversation with high z-index -->
<style>
  /* Base overlay: keep existing sizing but ensure it's always on top */
  #themePanel{
    position: fixed !important;
    z-index: 12000 !important;           /* higher than #cg_nb_stage (10000) and any backdrops */
    top: 12px !important;
    right: 12px !important;
    width: min(720px, 96vw);
    max-width: min(760px, 96vw);
    background: var(--panel, #fff);
    border: 1px solid var(--border, #e5e7eb);
    border-radius: 12px;
    box-shadow: 0 20px 48px rgba(0,0,0,.18);
  }
  /* When notebook drawer is open, still keep the appearance panel on top */
  body[data-nbdrawer="open"] #themePanel{
    z-index: 12050 !important;
  }
  @media (max-width: 900px){
    #themePanel{
      left: 50% !important;
      right: auto !important;
      transform: translateX(-50%);
      top: max(10px, env(safe-area-inset-top, 0px));
      width: min(96vw, 680px);
      max-width: 96vw;
      max-height: calc(100vh - 20px - env(safe-area-inset-top, 0px));
    }
  }
</style>
<!-- /Charlie Fix 2.9.18 -->


<!-- v2.9.30final: credit bar (fixed bottom in left nav & notes nav) -->
<style id="v2_9_30final-credit-css">
/* Make aside a flex column so list scrolls and footer stays fixed */
aside{ overflow: hidden !important; display:flex !important; flex-direction:column !important; }
aside .list{ flex: 1 1 auto !important; min-height: 0 !important; overflow:auto !important; -webkit-overflow-scrolling: touch; }

/* Credit bar visual */
.credit-bar{
  flex: 0 0 auto;
  display: flex; align-items: center; gap: 8px;
  padding: 8px 10px;
  border-top: 1px solid var(--border);
  background: var(--panel);
  color: var(--muted);
  font-size: 12px;           /* match "搜索" label size */
  line-height: 1.2;
  user-select: none;
}
.credit-bar .eye{
  display:inline-flex; align-items:center; justify-content:center;
  width: 22px; height: 22px; border-radius: 6px;
  border: 1px solid var(--border);
  background: #fff; cursor:pointer;
  font-size: 14px;
}
.credit-bar .txt{ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* Hidden state: keep a minimal stub with only the eye button so it can be toggled back */
.credit-bar[data-hidden="1"] .txt{ display:none; }
.credit-bar[data-hidden="1"]{ justify-content: flex-start; }

/* Notes (笔记) left nav: keep existing layout, use sticky footer so tree scrolls */
#cg_nb_stage .nb-left{ position: relative; }
#cg_nb_stage .nb-left .credit-bar{
  position: sticky; bottom: 0;
  z-index: 1;
}

/* Mobile tweaks */
@media (max-width: 900px){
  .credit-bar{ padding: 10px 12px; }
  .credit-bar .eye{ width: 24px; height: 24px; }
}
</style>


<!-- Injected mobile improvements from A 2.9.35fix -->
<style id="v2_9_11-mobile">

/* --- Mobile responsive (<=900px) --- */
.mobile-only{ display:none; }
@media (max-width: 900px){
  .mobile-only{ display:inline-flex; }

  /* Stack layout; sidebar becomes drawer */
  .app{ grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
  aside{
    position: fixed; left:0; top:0; bottom:0;
    width: min(86vw, 360px); max-width: 90vw;
    transform: translateX(-100%);
    transition: transform .25s ease;
    z-index: 9998; background: var(--panel);
    border-right: 1px solid var(--border);
    box-shadow: 0 6px 24px rgba(0,0,0,.18);
  }
  body[data-drawer="open"] aside{ transform: translateX(0); }

  /* Backdrop under drawer */
  #drawerBackdrop{
    position: fixed; inset: 0;
    background: rgba(0,0,0,.35);
    z-index: 9997; display: none;
  }
  body[data-drawer="open"] #drawerBackdrop{ display:block; }
  body[data-nbdrawer="open"] #drawerBackdrop{ display:block; }

  /* Tighten header, hide verbose status */
  header{ gap: 8px 10px; }
  header .status{ display:none; }

  /* Chat width & bubbles */
  main{ padding: 12px; }
  .chat{ max-width: 100%; }
  .bubble{ max-width: 100% !important; }
  .msg{ grid-template-columns: 28px minmax(0,1fr); gap: 8px; }
  .msg.right{ grid-template-columns: minmax(0,1fr) 28px; }
  .avatar{ width:28px; height:28px; }

  /* Theme variables can also shrink UI text a bit (optional) */
  :root{
    --ui-font-size: 16px;
    --font-size: 15px;
    --bubble-maxw: 100%;
  }
}

</style>
<style id="v2_9_12-nb-mobile">

@media (max-width: 900px){
  #cg_nb_full .nb-grid, #cg_nb_full .nb-layout, #cg_nb_stage .nb-layout, #cg_nb_stage .nb-grid{
    display: grid;
    grid-template-columns: 1fr !important;
    grid-template-rows: auto 1fr !important;
  }
  .nb-left{
    position: fixed !important; left:0; top:0; bottom:0;
    width: min(86vw, 360px); max-width: 90vw;
    transform: translateX(-100%) !important;
    transition: transform .25s ease;
    z-index: 9998 !important; background: var(--panel, #fff) !important;
    border-right: 1px solid var(--border, rgba(0,0,0,.1)) !important;
    box-shadow: 0 6px 24px rgba(0,0,0,.18);
    padding: 12px !important;
    overflow: auto !important;
  }
  body[data-nbdrawer="open"] .nb-left{ transform: translateX(0) !important; }
  .nb-right{ min-width: 0 !important; padding: 10px !important; width: 100% !important; }
  .mobile-only{ display:inline-flex; }
}

</style>
<style id="custom-mobile">

/* ① 先确保对话侧栏不会再插入旧的提示 */
aside .sidebar-controls::after{
  content: none !important;
}

/* ② 调整笔记本工具栏 (#cg_nb_toolbar) 允许换行 */
#cg_nb_toolbar{
  flex-wrap: wrap;                /* 让伪元素能掉到下一行 */
}

/* ③ 在笔记本工具栏下方插入提示行 */
#cg_nb_toolbar::after{
  content: "注意：笔记本不支持合并导出";
  display: block;

  flex: 0 0 100%;                 /* 独占整行 */
  width: 100%;

  margin-top: 4px;                /* 与按钮区留间距 */
  color: #6b7280;                 /* 同“新建笔记本”灰色 */
  font-size: 16px;                /* 比默认 14px 大两号 */
  line-height: 1.3;
  font-weight: 400;
}
/* 仅移动端生效 */
 @media (max-width: 900px)
 { /* ① 折叠 & 展开都彻底隐藏标题和状态栏 */ 
 header .title, 
 header .status, 
 body[data-tbar='open'] 
 header .title, 
 body[data-tbar='open'] 
 header .status { display:none !important; } 
 /* ② 禁掉笔记抽屉——隐藏两个触发按钮 */ 
 #nbToggle_stage, #nbToggle_full { display:none !important; } 
 /* 折叠状态(= 没有 data-tbar="open") 时隐藏“书签”按钮 */ 
 body:not([data-tbar='open']) 
 #cg_bm_toggle{ display:none !important; } 
 /* ③ 让外观按钮 (#openTheme) 在折叠态可见 */ 
 #openTheme.settings-fab{ 
   display:inline-flex !important; 
   margin-left:4px; 
   /* 轻微留白 */ 
   } 
   /* ❶ 对话视窗 —— 右侧 conv 列表的 <aside> */ 
   aside{ --mb-sbar: 220px; /* ◄ 把 220 改成想要的宽度即可 */ 
   width: var(--mb-sbar) !important; 
   max-width: var(--mb-sbar) !important; 
   flex: 0 0 var(--mb-sbar) !important; } 
   /* ❷ 笔记本视窗 —— 左侧抽屉外层 (#cg_nb_stage) 与列表 (.nb-left) */ 
   #cg_nb_stage, #cg_nb_stage .nb-left{ 
     width: var(--mb-sbar) !important; 
     max-width: var(--mb-sbar) !important; 
     flex: 0 0 var(--mb-sbar) !important; } 
}

  
</style>
<style id="mobile-fallbacks-css">

  /* Fallback for browsers without :has() */
  body.panel-open{ overflow:hidden !important; }

</style>
<style id="v2_9_34-mobile-openTheme-hide">

/* Hide 外观 when toolbar is collapsed on small screens; only show after expanding */
@media (max-width: 900px){
  body:not([data-tbar='open']) #openTheme{ display:none !important; }
  body[data-tbar='open'] #openTheme{ display:inline-flex !important; }
}

</style>
<style id="v2_9_34-mobile-nb-head-buttons">

@media (max-width: 900px){
  .nb-entry .nb-entry-head{ font-size: 13px; } /* keep header readable */
  .nb-entry .nb-entry-head .icon-btn{
    font-size: inherit !important;
    padding: 2px 6px !important;
    line-height: 1.2;
  }
}

</style>
<style id="v2_9_34-cropper-mobile">

@media (max-width: 900px){
  #cgCropperMask{ inset: env(safe-area-inset-top,0) env(safe-area-inset-right,0) env(safe-area-inset-bottom,0) env(safe-area-inset-left,0); }
  #cgCropper{
    position: fixed !important;
    left: 0 !important; top: 0 !important; transform: none !important;
    width: 100vw !important;
    height: 100dvh !important;
    max-width: 100vw !important; max-height: 100dvh !important;
    border-radius: 0 !important;
  }
  #cgCropper .bd{ height: calc(100dvh - 112px); } /* header+footer approx height; keeps OK button visible */
  #cgCropper .ft{ position: sticky; bottom: 0; }
}

</style>
<style id="v2_9_25-cropper-z-mobile-ui">

/* Cropper must be above theme panel and any UI */
#cgCropperMask{ position:fixed; z-index:2147483646 !important; }
#cgCropper{ position:fixed; z-index:2147483647 !important; }

/* Mobile friendly cropper layout: footer always visible and can wrap to two rows */
@media (max-width: 900px){
  #cgCropper{
    left:0 !important; top:0 !important; width:100vw !important; height:100dvh !important; transform:none !important;
    max-width:100vw !important; max-height:100dvh !important; border-radius:0 !important;
  }
  #cgCropper .bd{ height:calc(100dvh - 128px) !important; overflow:hidden; }
  #cgCropper .ft{ position:sticky; bottom:0; display:flex; flex-wrap:wrap; gap:8px; justify-content:center; padding:10px; background:rgba(255,255,255,.9); backdrop-filter:saturate(120%) blur(4px); }
  #cgCropper .ft .btn{ flex:1 1 45%; min-width:120px; }
}
@media (max-width: 420px){
  #cgCropper .ft .btn{ flex-basis: calc(50% - 8px); min-width: 0; }
}

</style>
<style id="v2_9_25-sidebar-btn-unify">

@media (max-width: 900px){
  .sidebar-controls .btn{ 
    font-size:12px !important; 
    padding:4px 8px !important; 
    line-height:1.2 !important;
    border-radius:10px !important;
    background:#f1f3f5 !important; color:#333 !important; border:1px solid #e5e7eb !important;
  }
  .sidebar-controls .btn.danger{ background:#f1f3f5 !important; color:#333 !important; }
}

</style>
<style id="cg-cropper-style">

#cgCropperMask{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:saturate(90%) blur(2px);display:none;z-index:9999;}
#cgCropper{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(92vw,980px);height:min(82vh,700px);background:#111;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35);display:flex;flex-direction:column;overflow:hidden;color:#eee}
#cgCropper .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#1a1a1a;border-bottom:1px solid #2a2a2a}
#cgCropper .hd .title{font-weight:600;font-size:14px}
#cgCropper .bd{position:relative;flex:1;display:flex;align-items:center;justify-content:center;background:#0f0f0f}
#cgCropper .ft{display:flex;align-items:center;gap:10px;padding:10px 14px;border-top:1px solid #2a2a2a;background:#141414}
#cgCropperCanvas{max-width:100%;max-height:100%;background:#000;touch-action:none}
#cgCropperOverlay{touch-action:none}
#cgCropper .btn{appearance:none;border:0;border-radius:10px;padding:8px 12px;cursor:pointer;background:#2a2a2a;color:#eee}
#cgCropper .btn.primary{background:#4f46e5}
#cgCropper .btn.ghost{background:transparent;border:1px solid #3a3a3a}
#cgCropper .tools{display:flex;gap:10px;align-items:center;margin-left:auto}
#cgCropper .ratio{display:flex;gap:6px}
#cgCropper .ratio .btn{padding:6px 10px;font-size:12px}
#cgCropper .zoom{display:flex;align-items:center;gap:8px}
#cgCropper .zoom input{width:160px}
#cgCropper .preview{display:flex;align-items:center;gap:10px;margin-left:10px}
#cgCropper .chip{border:1px solid #3a2a2a;border-radius:8px;padding:4px 8px;font-size:12px;opacity:.85}
#cgCropper .close{background:transparent;color:#aaa;border:0;font-size:18px;cursor:pointer}

</style>
<style id="v2_9_24-export-mobile">

@media (max-width: 900px){
  #cg_export_modal .cg-card{
    width: 96vw;
    max-width: 96vw;
    max-height: 90vh;
    margin: 0 2vw;
  }
  #cg_export_modal .cg-card-bd{
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }
}

</style>
<style id="v2_9_26-export-zfix">

#cg_export_modal{ z-index:2147483647 !important; }
#cg_export_modal .cg-mask{ z-index: 0; }
#cg_export_modal .cg-card{ z-index: 1; }

</style>
<style id="v2_9_27-bookmarks-mobile">

@media (max-width: 900px){
  #cg_bm_drawer{
    left: 0;
    right: 0;
    width: 100vw;
    max-width: 100vw;
  }
  #cg_bm_head{
    padding: 10px 12px;
  }
  #cg_bm_body{
    flex-direction: column;
  }
  #cg_bm_tags{
    width: auto;
    max-width: 100vw;
    border-right: 0;
    border-bottom: 1px solid var(--bm-border);
    display: flex;
    gap: 6px;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    padding: 10px;
  }
  #cg_bm_tags .tag{
    flex: 0 0 auto;
    white-space: nowrap;
  }
  #cg_bm_list{
    flex: 1;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    padding: 10px;
  }
}

</style>
<style id="v2_9_28r-bm-pointer">

#cg_bm_drawer{ pointer-events: none; }
#cg_bm_drawer.open{ pointer-events: auto; }

</style>
<style id="v2_9_30-mobile-css">

@media (max-width: 900px){
  /* Use safe viewport height */
  #cg_bm_drawer { height: calc(var(--vh, 1vh) * 100); }
  #cg_nb_drawer { height: calc(var(--vh, 1vh) * 100); }
  #cg_export_modal .cg-card { max-height: calc(var(--vh, 1vh) * 90); }
  /* Avoid iOS zoom on inputs */
  #cg_bm_list .bm-rename-input{ font-size: 16px; line-height: 22px; }
}
/* Close-state should not intercept clicks for nb drawer */
#cg_nb_drawer{ pointer-events: none; }
body[data-nbdrawer="open"] #cg_nb_drawer{ pointer-events: auto; }
/* Focus-lock visual (optional): prevent background scroll while keyboard up */
body[data-kblock="1"]{ overflow: hidden; }

</style>
</head>
<body>
<div class="app">
  <header>
    <div class="title">ChatGPT 对话查看器 <span class="hint">V2.9.3（单 HTML · file://）</span></div>
    <button id="navToggle" class="btn mobile-only" aria-label="打开侧栏">☰</button>
    <button id="toolbarCaret" class="btn mobile-only" aria-label="展开功能栏" title="展开功能栏">▾</button>
    <div class="group"><label for="fileInput" class="btn">选择 JSON 文件</label><input id="fileInput" type="file" accept=".json,.jsonl,application/json" class="visually-hidden"/></div>
    <div class="group">
      <label>显示：</label>
      <select id="viewMode">
        <option value="dialogue">纯对话</option>
        <option value="rich" selected>对话 + 自定义 + 记忆</option>
        <option value="notes">仅自定义 & 记忆</option>
      </select>
    </div>
    <!-- moved to themePanel: 用户 -->
    <!-- moved to themePanel: 用户头像 -->
    <button id="resetOrder" class="btn">恢复默认排序</button>
    <div class="status" id="status"></div>
  </header>

  <aside>
    <div class="sidebar-controls">
      <label><input type="checkbox" id="checkAll"/> 全选</label>
      <button id="exportSelected" class="btn danger">导出</button><button id="deleteSelected" class="btn danger">删除选定</button>
    </div>
    <div id="sidebar" class="list"></div>
  
    <div id="cg_credit_bar" class="credit-bar" role="note" aria-label="制作者信息">
      <button class="eye" id="cg_credit_eye" title="隐藏/显示">❤</button>
      <span class="txt">制作者：C&amp;X  ~献给Charlie~</span>
    </div>

  </aside>

  <main>
    <div id="empty" class="hint">请选择或导入一个 JSON 文件（支持 ChatGPT 导出结构 / 简单 messages 结构）。</div>
    <div id="chat" class="chat hidden"></div>
  </main>
</div>

<script>
(() => {
  const __diag = { regex: [], errors: [] };
  function RE(name, body, flags){
    try { const r = new RegExp(body, flags || ''); __diag.regex.push({name, ok:true}); return r; }
    catch(e){ __diag.regex.push({name, ok:false, error:e.message, body, flags}); console.warn('Regex compile failed:', name, e); return null; }
  }
  function replaceRE(input, re, replacement){ if(!re) return input; try { return input.replace(re, replacement); } catch(e){ console.warn('replaceRE failed:', e); return input; } }
  function escapeHTML(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function renderMarkdown(src){
    let text = String(src || '');
    const reFence = RE('fence', '```([\\s\\S]*?)```', 'g');
    const fences = [];
    text = replaceRE(text, reFence, (_, code) => { const idx = fences.push(code) - 1; return `@@FENCE_${idx}@@`; });
    const reBlockquote = RE('blockquote', '^\\s*>\\s?(.*)$', 'gm');
    text = replaceRE(text, reBlockquote, '<blockquote>$1</blockquote>');
    const reH3 = RE('h3', '^### (.*)$', 'gm'); const reH2 = RE('h2', '^## (.*)$', 'gm'); const reH1 = RE('h1', '^# (.*)$', 'gm');
    text = replaceRE(text, reH3, '<h3>$1</h3>'); text = replaceRE(text, reH2, '<h2>$1</h2>'); text = replaceRE(text, reH1, '<h1>$1</h1>');
    const reLink = RE('link', '\\[([^\\]]+)\\]\\((https?:\\/\\/[^\\s)]+)\\)', 'g');
    text = replaceRE(text, reLink, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
    const reBold = RE('bold', '\\*\\*([^*\\n]+)\\*\\*', 'g'); const reEm = RE('em', '\\*([^*\\n]+)\\*', 'g'); const reInline = RE('inline', '`([^`\\n]+)`', 'g');
    text = replaceRE(text, reBold, '<strong>$1</strong>'); text = replaceRE(text, reEm, '<em>$1</em>'); text = replaceRE(text, reInline, '<code>$1</code>');
    const blocks = text.split(/\\n{2,}/);
    for(let i=0;i<blocks.length;i++){
      const lines = blocks[i].split(/\\n/);
      const isList = lines.length>1 && lines.every(ln => /^\\s*(?:-|\\*)\\s+/.test(ln));
      if(isList){ const lis = lines.map(ln => ln.replace(/^\\s*(?:-|\\*)\\s+/, '')).map(li => `<li>${li}</li>`).join(''); blocks[i] = `<ul>${lis}</ul>`; }
      else{ const t = lines.join('\n').trim(); if(!/^<(h\\d|ul|blockquote|pre)/.test(t)){ blocks[i] = '<p>' + t.replace(/\\n/g,'<br/>') + '</p>'; } else { blocks[i] = t; } }
    }
    text = blocks.join('\n');
    const reFenceToken = RE('fenceToken', '@@FENCE_(\\d+)@@', 'g');
    text = replaceRE(text, reFenceToken, (_, iStr) => { const i = Number(iStr) || 0; const raw = fences[i] || ''; let lang = '', body = raw;
      const m = raw.match(/^\\s*([a-zA-Z0-9_-]+)\\n([\\s\\S]*)$/); if(m){ lang = m[1]; body = m[2]; }
      return `<pre><code class="language-${escapeHTML(lang)}">${escapeHTML(body)}</code></pre>`; });
    return text;
  }
  function safeRenderMarkdown(s){ try { return renderMarkdown(s); } catch(e){ console.error('markdown failed:', e); return escapeHTML(String(s)).replace(/\\n/g,'<br/>'); } }
  (function smoke(){ try { renderMarkdown('**bold**\\n\\n- a\\n- b\\n\\n```js\\nconsole.log(1)\\n```'); } catch(e){ alert('Markdown 模块异常：' + e.message); } })();

  const el = sel => document.querySelector(sel);
  const sidebar = el('#sidebar'); const chat = el('#chat'); const empty = el('#empty'); const statusEl = el('#status');
  const fileInput = el('#fileInput'); const viewMode = el('#viewMode'); const resetOrderBtn = el('#resetOrder');
  // re-add toolbar refs and selection set (moved during V2.3 UI refactor)
  const checkAll = document.getElementById('checkAll');
  const deleteSelectedBtn = document.getElementById('deleteSelected');
  let selectedIds = new Set();

  
  // ---- Bind nickname & avatar controls after DOM is ready (moved to themePanel) ----
  function bindIdentityControls(){
    // --- pre-sanitize any polluted localStorage values ---
    try{
      let _un = localStorage.getItem('cg_userName');
      let _an = localStorage.getItem('cg_assistantName');
      if(!_un || String(_un).indexOf('[object')===0) { _un = 'You'; localStorage.setItem('cg_userName', _un); }
      if(!_an || String(_an).indexOf('[object')===0) { _an = 'Assistant'; localStorage.setItem('cg_assistantName', _an); }
      if(typeof userName !== 'string' || String(userName).indexOf('[object')===0) userName = _un;
      if(typeof assistantName !== 'string' || String(assistantName).indexOf('[object')===0) assistantName = _an;
    }catch(e){ /* noop */ }
    
    const userNameInput = el('#userName'); const assistantNameInput = el('#assistantName');
    const userAvatarInput = el('#userAvatar'); const assistantAvatarInput = el('#assistantAvatar');
    const userAvatarPreview = el('#userAvatarPreview'); const assistantAvatarPreview = el('#assistantAvatarPreview');
    if(!userNameInput || !assistantNameInput || !userAvatarInput || !assistantAvatarInput || !userAvatarPreview || !assistantAvatarPreview){
      return false;
    }
    
    // sanitize storage values if previously polluted
    if (typeof userName !== 'string' || String(userName).indexOf('[object')===0) { userName = 'You'; }
    if (typeof assistantName !== 'string' || String(assistantName).indexOf('[object')===0) { assistantName = 'Assistant'; }
// init values
    userNameInput.value = userName; assistantNameInput.value = assistantName;
    if(userAvatar) userAvatarPreview.src = userAvatar;
    if(assistantAvatar) assistantAvatarPreview.src = assistantAvatar;

    // listeners
    userNameInput.addEventListener('input', e => { userName = e.target.value || 'You'; localStorage.setItem('cg_userName', userName); if(current) renderConversation(current); });
    assistantNameInput.addEventListener('input', e => { assistantName = e.target.value || 'Assistant'; localStorage.setItem('cg_assistantName', assistantName); if(current) renderConversation(current); });

    userAvatarInput.addEventListener('change', async e => {
      const file = e.target.files[0]; if(!file) return; const url = await fileToDataURL(file); userAvatar = url; userAvatarPreview.src = url; localStorage.setItem('cg_userAvatar', url); if(current) renderConversation(current);
    });
    assistantAvatarInput.addEventListener('change', async e => {
      const file = e.target.files[0]; if(!file) return; const url = await fileToDataURL(file); assistantAvatar = url; assistantAvatarPreview.src = url; localStorage.setItem('cg_assistantAvatar', url); if(current) renderConversation(current);
    });
    return true;
  }
  // try now; if not ready, bind on DOMContentLoaded
  if(!bindIdentityControls()){
    window.addEventListener('DOMContentLoaded', () => { bindIdentityControls(); }, { once:true });
  }

const DB_NAME = 'chatgpt_viewer'; const DB_VERSION = 1; let db;
  function openDB(){ return new Promise((resolve, reject) => { const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => { const db = e.target.result; if(!db.objectStoreNames.contains('conversations')){ const store = db.createObjectStore('conversations', { keyPath: 'id' }); store.createIndex('title','title',{unique:false}); }
      if(!db.objectStoreNames.contains('meta')){ db.createObjectStore('meta', { keyPath: 'key' }); } };
    req.onsuccess = ()=> resolve(req.result); req.onerror = ()=> reject(req.error); }); }
  async function dbGetAllConversations(){ return new Promise((resolve, reject)=>{ const tx = db.transaction('conversations','readonly'); const store = tx.objectStore('conversations'); const req = store.getAll(); req.onsuccess = ()=> resolve(req.result || []); req.onerror = ()=> reject(req.error); }); }
  async function dbPutConversation(conv){ return new Promise((resolve, reject)=>{ const tx = db.transaction('conversations','readwrite'); tx.objectStore('conversations').put(conv); tx.oncomplete = ()=> resolve(true); tx.onerror = ()=> reject(tx.error); }); }
  async function dbDeleteConversation(id){ return new Promise((resolve, reject)=>{ const tx = db.transaction('conversations','readwrite'); tx.objectStore('conversations').delete(id); tx.oncomplete = ()=> resolve(true); tx.onerror = ()=> reject(tx.error); }); }
  async function dbClearAll(){ return new Promise((resolve,reject)=>{ const tx = db.transaction('conversations','readwrite'); tx.objectStore('conversations').clear(); tx.oncomplete = ()=> resolve(true); tx.onerror = ()=> reject(tx.error); }); }
  async function dbGetMeta(key){ return new Promise((resolve, reject)=>{ const tx = db.transaction('meta','readonly'); const store = tx.objectStore('meta'); const req = store.get(key); req.onsuccess = ()=> resolve((req.result && req.result.value) ?? null); req.onerror = ()=> reject(req.error); }); }
  async function dbSetMeta(key, value){ return new Promise((resolve, reject)=>{ const tx = db.transaction('meta','readwrite'); tx.objectStore('meta').put({key, value}); tx.oncomplete = ()=> resolve(true); tx.onerror = ()=> reject(tx.error); }); }

  let conversations = []; let current = null; let orderMode = 'time-asc'; let customOrder = [];
  (async function init(){ db = await openDB(); const [all, savedMode, savedOrder] = await Promise.all([ dbGetAllConversations(), dbGetMeta('orderMode'), dbGetMeta('customOrder') ]);
    conversations = all || []; orderMode = savedMode || 'time-asc'; customOrder = Array.isArray(savedOrder) ? savedOrder : [];
    applyDefaultSort(); renderSidebar(conversations); window.conversations = conversations; if(conversations.length){ setActive(conversations[0].id); }
    window.__BUILD_META__ = { version:'1.3.2', ok:true, ts: new Date().toISOString(), diag: __diag }; console.log('Viewer build meta:', window.__BUILD_META__);
  })();

  fileInput.addEventListener('change', async (e) => { const file = e.target.files[0]; if(!file) return;
    try{ const text = await file.text(); const json = JSON.parse(text); const imported = extractConversations(json); if(!imported.length) throw new Error('未识别的 JSON 结构');
      const existingTitles = new Set(conversations.map(c => (c.title || '').trim())); const toAdd = imported.filter(c => { const t = (c.title || '').trim(); return t && !existingTitles.has(t); });
      for(const c of toAdd){ await dbPutConversation(c); }
      conversations = await dbGetAllConversations(); applyDefaultSort(); renderSidebar(conversations); window.conversations = conversations;
      if(conversations.length && current == null){ setActive(conversations[0].id); }
      statusEl.textContent = `导入完成：新增 ${toAdd.length} 个，会话总数 ${conversations.length} 个`; if(imported.length > toAdd.length){ alert(`跳过 ${imported.length - toAdd.length} 个同名会话（默认保留已有窗口）`); }
    }catch(err){ alert('解析失败：' + err.message); console.error(err); } finally { fileInput.value = ''; } });

  function renderSidebar(list){
    sidebar.innerHTML = ''; selectedIds.clear(); checkAll.checked = false;
    const ordered = orderedConversations(list);
    ordered.forEach(conv => {
      const div = document.createElement('div'); div.className = 'conv-item'; div.dataset.id = conv.id; div.draggable = true;
      const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.className = 'conv-check';
      checkbox.addEventListener('change', (e)=>{ if(e.target.checked) selectedIds.add(conv.id); else selectedIds.delete(conv.id); });
      const info = document.createElement('div'); info.style.display='flex'; info.style.flexDirection='column'; info.style.gap='3px';
      const title = document.createElement('div'); title.className='conv-title'; title.textContent = conv.title || '未命名会话';
      const sub = document.createElement('div'); sub.className='conv-sub'; const counts = countStats(filteredMessages(conv));
      sub.textContent = `${counts.visibleCount} 条 · ${counts.charCount} 字符`;
      const meta = document.createElement('div'); meta.className='conv-meta'; meta.textContent = `首条时间：${formatTS(conv.firstTs)}`;
      info.appendChild(title); info.appendChild(sub); info.appendChild(meta);
      const handle = document.createElement('div'); handle.className = 'handle'; handle.textContent = '⋮⋮';
      div.appendChild(checkbox); div.appendChild(info); div.appendChild(handle);
      div.addEventListener('click', (e)=>{ if(e.target === checkbox) return; setActive(conv.id); });
      div.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', conv.id); });
      div.addEventListener('dragover', (e)=>{ e.preventDefault(); div.classList.add('drag-over'); });
      div.addEventListener('dragleave', ()=>{ div.classList.remove('drag-over'); });
      div.addEventListener('drop', async (e)=>{ e.preventDefault(); div.classList.remove('drag-over'); const draggedId = e.dataTransfer.getData('text/plain');
        reorderByDrag(draggedId, conv.id); orderMode = 'manual'; await dbSetMeta('orderMode', orderMode); await dbSetMeta('customOrder', customOrder); renderSidebar(conversations); });
      sidebar.appendChild(div);
    });
    Array.from(sidebar.children).forEach(li => li.classList.toggle('active', li.dataset.id === (current && current.id)));
  }

  function orderedConversations(list){
    if(orderMode === 'manual' && customOrder.length){ const map = new Map(list.map(c=>[c.id,c])); const ordered = customOrder.map(id => map.get(id)).filter(Boolean); const rest = list.filter(c => !customOrder.includes(c.id)); return [...ordered, ...rest]; }
    return [...list].sort((a,b)=> (a.firstTs||Infinity) - (b.firstTs||Infinity));
  }
  function reorderByDrag(dragId, overId){ if(dragId === overId) return; const ids = orderedConversations(conversations).map(c=>c.id);
    const from = ids.indexOf(dragId); const to = ids.indexOf(overId); if(from<0 || to<0) return; ids.splice(to,0,ids.splice(from,1)[0]); customOrder = ids; }
  checkAll && checkAll.addEventListener('change', ()=>{ selectedIds.clear(); Array.from(sidebar.querySelectorAll('.conv-item')).forEach(item => { const id = item.dataset.id; const cb = item.querySelector('.conv-check'); cb.checked = checkAll.checked; if(checkAll.checked) selectedIds.add(id); }); });
  deleteSelectedBtn && deleteSelectedBtn.addEventListener('click', async ()=>{ if(selectedIds.size===0){ alert('未选择任何会话'); return; } if(!confirm(`确认删除选定的 ${selectedIds.size} 个会话？此操作不可撤销。`)) return;
    for(const id of selectedIds){ await dbDeleteConversation(id); } conversations = await dbGetAllConversations();
    customOrder = customOrder.filter(id => conversations.some(c => c.id===id)); await dbSetMeta('customOrder', customOrder); renderSidebar(conversations);
    if(current && !conversations.some(c => c.id===current.id)){ current = conversations[0] || null; if(current) renderConversation(current); else showEmpty(); } });
  /* V1.9 removed deleteAll handler */
  resetOrderBtn.addEventListener('click', async ()=>{ orderMode = 'time-asc'; customOrder = []; await dbSetMeta('orderMode', orderMode); await dbSetMeta('customOrder', customOrder); renderSidebar(conversations); });

  function showEmpty(){ current = null; chat.innerHTML = ''; chat.classList.add('hidden'); empty.classList.remove('hidden'); statusEl.textContent = ''; }
  function setActive(id){ current = conversations.find(c => c.id === id) || null; Array.from(sidebar.children).forEach(li => li.classList.toggle('active', li.dataset.id === id));
    if(current){ empty.classList.add('hidden'); chat.classList.remove('hidden'); renderConversation(current); } }
  viewMode.addEventListener('change', ()=> current && renderConversation(current));

  function renderConversation(conv){
    chat.innerHTML = ''; const msgs = filteredMessages(conv).sort((a,b)=> (a.seqIndex||0)-(b.seqIndex||0));
    const counts = countStats(msgs);
    statusEl.textContent = `${conv.title || '会话'} · 可见 ${counts.visibleCount} 条 · ${counts.charCount} 字符`;
    msgs.forEach(m => {
      const isRight = (m.role === 'user');
      const wrap = document.createElement('div'); wrap.className = 'msg ' + (isRight ? 'right' : '');
      const avatar = document.createElement('img'); avatar.className = 'avatar';
      
      if(m.role === 'user'){
        const letter = initialChar(userName || 'U', 'U');
        const bg = getThemeColor('--user-solid', '#d2f9ee');
        avatar.src = (typeof userAvatar==='string' && userAvatar) ? userAvatar : makeLetterAvatar(letter, bg, '#374151');
      }else if(m.role === 'assistant'){
        const letter = initialChar(assistantName || 'A', 'A');
        const bg = getThemeColor('--assistant-solid', '#f7f7f8');
        avatar.src = (typeof assistantAvatar==='string' && assistantAvatar) ? assistantAvatar : makeLetterAvatar(letter, bg, '#111827');
      }else{
        avatar.src = defaultOther(m.role);
      }
      avatar.onerror = function(){ this.onerror=null; this.src = (m.role==='assistant') ? defaultAssistant() : (m.role==='user' ? defaultUser() : defaultOther(m.role)); };

      const bubble = document.createElement('div'); const catClass = m.category === 'custom' ? 'custom' : m.category === 'memory' ? 'memory' : ''; bubble.className = 'bubble ' + catClass;
      const meta = document.createElement('div'); meta.className = 'meta';
      const nameSpan = document.createElement('span'); nameSpan.textContent = displayName(m.role, m.category);
      const roleTag = document.createElement('span'); roleTag.style.fontSize='11px'; roleTag.style.color='#6b7280'; roleTag.textContent = tagText(m);
      const tsSpan = document.createElement('span'); tsSpan.textContent = formatTS(m.createdAt);
      meta.appendChild(nameSpan); if(roleTag.textContent) { meta.appendChild(document.createTextNode('·')); meta.appendChild(roleTag); } meta.appendChild(document.createTextNode('·')); meta.appendChild(tsSpan);
      if(m.model && m.role === 'assistant'){ const modelSpan = document.createElement('span'); modelSpan.textContent = '· ' + m.model; modelSpan.title='模型'; meta.appendChild(modelSpan); }
      const content = document.createElement('div'); content.innerHTML = safeRenderMarkdown(String(m.content));
      bubble.appendChild(meta); bubble.appendChild(content);
      if(isRight){ wrap.appendChild(bubble); wrap.appendChild(avatar); } else { wrap.appendChild(avatar); wrap.appendChild(bubble); }
      chat.appendChild(wrap);
    });
  }
  function tagText(m){ if(m.category === 'custom') return '自定义'; if(m.category === 'memory'){ return m.memoryKind ? ('记忆·' + m.memoryKind) : '记忆'; } return ''; }

  function filteredMessages(conv){
    const mode = viewMode.value;
    const allowed = mode === 'dialogue' ? new Set(['dialogue']) : mode === 'notes' ? new Set(['custom','memory']) : new Set(['dialogue','custom','memory']);
    const raw = conv.messages.filter(m => allowed.has(m.category));
    // V1.3.2: 过滤掉“记忆·结果”中仅为“Model set context updated.”的提示气泡
    const filtered = raw.filter(m => {
      if(m.category === 'memory' && m.memoryKind === '结果'){
        const txt = String(m.content || '').trim();
        if (txt === 'Model set context updated.' || txt === 'Model set context updated') return false;
      }
      return true;
    });
    return filtered;
  }

  function countStats(msgs){ const visibleCount = msgs.length; const charCount = msgs.reduce((sum,m)=> sum + (String(m.content||'').length),0); return {visibleCount, charCount}; }

  function extractConversations(data){
    const list = [];
    if(data && typeof data === 'object' && data.mapping){ list.push(extractFromMapping(data)); }
    else if(Array.isArray(data)){ data.forEach(item => { if(item && item.mapping) list.push(extractFromMapping(item)); else if(item && item.messages) list.push(extractFromMessages(item)); }); }
    else if(data && Array.isArray(data.conversations)){ data.conversations.forEach(conv => { if(conv.mapping) list.push(extractFromMapping(conv)); else if(conv.messages) list.push(extractFromMessages(conv)); }); }
    else if(data && Array.isArray(data.messages)){ list.push(extractFromMessages(data)); }
    list.forEach(c => { c.firstTs = (c.messages.find(m => m.createdAt != null) || {}).createdAt || null; c.id = c.id || ('conv-' + Math.random().toString(36).slice(2)); c.title = c.title || '未命名会话'; });
    return list;
  }

  function extractFromMapping(obj){
    const map = obj.mapping || {}; const msgsRaw = []; let seq = 0;
    const keys = Object.keys(map);
    for(const key of keys){ const node = map[key]; if(!node || !node.message) continue; const nm = normalizeMessage(node.message, seq++); msgsRaw.push(nm); }
    const firstDlgIdx = msgsRaw.findIndex(m => isDialogueRole(m.role));
    const msgs = msgsRaw.map((m,idx)=> ({...m, category: categorize(m, idx, firstDlgIdx)})).filter(m => String(m.content||'').trim());
    return { id: obj.conversation_id || obj.id || null, title: obj.title || '未命名会话', messages: msgs };
  }

  function extractFromMessages(obj){
    const arr = Array.isArray(obj.messages) ? obj.messages : []; let seq = 0;
    const msgsRaw = arr.map(m => normalizeMessage(m, seq++));
    const firstDlgIdx = msgsRaw.findIndex(m => isDialogueRole(m.role));
    const msgs = msgsRaw.map((m,idx)=> ({...m, category: categorize(m, idx, firstDlgIdx)})).filter(m => String(m.content||'').trim());
    return { id: obj.id || null, title: obj.title || '未命名会话', messages: msgs };
  }

  function isDialogueRole(role){ return role === 'user' || role === 'assistant'; }

  function normalizeMessage(m, seqIndex){
    const role = (m.author && m.author.role) || m.role || 'other';
    const authorName = (m.author && m.author.name) || '';
    const recipient = m.recipient || '';
    const contentObj = m.content || null;
    const contentType = contentObj && contentObj.content_type || '';
    let content = '';
    let model = (m.metadata && (m.metadata.model_slug || m.metadata.default_model_slug || m.model || m.metadata.model)) || m.model || '';

    if(typeof contentObj === 'string'){ content = contentObj; }
    else if(contentObj && Array.isArray(contentObj.parts)){ content = flattenParts(contentObj.parts); }
    else if(Array.isArray(m.contents)){ content = m.contents.map(c => c.text || '').join('\\n\\n'); }

    let hintCategory = ''; let memoryKind = '';

    // 宽松自定义识别
    if(contentType === 'user_editable_context'){
      const fromField = (contentObj.user_instructions) || '';
      const meta = m.metadata || {};
      const fromMeta = (meta.user_context_message_data && (meta.user_context_message_data.about_model_message || meta.user_context_message_data.about_user_message)) || '';
      content = extractCodeOrPlain(content || fromField || fromMeta || '');
      hintCategory = content ? 'custom' : '';
    }
    if(!hintCategory){
      const meta = m.metadata || m.extra_metadata || {};
      const about = meta.user_context_message_data && (meta.user_context_message_data.about_model_message || meta.user_context_message_data.about_user_message);
      const isUserSystem = meta.is_user_system_message === true;
      const instr = contentObj && contentObj.user_instructions;
      const txt = extractCodeOrPlain(String(instr || about || ''));
      if((instr || about || isUserSystem) && txt){ content = txt; hintCategory = 'custom'; }
    }
    if(!hintCategory && typeof content === 'string' && /The user provided the additional info/i.test(content)){
      const fenced = extractCodeOrPlain(content);
      if(fenced && fenced !== content){ content = fenced; hintCategory = 'custom'; }
    }

    // 记忆识别
    if(recipient === 'bio'){ const extracted = extractMemoryContents(content); content = extracted || content; hintCategory = 'memory'; memoryKind = '写入';
    } else if(role === 'tool' && authorName === 'bio'){ hintCategory = 'memory'; memoryKind = '结果';
    } else { const looksCmd = looksLikeMemoryCmd(content); if(looksCmd){ content = extractMemoryContents(content) || content; hintCategory = 'memory'; memoryKind = '写入'; } }

    if(!hintCategory && (m.metadata || m.extra_metadata)){ const mem = pickMemoryText(m.metadata || m.extra_metadata); if(mem){ content = mem; hintCategory = 'memory'; } }

    const createdAt = tsOf(m);
    return { role, authorName, recipient, contentType, content, createdAt, hintCategory, memoryKind, model, seqIndex };
  }

  function extractCodeOrPlain(s){ const str = String(s || ''); const re = RE('codeFenceExtract', '```([\\s\\S]*?)```', 'm'); const m = re && str.match(re); if(m && m[1]) return m[1].trim(); return str.trim(); }
  function looksLikeMemoryCmd(text){ const t = String(text || ''); const reCmd = RE('memCmd', '"cmd"\\s*:\\s*\\[[^\\]]*?"add"[^\\]]*?\\]', ''); const reContents = RE('memContents', '"contents"\\s*:\\s*"', ''); return (reCmd && reCmd.test(t)) && (reContents && reContents.test(t)); }
  function extractMemoryContents(text){
    const t = String(text || ''); const reObj = RE('jsonObj', '{[\\s\\S]*}', '');
    const match = reObj && t.match(reObj);
    if(match){ try{ const obj = JSON.parse(match[0]); if(obj && obj.cmd && Array.isArray(obj.cmd) && obj.cmd.includes('add') && typeof obj.contents === 'string'){ return obj.contents; } }catch{} }
    const reContents = RE('memExtract', '"contents"\\s*:\\s*"([^"]*?)"', ''); const m = reContents && t.match(reContents); if(m && m[1]) return m[1]; return '';
  }
  function tsOf(m){ return m.createdAt || m.create_time || m.update_time || null; }
  function categorize(m, idx, firstDlgIdx){
    if(m.hintCategory === 'memory') return 'memory';
    if(m.hintCategory === 'custom'){ return 'custom'; }
    const isDialogue = isDialogueRole(m.role); if(isDialogue) return 'dialogue'; return 'noise';
  }
  function flattenParts(parts){ const out = []; for(const p of parts){ if(p == null) continue; if(typeof p === 'string'){ out.push(p); continue; }
      if(typeof p === 'object'){ if(typeof p.text === 'string' && p.text.trim()){ out.push(p.text); continue; }
        if(typeof p.content === 'string' && p.content.trim()){ out.push(p.content); continue; }
        if(p.content_type && typeof p.title === 'string' && typeof p.description === 'string'){ out.push(p.title + "\\n" + p.description); continue; }
        if(p.type === 'memory_update' && p.data){ out.push('[记忆更新]\\n' + safeJSON(p.data)); continue; }
        const jsonish = safeJSON(p); if(jsonish && jsonish.length < 2000) out.push(jsonish); } } return out.join('\\n\\n'); }
  function pickMemoryText(meta){ if(!meta || typeof meta !== 'object') return ''; const keys = Object.keys(meta); const hits = keys.filter(k => /memory|remember/i.test(k));
    if(hits.length){ const obj = {}; hits.forEach(k => obj[k] = meta[k]); return '[记忆] ' + safeJSON(obj); } if(meta.type === 'memory_update' && meta.data){ return '[记忆更新]\\n' + safeJSON(meta.data); } return ''; }
  function safeJSON(o){ try{ return JSON.stringify(o, null, 2); }catch{ return ''; } }

  function applyDefaultSort(){ conversations.forEach(c => { c.firstTs = (c.messages.find(m => m.createdAt != null) || {}).createdAt || null; });
    if(orderMode === 'manual' && customOrder.length){ customOrder = customOrder.filter(id => conversations.some(c => c.id===id)); } else { orderMode = 'time-asc'; } }
  function fileToDataURL(file){ return new Promise((res,rej)=>{ const r = new FileReader(); r.onload = ()=> res(r.result); r.onerror = rej; r.readAsDataURL(file); }); }
  function numTS(ts){ if(ts == null) return Number.POSITIVE_INFINITY; if(typeof ts === 'number') return ts * (ts < 1e12 ? 1000 : 1); const t = Date.parse(ts); return isNaN(t) ? Number.POSITIVE_INFINITY : t; }
  function formatTS(ts){ if(ts == null || ts === '') return '-'; let d; if(typeof ts === 'number'){ d = new Date(ts * (ts < 1e12 ? 1000 : 1)); } else { const t = Date.parse(ts); if(isNaN(t)) return '-'; d = new Date(t); }
    const pad = n => String(n).padStart(2,'0'); const Y = d.getFullYear(); const M = pad(d.getMonth()+1); const D = pad(d.getDate()); const h = pad(d.getHours()); const m = pad(d.getMinutes()); const s = pad(d.getSeconds()); return `${Y}-${M}-${D} ${h}:${m}:${s}`; }
  function displayName(role, category){ if(category === 'custom') return '自定义'; if(category === 'memory') return '记忆'; if(role === 'user') return userName || 'You'; if(role === 'assistant') return assistantName || 'Assistant'; return role; }
  function defaultUser(){ return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36"><rect rx="18" ry="18" width="36" height="36" fill="#d1fae5"/><text x="50%" y="54%" text-anchor="middle" font-family="sans-serif" font-size="16" fill="#065f46">U</text></svg>`); }
  function defaultAssistant(){ return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36"><rect rx="18" ry="18" width="36" height="36" fill="#e5e7eb"/><text x="50%" y="54%" text-anchor="middle" font-family="sans-serif" font-size="16" fill="#111827">A</text></svg>`); }
  function defaultOther(role='?'){ return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36"><rect rx="18" ry="18" width="36" height="36" fill="#f3f4f6"/><text x="50%" y="54%" text-anchor="middle" font-family="sans-serif" font-size="14" fill="#374151">${role[0] ? role[0].toUpperCase() : '?'}</text></svg>`); }
})();</script>

<script>
/*! V1.4 stability shim (no-feature-change) */
(function(){
  'use strict';
  // ---- Safe RegExp factory (only if not present) ----
  if (typeof window.RE !== 'function') {
    window.RE = function(name, body, flags){
      try { return new RegExp(body, String(flags||'').replace(/[^gimsuy]/g,'')); }
      catch(e){ console.warn('RE compile fail:', name, e); return /a^/; }
    };
  }

  // ---- IDB: safe open & fallbacks ----
  var SNAP_KEY = 'cg_snapshot_v14';
  var META_KEY = 'cg_snapshot_v14__meta';

  function hasDB(){
    try { return !!window.db; } catch(e){ return false; }
  }

  // monkey-patch openDB to never hard-reject
  if (typeof window.openDB === 'function') {
    var __openDB = window.openDB;
    window.openDB = function(){
      try {
        var p = __openDB();
        return Promise.resolve(p).catch(function(err){ console.warn('openDB failed (shim):', err); return null; });
      } catch (e) {
        console.warn('openDB threw (shim):', e); return Promise.resolve(null);
      }
    };
  }

  function snapRead(){
    try { return JSON.parse(localStorage.getItem(SNAP_KEY) || '{"convs":[]}'); } catch(e){ return {convs:[]}; }
  }
  function snapWrite(snap){
    try { localStorage.setItem(SNAP_KEY, JSON.stringify(snap || {convs:[]})); } catch(e){}
  }
  function metaRead(){
    try { return JSON.parse(localStorage.getItem(META_KEY) || '{}'); } catch(e){ return {}; }
  }
  function metaWrite(m){
    try { localStorage.setItem(META_KEY, JSON.stringify(m || {})); } catch(e){}
  }

  function wrap(name, fallback){
    var old = window[name];
    if (typeof old !== 'function') return;
    window[name] = async function(){
      if(!hasDB()){
        try { return await fallback.apply(this, arguments); } catch(e){ return await fallback(); }
      }
      try { return await old.apply(this, arguments); }
      catch(e){ console.warn('DB op failed; fallback ->', name, e); return await fallback.apply(this, arguments); }
    };
  }

  wrap('dbGetAllConversations', async function(){
    var s = snapRead(); return s.convs || [];
  });
  wrap('dbPutConversation', async function(conv){
    var s = snapRead(); s.convs = s.convs || [];
    var i = s.convs.findIndex(function(c){ return c && c.id === (conv && conv.id); });
    if(i>=0) s.convs[i] = conv; else s.convs.push(conv);
    snapWrite(s); return true;
  });
  wrap('dbDeleteConversation', async function(id){
    var s = snapRead(); s.convs = (s.convs || []).filter(function(c){ return c && c.id !== id; });
    snapWrite(s); return true;
  });
  wrap('dbClearAll', async function(){
    try { localStorage.removeItem(SNAP_KEY); localStorage.removeItem(META_KEY); } catch(e){}
    return true;
  });
  wrap('dbGetMeta', async function(key){
    var m = metaRead(); return (m && Object.prototype.hasOwnProperty.call(m, key)) ? m[key] : null;
  });
  wrap('dbSetMeta', async function(key, value){
    var m = metaRead(); m[key] = value; metaWrite(m); return true;
  });

  // ---- Status bar: show storage kind ----
  function updateStatus(){
    try{
      var el = document.querySelector('#status');
      if(!el) return;
      var txt = el.textContent || '';
      var tag = ' · 存储：';
      var storage = hasDB() ? 'IndexedDB' : '快照/内存';
      if (txt.indexOf(tag) >= 0) {
        el.textContent = txt.replace(/ · 存储：.*/, ' · 存储：' + storage);
      } else {
        el.textContent = txt + tag + storage;
      }
    }catch(e){}
  }
  setTimeout(updateStatus, 800);
  setInterval(updateStatus, 2000);

  // ---- Render post-fix: clean '\n' in non-code blocks; strip known noise bubbles ----
  function postFix(){
    try{
      document.querySelectorAll('.msg .bubble').forEach(function(b){
        var meta = b.querySelector('.meta');
        var body = meta ? meta.nextElementSibling : null;
        if(!body) return;
        // strip known noise
        var text = (body.textContent || '').trim();
        if (/^Model set context updated\.?$/i.test(text) || /Model set context write is pending confirmation by user/i.test(text)) {
          var msg = b.closest('.msg'); if(msg) msg.remove();
          return;
        }
        // replace literal '\n' to real newlines when not within code/blockquote
        if (!body.querySelector('pre, code')) {
          body.innerHTML = body.innerHTML.replace(/\\n/g, '\n');
        }
      });
    }catch(e){}
  }

  // hook renderConversation if present
  var _render = window.renderConversation;
  if (typeof _render === 'function'){
    window.renderConversation = function(conv){
      _render.call(this, conv);
      postFix();
      updateStatus();
    };
  } else {
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(function(){ postFix(); updateStatus(); }, 0); });
  }
})();
</script>


<script>
/*! V1.4.2 Global Search Shim (additive; no feature break) */
(function(){
  'use strict';

  // ---------- DOM helpers ----------
  const $ = (s, root=document) => root.querySelector(s);
  const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));

  // Try to find key anchors in existing DOM (be tolerant to structure)
  const header = $('header') || $('body');
  const aside  = $('aside') || $('.sidebar') || $('body');
  const chat   = $('#chat') || $('main .chat') || $('main') || document.body;
  const statusEl = $('#status');

  // ---------- Inject CSS ----------
  (function injectCSS(){
    const style = document.createElement('style');
    style.textContent = "\n/* === V1.4.2 Global Search UI (additive) === */\n.cg-searchbar{ display:flex; align-items:center; gap:8px; margin-left:auto; }\n.cg-search-input{ padding:6px 10px; border:1px solid #e5e7eb; border-radius:8px; min-width:220px; font-size:14px; }\n.cg-search-stats{ font-size:12px; color:#6b7280; white-space:nowrap; }\n.cg-hl{ background:#fff59d; border-radius:.2em; padding:0 .12em; }\n.cg-search-panel{ border-bottom:1px solid #e5e7eb; padding:8px; background:#fafafa; }\n.cg-search-panel h4{ margin:0 0 6px 0; font-size:12px; color:#6b7280; display:flex; justify-content:space-between; align-items:center; }\n.cg-search-results{ display:flex; flex-direction:column; gap:4px; max-height:160px; overflow:auto; }\n.cg-search-item{ display:flex; justify-content:space-between; align-items:center; padding:6px 8px; border:1px solid #e5e7eb; background:#fff; border-radius:8px; cursor:pointer; }\n.cg-search-item:hover{ background:#f8fafc; }\n.cg-badge{ min-width:1.8em; height:1.6em; padding:0 .4em; border-radius:999px; background:#ecfdf5; color:#065f46; border:1px solid #bbf7d0; font-size:12px; display:inline-flex; align-items:center; justify-content:center; }\n";
    document.head.appendChild(style);
  })();

  // ---------- Build Searchbar in header ----------
  const searchbar = document.createElement('div');
  searchbar.className = 'cg-searchbar';
  const input = document.createElement('input');
  input.type = 'search';
  input.placeholder = '搜索…';
  input.className = 'cg-search-input';
  const stat = document.createElement('span');
  stat.className = 'cg-search-stats';
  stat.textContent = '';
  searchbar.appendChild(input);
  searchbar.appendChild(stat);
  // Insert to header (right side)
  header && header.appendChild(searchbar);

  // ---------- Build Sidebar Results Panel ----------
  const panel = document.createElement('div');
  panel.className = 'cg-search-panel';
  panel.style.display = 'none';
  const h4 = document.createElement('h4');
  const h4title = document.createElement('span'); h4title.textContent = '搜索结果';
  const clearBtn = document.createElement('button'); clearBtn.textContent = '清空'; clearBtn.style.fontSize='12px'; clearBtn.style.border='1px solid #e5e7eb'; clearBtn.style.borderRadius='6px'; clearBtn.style.background='#fff'; clearBtn.style.cursor='pointer'; clearBtn.addEventListener('click', ()=>{ input.value=''; applyQuery(''); });
  h4.appendChild(h4title); h4.appendChild(clearBtn);
  const resultList = document.createElement('div'); resultList.className = 'cg-search-results';
  panel.appendChild(h4); panel.appendChild(resultList);
  // Insert as the first child of aside
  aside && aside.insertBefore(panel, aside.firstChild);

  // ---------- State ----------
  let query = '';
  let convHits = new Map(); // id -> { title, total }
  let activeConvId = null;

  // Hook setActive if exists, to know current active conversation id
  if (typeof window.setActive === 'function') {
    const _setActive = window.setActive;
    window.setActive = function(id){
      activeConvId = id;
      const r = _setActive.apply(this, arguments);
      // After conversation rendered, re-apply highlight
      setTimeout(()=> highlightInCurrent(), 0);
      return r;
    };
  }

  // Also try to deduce active id from sidebar items if they have data-id
  function refreshActiveFromDOM(){
    const active = $('.conv-item.active');
    if(active && active.dataset && active.dataset.id) activeConvId = active.dataset.id;
  }

  // ---------- Utilities ----------
  function debounce(fn, ms){ let t; return function(...args){ clearTimeout(t); t = setTimeout(()=> fn.apply(this, args), ms); }; }
  function norm(s){ return (s||'').toString(); }
  function normLower(s){ return norm(s).toLowerCase(); }
  function countOccurrences(hay, needle){
    if(!needle) return 0;
    const h = normLower(hay), n = normLower(needle);
    let i = 0, pos = 0, cnt = 0;
    if(!n.length) return 0;
    while((pos = h.indexOf(n, i)) !== -1){ cnt++; i = pos + n.length; }
    return cnt;
  }
  function safeTextFromMessage(m){
    if(!m) return '';
    // Prefer content as string
    if (typeof m.content === 'string') return m.content;
    // Some structures use {content:{parts:[]}} or m.contents
    if (m.content && Array.isArray(m.content.parts)) return cleanText(unescapeNL(m.content.parts.join('\n')));
    if (Array.isArray(m.contents)) {
      return m.contents.map(c => (c && (c.text || c.content || '') )).join('\n');
    }
    return '';
  }
  async function getAllConversations(){
    try{
      if (typeof window.dbGetAllConversations === 'function') {
        const list = await window.dbGetAllConversations();
        if (Array.isArray(list)) return list;
      }
    }catch(e){ console.warn('dbGetAllConversations failed', e); }
    // Snapshot fallbacks (v1.4 shim keys)
    const keys = ['cg_snapshot_v14','cg_snapshot_v151','cg_snapshot_v152'];
    for(const k of keys){
      try{
        const raw = localStorage.getItem(k);
        if(raw){
          const obj = JSON.parse(raw);
          if(obj && Array.isArray(obj.convs)) return obj.convs;
        }
      }catch(e){}
    }
    return [];
  }

  // ---------- Core: run search ----------
  const run = debounce(async function(q){
    query = q.trim();
    // Clear previous state
    convHits.clear();
    clearHighlight();

    if(!query){
      stat.textContent = '';
      panel.style.display = 'none';
      // Optional: refresh sidebar to remove any badges (we don't inject badges directly to items for safety)
      return;
    }

    // Compute hits for each conversation
    const convs = await getAllConversations();
    let totalHits = 0;
    let convCount = 0;
    for(const c of convs){
      // Count within user/assistant messages only, as safest common rule
      const msgs = Array.isArray(c.messages) ? c.messages : [];
      let t = 0;
      for(const m of msgs){
        const role = (m.role) || (m.author && m.author.role) || 'other';
        if(role !== 'user' && role !== 'assistant') continue;
        t += countOccurrences(safeTextFromMessage(m), query);
      }
      if(t > 0){
        convHits.set(c.id || c.title || Math.random().toString(36).slice(2), { title: c.title || '未命名会话', total: t, id: c.id });
        totalHits += t; convCount += 1;
      }
    }

    // Update status
    if(totalHits>0){
      stat.textContent = `共 ${convCount} 窗口 / ${totalHits} 处`;
    }else{
      stat.textContent = '无命中';
    }

    // Update sidebar panel
    renderResultsPanel();

    // Highlight in current view (if any and query not empty)
    refreshActiveFromDOM();
    highlightInCurrent();
  }, 200);

  function renderResultsPanel(){
    resultList.innerHTML = '';
    if(convHits.size === 0){
      panel.style.display = 'none'; return;
    }
    const arr = Array.from(convHits.values()).sort((a,b)=> b.total - a.total);
    for(const item of arr){
      const div = document.createElement('div');
      div.className = 'cg-search-item';
      const title = document.createElement('div'); title.textContent = item.title;
      const badge = document.createElement('span'); badge.className = 'cg-badge'; badge.textContent = item.total;
      div.appendChild(title); div.appendChild(badge);
      div.addEventListener('click', ()=>{
        // Prefer programmatic setActive; fallback to clicking sidebar DOM by title
        if(typeof window.setActive === 'function' && item.id){
          window.setActive(item.id);
        }else{
          // Try find a sidebar item with same title text
          const candidates = $$('#sidebar .conv-title, aside .conv-title');
          const el = candidates.find(e => (e.textContent||'').trim() === item.title);
          if(el){ el.closest('.conv-item')?.click(); }
        }
        // Wait a tick, then highlight in that conv
        setTimeout(()=> highlightInCurrent(), 0);
      });
      resultList.appendChild(div);
    }
    panel.style.display = '';
  }

  // ---------- Highlighter (current conversation only) ----------
  function clearHighlight(){
    $$('.cg-hl').forEach(mark => {
      const parent = mark.parentNode;
      if(!parent) return;
      // unwrap mark
      parent.replaceChild(document.createTextNode(mark.textContent||''), mark);
      parent.normalize();
    });
  }
  function highlightInCurrent(){
    if(!query) return;
    const root = chat;
    if(!root) return;
    // Re-scan; skip code-like regions
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
      acceptNode(node){
        const t = node.nodeValue;
        if(!t || !t.trim()) return NodeFilter.FILTER_REJECT;
        // skip if inside pre/code/a/img/script/style/mark
        let el = node.parentElement;
        while(el){
          const tag = el.tagName && el.tagName.toLowerCase();
          if(tag === 'pre' || tag === 'code' || tag === 'a' || tag === 'img' || tag === 'script' || tag === 'style' || tag === 'mark') return NodeFilter.FILTER_REJECT;
          el = el.parentElement;
        }
        return NodeFilter.FILTER_ACCEPT;
      }
    });
    const qLower = query.toLowerCase();
    const nodes = [];
    while(walker.nextNode()){ nodes.push(walker.currentNode); }

    let firstMark = null;
    for(const textNode of nodes){
      const text = textNode.nodeValue||'';
      const lower = text.toLowerCase();
      let idx = 0;
      let lastIndex = 0;
      const ranges = [];
      while((idx = lower.indexOf(qLower, lastIndex)) !== -1){
        ranges.push([idx, idx + qLower.length]);
        lastIndex = idx + qLower.length;
      }
      if(!ranges.length) continue;
      // Replace from tail to head to preserve offsets
      const frag = document.createDocumentFragment();
      let prev = 0;
      for(let i=0;i<ranges.length;i++){
        const [s,e] = ranges[i];
        if(s>prev) frag.appendChild(document.createTextNode(text.slice(prev, s)));
        const mark = document.createElement('mark'); mark.className = 'cg-hl'; mark.textContent = text.slice(s,e);
        if(!firstMark) firstMark = mark;
        frag.appendChild(mark);
        prev = e;
      }
      if(prev < text.length) frag.appendChild(document.createTextNode(text.slice(prev)));
      textNode.parentNode.replaceChild(frag, textNode);
    }
    if(firstMark){
      firstMark.scrollIntoView({behavior:'smooth', block:'center'});
    }
  }

  // ---------- Wire Events ----------
  input.addEventListener('input', (e)=> run(e.target.value || ''));
  input.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){ input.value=''; applyQuery(''); }
  });

  function applyQuery(q){
    run(q);
  }

  // Re-apply highlight after conversation re-render (if we can hook renderConversation)
  if(typeof window.renderConversation === 'function'){
    const _render = window.renderConversation;
    window.renderConversation = function(conv){
      const r = _render.apply(this, arguments);
      setTimeout(()=> highlightInCurrent(), 0);
      return r;
    };
  }

  // Initial
  setTimeout(()=>{ refreshActiveFromDOM(); }, 0);
})();
</script>


<script>
/*! V1.4.3 Global Search++ (additive, safe, no core changes) */
(function(){
  'use strict';
  if (window.__CG_SEARCH_143__) return;
  window.__CG_SEARCH_143__ = true;

  const $ = (s, root=document) => root.querySelector(s);
  const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));

  // --- Anchors & Containers ---
  const aside = $('aside') || $('.sidebar') || document.body;
  const sidebarList = $('#sidebar .conv-list') || $('#sidebar') || aside; // best-effort
  const chatRoot = $('#chat') || $('main .chat') || $('main') || document.body;

  // --- Move/Build Search UI to be ABOVE window list ---
  // Remove any header searchbar inserted by v1.4.2
  const oldHeaderBar = document.querySelector('header .cg-searchbar');
  if (oldHeaderBar && aside) {
    oldHeaderBar.remove();
  }
  // (Re)create search bar for sidebar top
  const topWrap = document.createElement('div');
  topWrap.className = 'cg-searchbar';
  topWrap.style.display = 'flex';
  topWrap.style.alignItems = 'center';
  topWrap.style.gap = '6px';
  topWrap.style.padding = '8px';
  topWrap.style.borderBottom = '1px solid #e5e7eb';
  const input = document.createElement('input');
  input.type = 'search';
  input.placeholder = '搜索…';
  input.className = 'cg-search-input';
  input.style.flex = '1';
  input.style.padding = '6px 10px';
  input.style.border = '1px solid #e5e7eb';
  input.style.borderRadius = '8px';
  input.style.fontSize = '14px';
  const prevBtn = document.createElement('button');
  prevBtn.textContent = '上一处';
  prevBtn.title = 'Shift+Enter / Shift+F3';
  prevBtn.style.fontSize='12px'; prevBtn.style.border='1px solid #e5e7eb'; prevBtn.style.borderRadius='6px'; prevBtn.style.background='#fff'; prevBtn.style.cursor='pointer'; prevBtn.style.padding='6px 8px';
  const nextBtn = document.createElement('button');
  nextBtn.textContent = '下一处';
  nextBtn.title = 'Enter / F3';
  nextBtn.style.fontSize='12px'; nextBtn.style.border='1px solid #e5e7eb'; nextBtn.style.borderRadius='6px'; nextBtn.style.background='#fff'; nextBtn.style.cursor='pointer'; nextBtn.style.padding='6px 8px';
  const stat = document.createElement('span');
  stat.className = 'cg-search-stats';
  stat.style.fontSize='12px'; stat.style.color='#6b7280'; stat.style.whiteSpace='nowrap';
  stat.textContent = '';
  topWrap.appendChild(input);
  topWrap.appendChild(prevBtn);
  topWrap.appendChild(nextBtn);
  topWrap.appendChild(stat);
  if (aside) aside.insertBefore(topWrap, aside.firstChild);

  // Ensure highlight styles
  (function injectCSS(){
    const style = document.createElement('style');
    style.textContent = `
      .cg-hl{ background:#fff59d; border-radius:.2em; padding:0 .12em; }
      .cg-hl-active{ outline:2px solid rgba(99,102,241,.6); background:#fde68a; }
      .cg-badge{ min-width:1.8em; height:1.4em; padding:0 .4em; border-radius:999px; background:#ecfdf5; color:#065f46; border:1px solid #bbf7d0; font-size:12px; display:inline-flex; align-items:center; justify-content:center; }
      .cg-hit-item{ order:-1; } /* hits float to top if container supports flex ordering */
    `;
    document.head.appendChild(style);
  })();

  // --- Helpers ---
  function debounce(fn, ms){ let t; return function(...a){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a),ms); }; }
  function norm(s){ return (s||'').toString(); }
  function lc(s){ return norm(s).toLowerCase(); }
  function countOccur(hay, needle){
    const H = lc(hay), N = lc(needle);
    if(!N) return 0; let i=0, p=0, c=0;
    while((p = H.indexOf(N, i)) !== -1){ c++; i = p + N.length; }
    return c;
  }
  function safeParts(m){
    try{
      if (typeof m.content === 'string') return [m.content];
      if (m.content && Array.isArray(m.content.parts)) return m.content.parts.map(x=>norm(x));
      if (Array.isArray(m.contents)) return m.contents.map(x=> norm(x?.text || x?.content || ''));
      if (m.message && m.message.content && Array.isArray(m.message.content.parts)) return m.message.content.parts.map(x=>norm(x));
    }catch(e){}
    return [];
  }
  function extractMessages(conv){
    // Prefer messages[]
    if (Array.isArray(conv?.messages)) return conv.messages;
    // OpenAI mapping structure
    const map = conv?.mapping || conv?.map;
    if (map && typeof map === 'object'){
      const arr = [];
      for (const k in map){
        const node = map[k];
        const msg = node && (node.message || node.msg || node.data);
        if (!msg) continue;
        const author = msg.author || {};
        const role = author.role || msg.role || 'other';
        const created = msg.create_time || msg.createdAt || msg.created_at || msg.timestamp;
        let parts = [];
        try{
          if (msg.content?.parts) parts = msg.content.parts;
          else if (Array.isArray(msg.parts)) parts = msg.parts;
        }catch(e){}
        arr.push({ role, content: { parts: parts }, createdAt: created });
      }
      return arr;
    }
    return [];
  }
  function firstTimestamp(conv){
    let best = null;
    const msgs = extractMessages(conv);
    for(const m of msgs){
      const t = m.createdAt || m.create_time || (m.message && m.message.create_time);
      if(t==null) continue;
      let ms = null;
      if (typeof t === 'number') ms = (t>1e12? t : t*1000);
      else if (typeof t === 'string') { const d = new Date(t); if(!isNaN(d)) ms = d.getTime(); }
      if (ms!=null && (best==null || ms<best)) best = ms;
    }
    return best || 0;
  }

  async function getAllConversations(){
    // 1) API if present
    try{
      if (typeof window.dbGetAllConversations === 'function'){
        const list = await window.dbGetAllConversations();
        if (Array.isArray(list) && list.length) return list;
      }
    }catch(e){ console.warn('dbGetAllConversations failed', e); }
    // 2) snapshot fallbacks
    const keys = ['cg_snapshot_v14','cg_snapshot_v151','cg_snapshot_v152','cg_snapshot_v14__compat'];
    for(const k of keys){
      try{
        const raw = localStorage.getItem(k);
        if(raw){
          const obj = JSON.parse(raw);
          if(obj && Array.isArray(obj.convs) && obj.convs.length) return obj.convs;
        }
      }catch(e){}
    }
    // 3) known globals (best effort)
    for (const k of ['conversations','__conversations','__CHAT_VIEWER__']) {
      const v = window[k];
      if (Array.isArray(v) && v.length) return v;
      if (v && Array.isArray(v.convs)) return v.convs;
    }
    return [];
  }

  // --- Search State ---
  let query = '';
  let convHits = new Map(); // convId -> { id, title, total, firstTime }
  let marks = []; let markIdx = -1;
  let originalOrder = null;

  // capture original sidebar order once
  function captureOriginalOrder(){
    if(!sidebarList) return;
    if (originalOrder) return;
    const items = $$('.conv-item', sidebarList);
    if (items.length) originalOrder = items.slice();
  }
  captureOriginalOrder();

  // --- Highlight utils ---
  function clearHighlight(){
    $$('.cg-hl').forEach(mark => {
      const parent = mark.parentNode; if(!parent) return;
      parent.replaceChild(document.createTextNode(mark.textContent || ''), mark);
      parent.normalize();
    });
    marks = []; markIdx = -1;
  }
  function applyHighlight(){
    if(!query) return;
    const root = chatRoot; if(!root) return;
    // Remove old active
    $$('.cg-hl-active').forEach(el=> el.classList.remove('cg-hl-active'));
    // Build new marks
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
      acceptNode(node){
        const t = node.nodeValue;
        if(!t || !t.trim()) return NodeFilter.FILTER_REJECT;
        let el = node.parentElement;
        while(el){
          const tag = (el.tagName||'').toLowerCase();
          if (tag==='pre'||tag==='code'||tag==='a'||tag==='img'||tag==='script'||tag==='style'||tag==='mark') return NodeFilter.FILTER_REJECT;
          el = el.parentElement;
        }
        return NodeFilter.FILTER_ACCEPT;
      }
    });
    const qLower = query.toLowerCase();
    const nodes = []; while(walker.nextNode()) nodes.push(walker.currentNode);
    nodes.forEach(textNode => {
      const text = textNode.nodeValue||'';
      const lower = text.toLowerCase();
      let i=0, pos=0, ranges=[];
      while((pos = lower.indexOf(qLower, i)) !== -1){
        ranges.push([pos, pos+qLower.length]); i = pos + qLower.length;
      }
      if(!ranges.length) return;
      const frag = document.createDocumentFragment();
      let prev=0;
      ranges.forEach(([s,e])=>{
        if(s>prev) frag.appendChild(document.createTextNode(text.slice(prev, s)));
        const mk = document.createElement('mark'); mk.className='cg-hl'; mk.textContent = text.slice(s,e);
        frag.appendChild(mk);
        prev=e;
      });
      if(prev<text.length) frag.appendChild(document.createTextNode(text.slice(prev)));
      textNode.parentNode.replaceChild(frag, textNode);
    });
    marks = $$('.cg-hl', root);
    markIdx = marks.length ? 0 : -1;
    if (markIdx >= 0){
      marks[0].classList.add('cg-hl-active');
      marks[0].scrollIntoView({behavior:'smooth', block:'center'});
    }
  }
  function goto(delta){
    if (!marks.length) return;
    // Remove current active
    if (markIdx >= 0 && markIdx < marks.length) marks[markIdx].classList.remove('cg-hl-active');
    markIdx = (markIdx + delta + marks.length) % marks.length;
    const el = marks[markIdx];
    el.classList.add('cg-hl-active');
    el.scrollIntoView({behavior:'smooth', block:'center'});
  }

  // --- Sidebar reorder ---
  function reorderSidebar(){
    if (!sidebarList) return;
    // First, clear previous hit flags
    $$('.conv-item', sidebarList).forEach(el => el.classList.remove('cg-hit-item'));
    if (!query) {
      // Restore original order
      if (originalOrder && originalOrder.length){
        originalOrder.forEach(el => sidebarList.appendChild(el));
      }
      return;
    }
    // Build hit set
    const arr = Array.from(convHits.values()).filter(x=>x.total>0);
    if (!arr.length) { return; }
    // sort by firstTime asc
    arr.sort((a,b)=> (a.firstTime||0) - (b.firstTime||0));
    // map title/id -> conv-item
    function findItemById(id){
      if (!id) return null;
      const byData = $$('.conv-item[data-id]', sidebarList).find(el => el.dataset.id===String(id));
      if (byData) return byData;
      return null;
    }
    function findItemByTitle(title){
      const spans = $$('.conv-item .conv-title', sidebarList);
      const s = spans.find(sp => (sp.textContent||'').trim() === title);
      return s ? s.closest('.conv-item') : null;
    }
    arr.forEach(x=>{
      let el = findItemById(x.id) || findItemByTitle(x.title);
      if (el){
        el.classList.add('cg-hit-item');
        sidebarList.insertBefore(el, sidebarList.firstChild);
      }
    });
  }

  // --- Run search (global count + reorder + current highlight) ---
  const run = debounce(async function(q){
    query = (q||'').trim();
    convHits.clear();
    clearHighlight();

    if(!query){
      stat.textContent = '';
      reorderSidebar(); // restore order
      return;
    }

    const convs = await getAllConversations();
    let totalHits = 0, convCount = 0;
    for (const c of convs){
      const msgs = extractMessages(c);
      let t=0;
      for(const m of msgs){
        const role = m.role || (m.author && m.author.role) || 'other';
        if (role!=='user' && role!=='assistant') continue;
        for(const part of safeParts(m)){
          t += countOccur(part, query);
        }
      }
      if (t>0){
        convHits.set((c.id || c.title || Math.random().toString(36).slice(2)), {
          id: c.id, title: c.title || '未命名会话', total: t, firstTime: firstTimestamp(c)
        });
        totalHits += t; convCount += 1;
      }
    }

    if (convCount>0) stat.textContent = `共 ${convCount} 窗口 / ${totalHits} 处`;
    else stat.textContent = '无命中';

    // Reorder sidebar by hits
    reorderSidebar();

    // Highlight in current conversation view (if it matches query)
    applyHighlight();
  }, 200);

  // Wire input / buttons / keys
  input.addEventListener('input', e=> run(e.target.value || ''));
  prevBtn.addEventListener('click', ()=> goto(-1));
  nextBtn.addEventListener('click', ()=> goto(+1));
  input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); goto(+1); }
    else if ((e.key==='Enter' && e.shiftKey)) { e.preventDefault(); goto(-1); }
    else if (e.key==='F3' && !e.shiftKey) { e.preventDefault(); goto(+1); }
    else if (e.key==='F3' && e.shiftKey) { e.preventDefault(); goto(-1); }
    else if (e.key==='Escape'){ input.value=''; run(''); }
  });

  // Hook renders to re-apply highlight
  function hook(fnName){
    const fn = window[fnName];
    if (typeof fn === 'function'){
      window[fnName] = function(){
        const r = fn.apply(this, arguments);
        // After re-render, re-apply highlight for current view
        setTimeout(()=> applyHighlight(), 0);
        return r;
      }
    }
  }
  hook('renderConversation');
  hook('setActive');

  // Initial
  setTimeout(()=> { /* in case user types quickly */ }, 0);
})();
</script>

<style>:root{ --bm-accent:#0ea5e9; --bm-muted:#64748b; --bm-border:#e5e7eb; --bm-bg:#ffffff; }
[data-theme="dark"] :root, [data-theme="dark"]{ --bm-accent:#38bdf8; --bm-muted:#94a3b8; --bm-border:#334155; --bm-bg:#0f172a; }
.msg .cg-bm-star{ position:absolute; top:6px; right:-2px; width:18px; height:18px; line-height:18px; text-align:center; border-radius:50%; cursor:pointer; user-select:none; font-size:14px; color:var(--bm-muted); background:transparent; transition:transform .12s ease, color .12s ease; }
.msg:hover .cg-bm-star{ color:var(--bm-accent); transform:scale(1.05); }
.msg .cg-bm-star.active{ color:#f59e0b; }
.msg{ position:relative; }
@keyframes cg-bm-flash { 0%{box-shadow:0 0 0 0 rgba(14,165,233,.0);} 30%{box-shadow:0 0 0 4px rgba(14,165,233,.25);} 100%{box-shadow:0 0 0 0 rgba(14,165,233,.0);} }
.msg.cg-bm-flash{ animation: cg-bm-flash 1200ms ease; border-radius:10px; }
.cg-bm-pop{ position:absolute; top:26px; right:0; z-index:20; min-width:220px; background:var(--bm-bg); border:1px solid var(--bm-border); border-radius:10px; padding:8px; box-shadow:0 6px 24px rgba(0,0,0,.08); }
.cg-bm-pop h4{ margin:0 0 6px; font-size:12px; color:var(--bm-muted); }
.cg-bm-pop .row{ display:flex; align-items:center; gap:6px; margin:6px 0; }
.cg-bm-pop input[type="text"], .cg-bm-pop select{ flex:1; padding:6px 8px; border:1px solid var(--bm-border); border-radius:8px; background:transparent; color:inherit; }
.cg-bm-pop .actions{ display:flex; justify-content:flex-end; gap:8px; }
.cg-bm-btn{ padding:6px 10px; border-radius:8px; border:1px solid var(--bm-border); background:transparent; cursor:pointer; }
.cg-bm-btn.primary{ border-color:var(--bm-accent); color:#fff; background:var(--bm-accent); }
#cg_bm_toggle{ margin-left:6px; }
#cg_bm_drawer{ position:fixed; top:0; right:0; bottom:0; width:420px; transform:translateX(100%); background:var(--bm-bg); border-left:1px solid var(--bm-border); box-shadow:-8px 0 24px rgba(0,0,0,.08); z-index:1000; display:flex; flex-direction:column; transition: transform .18s ease; }
#cg_bm_drawer.open{ transform:translateX(0); }
#cg_bm_head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--bm-border); }
#cg_bm_head .title{ font-weight:600; }
#cg_bm_body{ display:flex; min-height:0; flex:1; }
#cg_bm_tags{ width:140px; border-right:1px solid var(--bm-border); padding:10px; overflow:auto; }
#cg_bm_tags .tag{ display:flex; align-items:center; justify-content:space-between; gap:6px; padding:6px 8px; border-radius:8px; cursor:pointer; margin-bottom:6px; }
#cg_bm_tags .tag.active{ background:rgba(14,165,233,.12); }
#cg_bm_tags .add{ display:flex; gap:6px; margin-top:8px; }
#cg_bm_tags input{ flex:1; padding:6px 8px; border:1px solid var(--bm-border); border-radius:8px; background:transparent; color:inherit; }
#cg_bm_list{ flex:1; overflow:auto; padding:10px; }
.bm-item{ border:1px solid var(--bm-border); border-radius:10px; padding:8px; margin-bottom:8px; }
.bm-item .meta{ font-size:12px; color:var(--bm-muted); display:flex; gap:8px; flex-wrap:wrap; }
.bm-item .title{ font-weight:600; margin-bottom:4px; }
.bm-item .actions{ display:flex; gap:8px; margin-top:6px; }
.bm-item .preview{ margin-top:6px; font-size:13px; line-height:1.4; white-space:pre-wrap; }
.cg-chip{ display:inline-block; font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid var(--bm-border); margin-right:6px; }</style><script>(function(){'use strict'; if(window.__CG_BM_160__) return; window.__CG_BM_160__=true;
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const KEY='cg_bm_store_v1';
function load(){ try{ const raw=localStorage.getItem(KEY); if(raw){ const o=JSON.parse(raw); if(o&&o.bookmarks&&o.tags) return o; } }catch(e){} const def={id:'tag-default',name:'默认',name_lower:'默认',color:'#f59e0b',created_at:Date.now(),updated_at:Date.now()}; const store={tags:[def],bookmarks:[]}; try{ localStorage.setItem(KEY, JSON.stringify(store)); }catch(e){} return store; }
function save(s){ try{ localStorage.setItem(KEY, JSON.stringify(s)); } catch(e){} STORE = s; if(window.__BUS__){ try{ window.__BUS__.emit('bm:changed',{op:'save'}); }catch(e){} } }
let STORE = load();
function getTagById(id){ return STORE.tags.find(t=>t.id===id); }
function getOrCreateTag(name){ const low=(name||'').trim().toLowerCase(); if(!low) return getTagById('tag-default'); let t=STORE.tags.find(x=>x.name_lower===low);
  if(!t){ t={id:'tag-'+Math.random().toString(36).slice(2,9),name:name.trim(),name_lower:low,created_at:Date.now(),updated_at:Date.now()}; STORE.tags.push(t); save(STORE); }
  return t; }
function activeConvId(){ const it=$('.conv-item.active'); if(it) return (it.dataset.id || it.getAttribute('data-id') || it.id || ''); const first=$('.conv-item'); return first?(first.dataset.id||first.id||''):''; }
function convTitleById(id){ const it=id && $(`.conv-item[data-id="${id}"], .conv-item[id="${id}"]`); if(!it) return ''; const t=it.querySelector('.title')||it; return (t.textContent||'').trim(); }
function messageIndexify(container){ const list=$$('.msg', container); list.forEach((n,i)=>{ if(!n.dataset.cgMid) n.dataset.cgMid=String(i+1); }); return list.length; }
function textPreview(node, limit=140){ const txt=(node.textContent||'').replace(/\s+/g,' ').trim(); return txt.slice(0,limit); }
function isBookmarked(convId, mid){ return STORE.bookmarks.some(b=> b.conv_id===convId && b.msg_id_start===mid && b.msg_id_end===mid); }
function markStarVisual(node, on){ let star=node.querySelector('.cg-bm-star'); if(!star){ star=document.createElement('div'); star.className='cg-bm-star'; star.title='添加书签'; star.textContent='★'; node.appendChild(star); } star.classList.toggle('active', !!on); return star; }
function flash(node){ node.classList.add('cg-bm-flash'); setTimeout(()=> node.classList.remove('cg-bm-flash'), 1200); }
function ensureDrawer(){
  if($('#cg_bm_drawer')) return;
  const header=$('header')||document.body;
  const btn=document.createElement('button'); btn.id='cg_bm_toggle'; btn.className='btn'; btn.textContent='书签'; header && header.appendChild(btn);
  const wrap=document.createElement('div'); wrap.id='cg_bm_drawer'; wrap.innerHTML=`
    <div id="cg_bm_head"><div class="title">书签</div><div class="actions"><button id="cg_bm_export" class="btn">导出</button><button id="cg_bm_close" class="btn">关闭</button></div></div>
    <div id="cg_bm_body"><div id="cg_bm_tags"></div><div id="cg_bm_list"></div></div>`;
  document.body.appendChild(wrap);

  /* v2.9.29: bookmark title rename (dblclick / double-tap) */
  try{
    const list = wrap.querySelector('#cg_bm_list');
    if(list && !list.__renameBound){
      list.__renameBound = true;
      function __startRename(titleEl){
        try{
          const item = titleEl.closest('.bm-item'); if(!item) return;
          const id = item.dataset.id; const bm = STORE.bookmarks.find(x=> x.id===id); if(!bm) return;
          const old = (bm.title || titleEl.textContent || '').trim();
          if(titleEl.__editing) return;
          titleEl.__editing = true;
          const inp = document.createElement('input');
          inp.type = 'text';
          inp.value = old;
          inp.className = 'bm-rename-input';
          inp.setAttribute('aria-label','重命名书签标题');
          inp.style.width = '100%';
          inp.style.boxSizing = 'border-box';
          inp.style.font = 'inherit';
          inp.style.padding = '2px 6px';
          inp.style.border = '1px solid var(--bm-border, #dfe3ea)';
          inp.style.borderRadius = '6px';
          titleEl.innerHTML = '';
          titleEl.appendChild(inp);
          setTimeout(function(){ try{ inp.focus(); inp.select(); }catch(_e){} }, 0);
          function finish(commit){
            try{
              titleEl.__editing = false;
              const val = (inp.value||'').trim();
              if(commit && val && val !== old){
                bm.title = val;
                save(STORE);
              }
            }catch(_e){}
            try{ renderList(); }catch(_e){}
          }
          inp.addEventListener('keydown', function(ev){
            if(ev.key === 'Enter'){ ev.preventDefault(); finish(true); }
            if(ev.key === 'Escape'){ ev.preventDefault(); finish(false); }
          });
          inp.addEventListener('blur', function(){ finish(true); });
        }catch(_e){}
      }
      list.addEventListener('dblclick', function(ev){
        var el = ev.target;
        var titleEl = (el && el.classList && el.classList.contains('title')) ? el : (el && el.closest && el.closest('.bm-item .title'));
        if(titleEl){ ev.preventDefault(); __startRename(titleEl); }
      }, true);
      // mobile: double-tap detection
      (function(){
        var last = 0, lastEl = null;
        list.addEventListener('touchend', function(ev){
          try{
            var el = ev.target;
            var titleEl = (el && el.classList && el.classList.contains('title')) ? el : (el && el.closest && el.closest('.bm-item .title'));
            if(!titleEl) return;
            var now = Date.now();
            if(lastEl === titleEl && (now - last) < 350){
              ev.preventDefault();
              __startRename(titleEl);
              last = 0; lastEl = null;
            }else{
              last = now; lastEl = titleEl;
            }
          }catch(_e){}
        }, {passive:false});
      })();
    }
  }catch(_e){}

  btn.addEventListener('click', ()=> wrap.classList.add('open'));
  $('#cg_bm_close').addEventListener('click', ()=> wrap.classList.remove('open'));
  $('#cg_bm_export').addEventListener('click', exportAll);
  renderTags(); renderList(); if(window.__BUS__){ try{ window.__BUS__.on('bm:changed', ()=>{ try{ renderTags(); renderList(); enhanceCurrent && enhanceCurrent(); }catch(e){} }); window.__BUS__.on('tag:changed', ()=>{ try{ renderTags(); renderList(); }catch(e){} }); }catch(e){} }}
function renderTags(activeId){ try{ STORE = load(); }catch(e){} 
  const box=$('#cg_bm_tags'); if(!box) return;
  const inputId='cg_bm_tag_input';
  let html=`<div class="tag ${!activeId?'active':''}" data-id="__all__">全部</div>`;
  STORE.tags.forEach(t=>{ html+=`<div class="tag ${activeId===t.id?'active':''}" data-id="${t.id}"><span>${t.name}</span><span class="count">${STORE.bookmarks.filter(b=>b.tags.includes(t.id)).length}</span></div>`; });
  html+=`<div class="add"><input id="${inputId}" placeholder="新建模块…" /><button id="cg_bm_add_tag" class="btn">添加</button></div>`;
  box.innerHTML=html;
  $$('.tag', box).forEach(el=> el.addEventListener('click', ()=>{ $$('.tag', box).forEach(n=> n.classList.remove('active')); el.classList.add('active'); renderList(el.dataset.id); }));
  $('#cg_bm_add_tag')?.addEventListener('click', ()=>{ const val=$('#'+inputId).value.trim(); if(!val) return; getOrCreateTag(val); save(STORE); renderTags(activeId); renderList(activeId); });
}
function renderList(tagId){ try{ STORE = load(); }catch(e){} 
  const box=$('#cg_bm_list'); if(!box) return;
  let list=STORE.bookmarks.slice().sort((a,b)=> b.created_at - a.created_at);
  if(tagId && tagId!=='__all__'){ list=list.filter(bm=> bm.tags.includes(tagId)); }
  const fmt=ts=> new Date(ts).toLocaleString();
  box.innerHTML = list.map(bm=>{
    const tnames=bm.tags.map(id=> (getTagById(id)?.name||''));
    const chips=tnames.map(n=> `<span class="cg-chip">${n}</span>`).join('');
    const convTitle=bm.conv_title||'';
    return `<div class="bm-item" data-id="${bm.id}">
      <div class="title">${bm.title||'(无标题)'}</div>
      <div class="meta"><span>${convTitle}</span><span>${fmt(bm.created_at)}</span>${chips}</div>
      <div class="preview">${(bm.preview||'').replace(/[&<>]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))}</div>
      <div class="actions"><button class="cg-bm-btn" data-act="jump">跳转</button><button class="cg-bm-btn" data-act="del">删除</button></div>
    </div>`;
  }).join('') || `<div style="color:var(--bm-muted);">暂无书签</div>`;
  $$('.bm-item .cg-bm-btn', box).forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const item = btn.closest('.bm-item'); if(!item) return;
      const id = item.dataset.id; const bm = STORE.bookmarks.find(x=> x.id===id); if(!bm) return;
      const act = btn.dataset.act;
      if(act==='jump'){
        try{ jumpToBookmark(bm); }catch(e){}
        try{ const d = document.getElementById('cg_bm_drawer'); if(d) d.classList.remove('open'); }catch(e){}
        return;
      }
      if(act==='del'){
        try{
          STORE.bookmarks = STORE.bookmarks.filter(x=> x.id!==id);
          save(STORE);
          renderList();
          try{ window.__BUS__ && window.__BUS__.emit('bm:changed', {op:'del', id:id}); }catch(e){}
          if(window.toast){ try{ toast('已删除书签'); }catch(e){} }
        }catch(e){}
        return;
      }
});
  });
}
function exportAll(){ const payload={ version:(window.__BUILD_META__&&window.__BUILD_META__.version)||'V1.6', exportedAt:new Date().toISOString(), ...STORE };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json;charset=utf-8'}); const a=document.createElement('a'); a.download=`bookmarks_${Date.now()}.json`; a.href=URL.createObjectURL(blob); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500); }
function openPopover(star, ctx){
  closePopover();
  const pop=document.createElement('div'); pop.className='cg-bm-pop';
  const options=STORE.tags.map(t=> `<option value="${t.id}">${t.name}</option>`).join('');
  const defTitle=(ctx.preview||'').slice(0,30);
  pop.innerHTML=`<h4>添加到书签</h4>
    <div class="row"><input type="text" id="bm_title" placeholder="标题" value="${defTitle.replace(/"/g,'&quot;')}" /></div>
    <div class="row"><select id="bm_tag">${options}</select></div>
    <div class="actions"><button class="cg-bm-btn" data-act="cancel">取消</button><button class="cg-bm-btn primary" data-act="save">保存</button></div>`;
  star.parentElement.appendChild(pop);
  pop.querySelector('[data-act="cancel"]').addEventListener('click', closePopover);
  pop.querySelector('[data-act="save"]').addEventListener('click', ()=>{
    const title=pop.querySelector('#bm_title').value.trim();
    const tagId=pop.querySelector('#bm_tag').value;
    createBookmark({...ctx, title, tags:[tagId]}); closePopover();
  });
}
function closePopover(){ $$('.cg-bm-pop').forEach(n=> n.remove()); }
function createBookmark(ctx){
  const bm={ id:'bm-'+Math.random().toString(36).slice(2,9), conv_id:ctx.conv_id, conv_title:ctx.conv_title||'', msg_id_start:ctx.mid, msg_id_end:ctx.mid, title:ctx.title||ctx.preview.slice(0,30), note:'', tags:ctx.tags||['tag-default'], preview:ctx.preview||'', created_at:Date.now(), updated_at:Date.now() };
  STORE.bookmarks.unshift(bm); save(STORE); renderTags(); renderList();
   if(window.__BUS__){try{window.__BUS__.emit('bm:changed',{op:'add',id:bm.id});}catch(e){}} if(window.toast){toast('书签已添加');}const msg=document.querySelector(`.msg[data-cg-mid="${ctx.mid}"]`); if(msg){ let st=msg.querySelector('.cg-bm-star'); if(st) st.classList.add('active'); }
}
function jumpToBookmark(bm){
  const convId=bm.conv_id; let item=convId && document.querySelector(`.conv-item[data-id="${convId}"], .conv-item[id="${convId}"]`); if(item){ item.click(); }
  let tries=0; const timer=setInterval(()=>{ tries++; const msg=document.querySelector(`.msg[data-cg-mid="${bm.msg_id_start}"]`);
    if(msg){ clearInterval(timer); msg.scrollIntoView({behavior:'smooth', block:'center'}); msg.classList.add('cg-bm-flash'); setTimeout(()=> msg.classList.remove('cg-bm-flash'), 1200); }
    if(tries>40) clearInterval(timer);
  },80);
  $('#cg_bm_drawer')?.classList.remove('open');
}
function enhanceCurrent(){ try{ STORE = load(); }catch(e){} 
  const cont = $('#chat, #conversation, .chat, .conversation, #main, main') || document;
  messageIndexify(cont);
  const convId=activeConvId(); const convTitle=convTitleById(convId);
  $$('.msg', cont).forEach(node=>{
    const mid=node.dataset.cgMid||''; const starred=isBookmarked(convId, mid);
    const star=markStarVisual(node, starred);
    if(!star.__bound__){
      star.__bound__=true;
      star.addEventListener('click', (e)=>{ e.stopPropagation(); const preview=textPreview(node); openPopover(star, {conv_id:convId, conv_title:convTitle, mid, preview, title:''}); });
    }
  });
}
ensureDrawer();
const _render=window.renderConversation;
if(typeof _render==='function'){ window.renderConversation=function(){ const r=_render.apply(this, arguments); try{ setTimeout(enhanceCurrent,0); }catch(e){} return r; }; }
else { document.addEventListener('DOMContentLoaded', function(){ setTimeout(enhanceCurrent,0); }); }
document.addEventListener('click', function(e){ const it=e.target.closest && e.target.closest('.conv-item'); if(it){ setTimeout(enhanceCurrent,50); } });
})();</script><style>/* === V1.6.2 Patch (add-only) === */
.msg .meta .cg-bm-star{ position:static; display:inline-block; width:auto; height:auto; line-height:1; margin-left:8px; font-size:14px; vertical-align:middle; }
.msg .meta .cg-bm-star:hover{ transform:scale(1.05); }
#cg_bm_tags .tag .trash{ opacity:.6; cursor:pointer; padding:0 4px; }
#cg_bm_tags .tag .trash:hover{ opacity:1; }</style><script>(function(){'use strict'; if(window.__CG_UX_162__) return; window.__CG_UX_162__=true;
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
(function bindEnterCreate(){
  function bind(){ const input=document.getElementById('cg_bm_tag_input'); const add=document.getElementById('cg_bm_add_tag'); if(input && !input.__enter__){ input.__enter__=true; input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); add && add.click(); } }); } }
  const mo=new MutationObserver(bind); mo.observe(document.body,{childList:true,subtree:true}); bind();
})();
(function tagDelete(){
  const KEY='cg_bm_store_v1';
  function load(){ try{ return JSON.parse(localStorage.getItem(KEY)) || {tags:[], bookmarks:[]}; }catch(e){ return {tags:[], bookmarks:[]}; }
}
  function save(v){ try{ localStorage.setItem(KEY, JSON.stringify(v)); }catch(e){} }
  function patch(){ const box=document.getElementById('cg_bm_tags'); if(!box) return;
    $$('#cg_bm_tags .tag').forEach(el=>{
      const id=el.dataset.id; if(!id || id==='__all__') return;
      if(!el.querySelector('.trash')){
        const t=document.createElement('span'); t.className='trash'; t.title='删除模块及其书签'; t.textContent='×'; el.appendChild(t);
        t.addEventListener('click',(ev)=>{
          ev.stopPropagation();
          const store=load(); const tag=store.tags.find(x=>x.id===id); if(!tag) return;
          if(!confirm(`确认删除模块「${tag.name}」及其书签？此操作不可撤销。`)) return;
          store.bookmarks = store.bookmarks.filter(bm => !(Array.isArray(bm.tags) && bm.tags.includes(id)));
          store.tags = store.tags.filter(x=> x.id!==id);
          save(store);
          const all = box.querySelector('.tag[data-id="__all__"]'); if(all) all.click();
         if(window.__BUS__){ try{ window.__BUS__.emit('tag:changed',{id:id}); window.__BUS__.emit('bm:changed',{op:'bulk-remove', tagId:id}); }catch(e){} } if(window.toast){ toast('已删除模块及其书签'); } });
      }
    });
  }
  const mo=new MutationObserver(patch); mo.observe(document.body,{childList:true,subtree:true}); patch();
})();
(function starInline(){
  function move(){ $$('.msg').forEach(msg=>{ const star=msg.querySelector('.cg-bm-star'); if(!star) return; const meta=msg.querySelector('.meta'); if(meta && star.parentElement!==meta){ meta.appendChild(star);} }); }
  const mo=new MutationObserver(move); mo.observe(document.body,{childList:true,subtree:true}); move();
})();})();</script><style>/* === V1.7.0 Notebooks (drawer + batch select) === */
:root{ --nb-accent:#0ea5e9; --nb-muted:#64748b; --nb-border:#e5e7eb; --nb-bg:#ffffff; }
[data-theme="dark"] :root, [data-theme="dark"]{ --nb-accent:#38bdf8; --nb-muted:#94a3b8; --nb-border:#334155; --nb-bg:#0b1220; }
#cg_nb_toggle, #cg_select_toggle{ margin-left:8px; }
#cg_nb_drawer{ position:fixed; top:0; right:0; bottom:0; width:520px; transform:translateX(100%); background:var(--nb-bg); border-left:1px solid var(--nb-border); box-shadow:-8px 0 24px rgba(0,0,0,.08); z-index:1000; display:flex; flex-direction:column; transition: transform .18s ease; font-size:14px; }
#cg_nb_drawer.open{ transform:translateX(0); }
#cg_nb_head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--nb-border); }
#cg_nb_head .title{ font-weight:600; }
#cg_nb_body{ display:grid; grid-template-columns: 160px 160px 1fr; min-height:0; flex:1; }
#cg_nb_list, #cg_page_list{ border-right:1px solid var(--nb-border); padding:10px; overflow:auto; }
#cg_nb_list .nb, #cg_page_list .pg{ border-radius:8px; padding:6px 8px; cursor:pointer; margin-bottom:6px; }
#cg_nb_list .nb.active, #cg_page_list .pg.active{ background:rgba(14,165,233,.12); }
#cg_nb_list input, #cg_page_list input{ width:100%; padding:6px 8px; border:1px solid var(--nb-border); border-radius:8px; background:transparent; color:inherit; }
#cg_nb_list .add, #cg_page_list .add{ display:flex; gap:6px; margin-top:8px; }
#cg_nb_view{ overflow:auto; padding:10px; }
.nb-entry{ border:1px solid var(--nb-border); border-radius:10px; margin-bottom:10px; overflow:hidden; }
.nb-entry .nb-entry-head{ display:flex; align-items:center; justify-content:space-between; background:rgba(148,163,184,.12); padding:6px 8px; font-size:12px; color:var(--nb-muted); }
.nb-entry .nb-entry-body{ padding:8px; }
.nb-msg{ border-radius:12px; padding:8px 10px; margin:6px 0; background:#f8fafc; }
[data-theme="dark"] .nb-msg{ background:#0f172a; }
.nb-msg .meta{ font-size:12px; color:var(--nb-muted); margin-bottom:4px; }
.nb-anno{ border-left:3px solid var(--nb-accent); background:rgba(14,165,233,.08); padding:8px 10px; border-radius:10px; margin:8px 0; }
.nb-anno .meta{ font-size:12px; color:var(--nb-muted); margin-bottom:4px; }
.nb-anno textarea{ width:100%; min-height:60px; padding:6px 8px; border:1px solid var(--nb-border); border-radius:8px; background:transparent; color:inherit; }
#cg_batch_bar{ position:fixed; left:50%; transform:translateX(-50%); bottom:18px; z-index:999; background:var(--nb-bg); border:1px solid var(--nb-border); border-radius:999px; padding:8px 12px; box-shadow:0 8px 24px rgba(0,0,0,.08); display:none; align-items:center; gap:10px; }
#cg_batch_bar.show{ display:flex; }
#cg_batch_bar .count{ font-weight:600; }
.cg-check{ position:absolute; left:-24px; top:8px; }
.cg-btn{ padding:6px 10px; border-radius:8px; border:1px solid var(--nb-border); background:transparent; cursor:pointer; }
.cg-btn.primary{ border-color:var(--nb-accent); background:var(--nb-accent); color:#fff; }
.icon-btn{ padding:2px 6px; border-radius:6px; border:1px solid var(--nb-border); cursor:pointer; background:transparent; font-size:12px; }
.icon-btn:hover{ border-color:var(--nb-accent); }</style><script>(function(){'use strict'; if(window.__CG_NB_170__) return; window.__CG_NB_170__=true;
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const KEY='cg_nb_store_v1';
function load(){ try{ const raw=localStorage.getItem(KEY); if(raw) return JSON.parse(raw); }catch(e){} return {notebooks:[], pages:[], entries:[], page_entries:[], annotations:[]}; }
function save(v){ try{ localStorage.setItem(KEY, JSON.stringify(v)); }catch(e){} }
let NB=load();

  /* v2.9.20 sync patch — keep Drawer in sync with NB store */
  try{
    // Lightweight event bus polyfill if not present
    (function(){
      if(!window.__BUS__){
        const _hub = document.createElement('div');
        window.__BUS__ = {
          on: function(name, cb){ try{ _hub.addEventListener(name, function(ev){ try{ cb(ev.detail||{}); }catch(_e){} }); }catch(_e){} },
          emit: function(name, detail){ try{ _hub.dispatchEvent(new CustomEvent(name, {detail: detail||{}})); }catch(_e){} },
        };
      }
    })();
    // Reload NB and re-render active notebook/page when entries/pages change elsewhere
    window.__BUS__.on('nb:changed', function(detail){
      try{
        NB = load();
        // Which notebook/page should be active?
        var targetNb = detail && detail.nbId ? detail.nbId : (document.querySelector('#cg_nb_list .nb.active')?.dataset?.id || (NB.notebooks[0] && NB.notebooks[0].id) || null);
        var targetPg = detail && detail.pageId ? detail.pageId : (document.querySelector('#cg_nb_view')?.dataset?.pageId || document.querySelector('#cg_page_list .pg.active')?.dataset?.id || null);
        if(typeof renderNotebooks === 'function'){ renderNotebooks(targetNb); }
        if(targetNb && typeof renderPages === 'function'){ renderPages(targetNb, targetPg); }
        if(targetPg && typeof renderPage === 'function'){ renderPage(targetPg); }
      }catch(_e){}
    });
    
// v2.9.22: safety net — if still on mobile and not auto-reloaded, force a refresh
try{
  var already = (function(){ try{ return sessionStorage.getItem('cg_nb_auto_refreshed')==='1'; }catch(_e){ return false; } })();
  var isMobile = (function(){ try{ return window.matchMedia('(max-width: 900px)').matches; }catch(_e){ return (window.innerWidth||1000) <= 900; } })();
  if(isMobile && !already){
    setTimeout(function(){
      try{ sessionStorage.setItem('cg_nb_auto_refreshed','1'); }catch(_e){}
      /* patched: no auto reload */ void 0;
    }, 120);
  }
}catch(_e){} 
// Also refresh in case another tab modifies localStorage directly
    window.addEventListener('storage', function(e){ if(e && e.key === KEY){ try{ NB = load(); }catch(_e){} } });
  }catch(_e){}
function uid(p='id'){ return p+'-'+Math.random().toString(36).slice(2,9); }
function now(){ return Date.now(); }
function activeConvId(){ const it=$('.conv-item.active'); return it ? (it.dataset.id || it.getAttribute('data-id') || it.id || '') : ($('.conv-item')?.dataset?.id || ''); }
function convTitleById(id){ const it=id && $(`.conv-item[data-id="${id}"], .conv-item[id="${id}"]`); if(!it) return ''; const t=it.querySelector('.title')||it; return (t.textContent||'').trim(); }
function messageIndexify(container){ const list=$$('.msg', container); list.forEach((n,i)=>{ if(!n.dataset.cgMid) n.dataset.cgMid=String(i+1); }); return list.length; }

function ensureButtons(){
  const header=$('header')||document.body;
  if(!$('#cg_nb_toggle')){ const b=document.createElement('button'); b.id='cg_nb_toggle'; b.className='btn'; b.textContent='笔记本'; header.appendChild(b); b.addEventListener('click', ()=> $('#cg_nb_drawer').classList.add('open')); }
  if(!$('#cg_select_toggle')){ const s=document.createElement('button'); s.id='cg_select_toggle'; s.className='btn'; s.textContent='选择'; header.appendChild(s); s.addEventListener('click', toggleSelectMode); }
}

function ensureDrawer(){
  if($('#cg_nb_drawer')) return;
  const wrap=document.createElement('div'); wrap.id='cg_nb_drawer';
  wrap.innerHTML=`
    <div id="cg_nb_head">
      <div class="title">笔记本</div>
      <div class="actions">
        <button id="cg_nb_export_page" class="btn">导出当前页</button>
        <button id="cg_nb_close" class="btn">关闭</button>
      </div>
    </div>
    <div id="cg_nb_body">
      <div id="cg_nb_list"></div>
      <div id="cg_page_list"></div>
      <div id="cg_nb_view"></div>
    </div>`;
  document.body.appendChild(wrap);
  $('#cg_nb_close').addEventListener('click', ()=> wrap.classList.remove('open'));
  $('#cg_nb_export_page').addEventListener('click', exportCurrentPage);
  renderNotebooks();
}

function renderNotebooks(activeId){
  const box=$('#cg_nb_list'); if(!box) return;
  let html=''; NB.notebooks.forEach(nb=>{ html+=`<div class="nb ${activeId===nb.id?'active':''}" data-id="${nb.id}">${nb.name}</div>`; });
  html+=`<div class="add"><input id="cg_nb_new" placeholder="新建笔记本…" /><button id="cg_nb_add" class="cg-btn">添加</button></div>`;
  box.innerHTML=html;
  $$('.nb', box).forEach(el=> el.addEventListener('click', ()=>{ $$('.nb', box).forEach(n=> n.classList.remove('active')); el.classList.add('active'); renderPages(el.dataset.id); }));
  $('#cg_nb_add').addEventListener('click', ()=>{ const v=($('#cg_nb_new').value||'').trim(); if(!v) return; const nb={id:uid('nb'),name:v,created_at:now(),updated_at:now()}; NB.notebooks.push(nb); save(NB); renderNotebooks(nb.id); renderPages(nb.id); });
  const input=$('#cg_nb_new'); if(input && !input.__enter__){ input.__enter__=true; input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#cg_nb_add').click(); } }); }
  const first=activeId || (NB.notebooks[0]&&NB.notebooks[0].id);
  if(first) renderPages(first); else { $('#cg_page_list').innerHTML='<div style="padding:6px;color:var(--nb-muted);">请先新建笔记本</div>'; $('#cg_nb_view').innerHTML=''; }
}

function renderPages(nbId, activePgId){
  const box=$('#cg_page_list'); if(!box) return;
  const pages=NB.pages.filter(p=>p.notebook_id===nbId).sort((a,b)=>(a.order||0)-(b.order||0));
  let html=''; pages.forEach(pg=>{ html+=`<div class="pg ${activePgId===pg.id?'active':''}" data-id="${pg.id}">${pg.name}</div>`; });
  html+=`<div class="add"><input id="cg_pg_new" placeholder="新建页面…" /><button id="cg_pg_add" class="cg-btn">添加</button></div>`;
  box.innerHTML=html;
  $$('.pg', box).forEach(el=> el.addEventListener('click', ()=>{ $$('.pg', box).forEach(n=> n.classList.remove('active')); el.classList.add('active'); renderPage(el.dataset.id); }));
  $('#cg_pg_add').addEventListener('click', ()=>{ const v=($('#cg_pg_new').value||'').trim(); if(!v) return; const pg={id:uid('pg'), notebook_id:nbId, name:v, order:(NB.pages.filter(p=>p.notebook_id===nbId).length+1), created_at:now(),updated_at:now()}; NB.pages.push(pg); save(NB); renderPages(nbId, pg.id); renderPage(pg.id); });
  const input=$('#cg_pg_new'); if(input && !input.__enter__){ input.__enter__=true; input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#cg_pg_add').click(); } }); }
  const first=activePgId || (pages[0] && pages[0].id);
  if(first) renderPage(first); else $('#cg_nb_view').innerHTML='<div style="padding:6px;color:var(--nb-muted);">请新建页面并通过“选择→添加到笔记本”收集内容</div>';
  $$('.nb', $('#cg_nb_list')).forEach(n=> n.classList.toggle('active', n.dataset.id===nbId));
}

function renderPage(pgId){
  const view=$('#cg_nb_view'); if(!view) return;
  
  try{ view.dataset.pageId = pgId; }catch(_e){}  /* v2.9.20: mark active page */
const links=NB.page_entries.filter(x=>x.page_id===pgId).sort((a,b)=>(a.order||0)-(b.order||0));
  const entries=links.map(l=> NB.entries.find(e=>e.id===l.entry_id)).filter(Boolean);
  let html='';
  entries.forEach(en=>{
    const metaTitle=(en.meta&&en.meta.conv_title)?en.meta.conv_title:(en.conv_id||'');
    const cnt=(en.snapshot&&en.snapshot.messages)?en.snapshot.messages.length:(en.msg_ids?en.msg_ids.length:0);
    html+=`<div class="nb-entry" data-id="${en.id}">
      <div class="nb-entry-head">
        <div>${metaTitle} · ${cnt} 条消息</div>
        <div>
          <button class="icon-btn" data-act="add-anno">+ 注释</button>
          <button class="icon-btn" data-act="del-entry">删除</button>
        </div>
      </div>
      <div class="nb-entry-body">`;
    const msgs=(en.snapshot&&en.snapshot.messages)||[];
    msgs.forEach(m=>{
      html+=`<div class="nb-msg" data-mid="${m.mid||''}"><div class="meta">${m.author||''} · ${m.time||''}${m.model? ' · '+m.model : ''}${m.model? ' · '+m.model : ''}</div><div class="text">${(m.text||'').replace(/[&<>]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))}</div></div>`;
    });
    const annos=NB.annotations.filter(a=> a.entry_id===en.id && a.page_id===pgId);
    annos.forEach(a=>{ html+=`<div class="nb-anno" data-aid="${a.id}"><div class="meta">注释 · ${new Date(a.updated_at||a.created_at).toLocaleString()}<button class="icon-btn anno-x" data-act="del-anno" data-id="${a.id}" title="删除注释" style="float:right;opacity:.7;border:none;background:transparent;cursor:pointer;">×</button></div><div class="text">${(a.content_md||'').replace(/[&<>]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))}</div></div>`; });
    html+=`</div></div>`;
  });
  if(!html) html='<div style="padding:6px;color:var(--nb-muted);">此页面暂无内容。去主视窗点击“选择”，勾选消息后“添加到笔记本”。</div>';
  view.innerHTML=html;
  $$('.nb-entry .icon-btn', view).forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const entryEl=btn.closest('.nb-entry'); const entryId=entryEl?.dataset.id; if(!entryId) return;
      if(btn.dataset.act==='del-entry'){ NB.page_entries=NB.page_entries.filter(pe=> !(pe.page_id===pgId && pe.entry_id===entryId)); save(NB); renderPage(pgId); }
      if(btn.dataset.act==='add-anno'){ openAnnoEditor(pgId, entryId); }
      if(btn.dataset.act==='del-anno'){
        const aid = btn.dataset.id || (btn.closest('.nb-anno')?.dataset.aid);
        if(aid && confirm('删除这条注释？')){
          NB.annotations = (NB.annotations||[]).filter(a=> String(a.id)!==String(aid));
          if(typeof save==='function') save(NB); else if(typeof nbSave==='function') nbSave(NB);
          renderPage(pgId);
        }
      }
    });
  });
  view.dataset.pageId=pgId;
}

function openAnnoEditor(pgId, entryId){
  const view = $('#cg_nb_view'); if(!view) return;

  // 找到当前对话组（entry）及其内容容器
  const entryEl = view.querySelector(`.nb-entry[data-id="${entryId}"]`);
  const host = entryEl?.querySelector('.nb-entry-body') || entryEl || view;

  // 构建编辑框（用 class 而不是 id，避免重复）
  const box = document.createElement('div');
  box.className = 'nb-anno nb-anno--editing';
  box.innerHTML =
    '<div class="meta">新增注释</div>' +
    '<textarea class="cg-anno-txt" placeholder="写点什么…"></textarea>' +
    '<div style="margin-top:6px;display:flex;gap:8px;">' +
      '<button class="cg-btn cg-anno-cancel">取消</button>' +
      '<button class="cg-btn primary cg-anno-save">保存</button>' +
    '</div>';

  // 关键：插入到该 entry 的顶部
  host.prepend(box);

  // 事件监听限定在 box 内部，避免全局 id 冲突
  box.querySelector('.cg-anno-cancel').addEventListener('click', ()=> box.remove());
  box.querySelector('.cg-anno-save').addEventListener('click', ()=>{
    const txt = (box.querySelector('.cg-anno-txt').value || '').trim();
    if(!txt) return;
    const a = { id: uid('anno'), page_id: pgId, entry_id: entryId,
                anchor:{type:'after'}, content_md: txt, created_at: now(), updated_at: now() };
    NB.annotations.push(a);
    save(NB);
    renderPage(pgId);
  });
}

let SELECT_ON=false;
function toggleSelectMode(){
  SELECT_ON=!SELECT_ON;
  const btn=$('#cg_select_toggle'); if(btn) btn.textContent=SELECT_ON?'完成选择':'选择';
  const container=$('#chat, #conversation, .chat, .conversation, #main, main') || document;
  messageIndexify(container);
  const msgs=$$('.msg', container);
  msgs.forEach(node=>{ let ck=node.querySelector('.cg-check'); if(SELECT_ON){ if(!ck){ ck=document.createElement('input'); ck.type='checkbox'; ck.className='cg-check'; node.style.position='relative'; node.prepend(ck);} } else { if(ck) ck.remove(); } });
  updateBatchBar();
}
function getSelectedMids(){ const container=$('#chat, #conversation, .chat, .conversation, #main, main') || document; const selected=[]; $$('.msg', container).forEach(node=>{ const ck=node.querySelector('.cg-check'); if(ck && ck.checked) selected.push(node.dataset.cgMid); }); return selected; }
function ensureBatchBar(){ if($('#cg_batch_bar')) return; const bar=document.createElement('div'); bar.id='cg_batch_bar'; bar.innerHTML='<span>已选 <span class="count">0</span> 条</span><button id="cg_clear_sel" class="cg-btn">取消选择</button>'; document.body.appendChild(bar); $('#cg_add_to_nb').addEventListener('click', addSelectionToNotebook); (function(btn){ if(btn){ btn && btn.addEventListener('click', ()=>{ $$('.cg-check').forEach(c=> c.checked=false); updateBatchBar(); }); } })( (typeof bar!=='undefined' && bar.querySelector) ? bar.querySelector('#cg_clear_sel') : document.getElementById('cg_clear_sel') ); }
function updateBatchBar(){ ensureBatchBar(); const bar=$('#cg_batch_bar'); const count=getSelectedMids().length; $('.count', bar).textContent=String(count); bar.classList.toggle('show', SELECT_ON && count>0); }
document.addEventListener('change', (e)=>{ if(e.target && e.target.classList && e.target.classList.contains('cg-check')) updateBatchBar(); });

function addSelectionToNotebook(){ /* removed by request: quick add button */ }

function currentPageId(){ return $('#cg_nb_view')?.dataset?.pageId || null; }
function exportCurrentPage(){
  const pgId=currentPageId(); if(!pgId){ alert('请先选择页面'); return; }
  const nbId=($('#cg_nb_list .nb.active')||{}).dataset?.id; const nb=NB.notebooks.find(n=> n.id===nbId); const pg=NB.pages.find(p=> p.id===pgId);
  const links=NB.page_entries.filter(x=> x.page_id===pgId).sort((a,b)=>(a.order||0)-(b.order||0));
  const entries=links.map(l=> NB.entries.find(e=> e.id===l.entry_id)).filter(Boolean);
  const payload={ version:(window.__BUILD_META__&&window.__BUILD_META__.version)||'V1.7.0', notebook:nb, page:pg, entries, annotations:NB.annotations.filter(a=> a.page_id===pgId) };
  const blob=new Blob([JSON.stringify(payload,null,2)], {type:'application/json;charset=utf-8'});
  const a=document.createElement('a'); a.download=`notebook_${(nb?.name||'nb')}_${(pg?.name||'page')}.json`; a.href=URL.createObjectURL(blob); a.click(); setTimeout(()=> URL.revokeObjectURL(a.href), 1500);
}

function boot(){ ensureButtons(); ensureDrawer(); }
if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot); else boot();
})();</script><style>:root{ --cg-tab-bg: rgba(148,163,184,.12); --cg-tab-br: #e5e7eb; --cg-tab-tx: #334155; }
[data-theme="dark"] :root, [data-theme="dark"]{ --cg-tab-bg: rgba(148,163,184,.12); --cg-tab-br: #334155; --cg-tab-tx: #cbd5e1; }
#cg_view_tabs{ display:flex; gap:8px; align-items:center; background: var(--cg-tab-bg); border:1px solid var(--cg-tab-br); border-radius:999px; padding:4px; margin-left:8px; }
#cg_view_tabs .tab{ padding:6px 12px; border-radius:999px; cursor:pointer; user-select:none; color: var(--cg-tab-tx); }
#cg_view_tabs .tab.active{ background: #0ea5e9; color:#fff; }
.cg-hide{ display:none !important; }
#cg_nb_full, #cg_bm_full{ position:relative; display:none; }
#cg_nb_full.open, #cg_bm_full.open{ display:block; }
#cg_nb_full .nb-grid{ display:grid; grid-template-columns: 260px 220px 1fr; gap:0; height: calc(100vh - 80px); border-top:1px solid var(--cg-tab-br); }
#cg_nb_full .nb-left, #cg_nb_full .nb-mid, #cg_nb_full .nb-right{ overflow:auto; padding:10px; border-right:1px solid var(--cg-tab-br); }
#cg_nb_full .nb-right{ border-right:none; }
#cg_bm_full .bm-grid{ display:grid; grid-template-columns: 220px 1fr; height: calc(100vh - 80px); border-top:1px solid var(--cg-tab-br); }
#cg_bm_full .bm-left, #cg_bm_full .bm-right{ overflow:auto; padding:10px; border-right:1px solid var(--cg-tab-br); }
#cg_bm_full .bm-right{ border-right:none; }
#cg_bm_full .bm-item{ border:1px solid var(--cg-tab-br); border-radius:10px; padding:8px; }
.cg-view-bar{ display:flex; align-items:center; justify-content:space-between; padding:8px 6px; gap:8px; }
.cg-view-bar .title{ font-weight:600; }
.cg-view-bar .actions{ display:flex; gap:8px; }
header .cg-toolbar-wrap{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }</style><script>(function(){'use strict'; if(window.__CG_VIEWS_171__) return; window.__CG_VIEWS_171__=true;
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const LS_KEY='cg_view_mode_1';
function ensureTabs(){
  const header = $('header') || document.body;
  let wrap = header.querySelector('.cg-toolbar-wrap');
  if(!wrap){ wrap = document.createElement('div'); wrap.className='cg-toolbar-wrap'; if(header.firstElementChild) header.insertBefore(wrap, header.firstElementChild.nextSibling); else header.appendChild(wrap); }
  if(!$('#cg_view_tabs')){
    const tabs = document.createElement('div'); tabs.id='cg_view_tabs';
    tabs.innerHTML = `<div class="tab" data-mode="conversation">对话</div><div class="tab" data-mode="notebooks">笔记</div><div class="tab" data-mode="bookmarks">书签</div>`;
    wrap.prepend(tabs);
    $$('.tab', tabs).forEach(t=> t.addEventListener('click', ()=> setMode(t.dataset.mode)));
  }
}
function ensureFullViews(){
  if(!$('#cg_nb_full')){
    const nb = document.createElement('section'); nb.id='cg_nb_full';
    nb.innerHTML = `<div class="cg-view-bar"><div class="title">笔记</div><div class="actions"><button id="nbToggle_stage" class="btn mobile-only" aria-label="打开侧栏">☰</button><button id="nbToggle_full" class="btn mobile-only" aria-label="打开侧栏">☰</button><button id="cg_nb_full_export" class="btn">导出当前页</button></div></div>
      <div class="nb-grid"><div class="nb-left"><div class="title" style="margin:6px 0;">笔记本</div><div id="cg_nb_list_full"></div><div style="display:flex; gap:6px; margin-top:8px;"><input id="cg_nb_new_full" placeholder="新建笔记本…" style="flex:1"/><button id="cg_nb_add_full" class="btn">添加</button></div></div>
      <div class="nb-mid"><div class="title" style="margin:6px 0;">页面</div><div id="cg_page_list_full"></div><div style="display:flex; gap:6px; margin-top:8px;"><input id="cg_pg_new_full" placeholder="新建页面…" style="flex:1"/><button id="cg_pg_add_full" class="btn">添加</button></div></div>
      <div class="nb-right"><div class="title" style="margin:6px 0;">内容</div><div id="cg_nb_view_full"></div></div></div>`;
    document.body.appendChild(nb);
    $('#cg_nb_full_export')?.addEventListener('click', ()=> { if(typeof window.exportCurrentPage==='function'){ window.exportCurrentPage(); } else alert('导出功能需要加载笔记模块后可用'); });
  }
  if(!$('#cg_bm_full')){
    const bm = document.createElement('section'); bm.id='cg_bm_full';
    bm.innerHTML = `<div class="cg-view-bar"><div class="title">书签</div><div class="actions"><button id="cg_bm_full_export" class="btn">导出</button></div></div>
      <div class="bm-grid"><div class="bm-left"><div id="cg_bm_tags_full"></div><div style="display:flex; gap:6px; margin-top:8px;"><input id="cg_bm_tag_input_full" placeholder="新建模块…" style="flex:1"/><button id="cg_bm_add_tag_full" class="btn">添加</button></div></div><div class="bm-right"><div id="cg_bm_list_full"></div></div></div>`;
    document.body.appendChild(bm);
    $('#cg_bm_full_export')?.addEventListener('click', ()=> { if(typeof window.exportAll==='function'){ window.exportAll(); } else alert('请在抽屉打开时使用导出按钮'); });
  }
}
function setActiveTab(mode){ $$('#cg_view_tabs .tab').forEach(t=> t.classList.toggle('active', t.dataset.mode===mode)); }
function findConversationRoot(){ const cands = ['#conversation', '.conversation', '#chat', '.chat', '#main', 'main', '.main']; for(const s of cands){ const el=$(s); if(el && el.offsetParent!==null) return el; } return null; }
function setMode(mode){
  try{ localStorage.setItem(LS_KEY, mode); }catch(e){}
  setActiveTab(mode);
  const conv = findConversationRoot();
  const nb = $('#cg_nb_full'); const bm = $('#cg_bm_full');
  if(mode==='conversation'){ nb && nb.classList.remove('open'); bm && bm.classList.remove('open'); if(conv) conv.classList.remove('cg-hide'); $('#cg_nb_drawer')?.classList.remove('open'); $('#cg_bm_drawer')?.classList.remove('open'); }
  if(mode==='notebooks'){ ensureFullViews(); nb && nb.classList.add('open'); bm && bm.classList.remove('open'); if(conv) conv.classList.add('cg-hide'); }
  if(mode==='bookmarks'){ ensureFullViews(); bm && bm.classList.add('open'); nb && nb.classList.remove('open'); if(conv) conv.classList.add('cg-hide'); }
}
function boot(){ ensureTabs(); ensureFullViews(); const saved = (localStorage.getItem(LS_KEY) || 'conversation'); setMode(saved); }
if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot); else boot();
})();</script><style>#cg_nb_stage{ display:none; }
#cg_nb_stage.open{ display:block; }
#cg_nb_stage .nb-layout{ display:grid; grid-template-columns: 300px 1fr; gap:0; min-height: calc(100vh - 80px); border-top: 1px solid var(--cg-tab-br, #e5e7eb); }
#cg_nb_stage .nb-left{ border-right:1px solid var(--cg-tab-br, #e5e7eb); padding:10px; overflow:auto; }
#cg_nb_stage .nb-right{ padding:10px; overflow:auto; }
.nb-tree{ list-style:none; padding-left:0; margin:0; }
.nb-tree .nb-item{ margin-bottom:6px; border-radius:8px; padding:6px 8px; cursor:pointer; }
.nb-tree .nb-item.active{ background:rgba(14,165,233,.12); }
.nb-tree .nb-item .row{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
.nb-tree .pages{ list-style:none; margin:6px 0 10px 14px; padding-left:0; }
.nb-tree .page{ padding:4px 6px; border-radius:6px; cursor:pointer; margin:2px 0; }
.nb-tree .page.active{ background:rgba(14,165,233,.12); }
.nb-tree .mini{ display:flex; gap:6px; margin-top:8px; }
#cg_bm_full, #cg_nb_full, #cg_nb_drawer, #cg_nb_toggle { display:none !important; }</style><script>(function(){'use strict'; if(window.__CG_171A__) return; window.__CG_171A__=true;
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
function nbStore(){ try{ return JSON.parse(localStorage.getItem('cg_nb_store_v1')) || {notebooks:[], pages:[], entries:[], page_entries:[], annotations:[]}; }catch(e){ return {notebooks:[], pages:[], entries:[], page_entries:[], annotations:[]}; } }
function nbSave(v){ try{ localStorage.setItem('cg_nb_store_v1', JSON.stringify(v)); }catch(e){} try{ if(window.__BUS__) window.__BUS__.emit('nb:changed',{op:'save'}); }catch(e){} }
function uid(p='id'){ return p+'-'+Math.random().toString(36).slice(2,9); }
function now(){ return Date.now(); }
function ensureTabs171a(){
  const header = $('header') || document.body;
  let tabs = $('#cg_view_tabs'); if(tabs){ tabs.remove(); }
  let wrap = header.querySelector('.cg-toolbar-wrap');
  if(!wrap){ wrap = document.createElement('div'); wrap.className='cg-toolbar-wrap'; if(header.firstElementChild) header.insertBefore(wrap, header.firstElementChild.nextSibling); else header.appendChild(wrap); }
  tabs = document.createElement('div'); tabs.id='cg_view_tabs';
  tabs.innerHTML = `<div class="tab active" data-mode="conversation">对话</div><div class="tab" data-mode="notebooks">笔记</div>`;
  wrap.prepend(tabs);
  $$('.tab', tabs).forEach(t=> t.addEventListener('click', ()=> switchMode(t.dataset.mode)));
}
function ensureNbStage(){
  if($('#cg_nb_stage')) return;
  const stage = document.createElement('section'); stage.id='cg_nb_stage';
  stage.innerHTML = `<div class="cg-view-bar"><div class="title">笔记</div><div class="actions"><button id="cg_nb_stage_export" class="btn">导出当前页</button></div></div>
    <div class="nb-layout"><div class="nb-left">
    <div style="font-weight:600;margin-bottom:6px;">笔记本</div>
    <div class="mini"><input id="cg_nb_new_stage" placeholder="新建笔记本…" style="flex:1"/><button id="cg_nb_add_stage" class="btn">添加</button></div>
    <ul id="cg_nb_tree" class="nb-tree" style="margin-top:10px;"></ul>
    </div><div class="nb-right"><div id="cg_nb_canvas"></div></div></div>`;
  document.body.appendChild(stage);
  $('#cg_nb_add_stage')?.addEventListener('click', ()=>{ const input=$('#cg_nb_new_stage'); const val=(input.value||'').trim(); if(!val) return; const cur=nbStore(); const nb={id:uid('nb'), name:val, created_at:now(), updated_at:now()}; cur.notebooks.push(nb); nbSave(cur); input.value=''; renderNbTree(nb.id); });
  $('#cg_nb_new_stage')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#cg_nb_add_stage').click(); } });
  renderNbTree();
}
function renderNbTree(activeNbId, activePgId){
  
const NB = (function(){
  try{ if(typeof nbStore==='function') return nbStore(); }catch(_){}
  try{ if(typeof window!=='undefined' && typeof window.nbStore==='function') return window.nbStore(); }catch(_){}
  try{ if(typeof window!=='undefined' && window.NB) return window.NB; }catch(_){}
  try{ const raw = localStorage.getItem('cg_nb_store_v1') || '{}'; return JSON.parse(raw); }catch(_){}
  return {};
})();

  const tree = $('#cg_nb_tree'); if(!tree) return;
  let html='';
  NB.notebooks.forEach(nb=>{
    const pages = NB.pages.filter(p=> p.notebook_id===nb.id).sort((a,b)=> (a.order||0)-(b.order||0));
    html += `<li class="nb-item ${activeNbId===nb.id?'active':''}" data-nbid="${nb.id}">
      <div class="row"><span class="name">${nb.name}</span><span class="ops"><button class="icon-btn" data-act="add-page">+ 页</button></span></div>
      <ul class="pages">`;
    pages.forEach(pg=>{ html += `<li class="page ${activePgId===pg.id?'active':''}" data-pgid="${pg.id}">${pg.name}</li>`; });
    html += `</ul></li>`;
  });
  tree.innerHTML = html;
  // V1.8.6: inline rename (dblclick name to edit; Enter/blur save; Esc cancel)
  (function(){
    const UI = (window.__NB_UI__ = window.__NB_UI__ || {selected:new Set(), fold:{}, editing:null});

    function escHtml(s){ return String(s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    function commitRename(val){
      if(!UI.editing) return;
      const v = String(val||'').trim();
      const tree = $('#cg_nb_tree');
      if(!v){
        if(window.toast) toast('名称不能为空');
        // refocus input to keep editing
        requestAnimationFrame(()=>{
          const sel = UI.editing.type==='nb' ? `.nb-item[data-nbid="${UI.editing.id}"] .name input.rename-input`
                                             : `.page[data-pgid="${UI.editing.id}"] .pg-name input.rename-input`;
          const inp = tree && tree.querySelector(sel);
          if(inp){ inp.focus(); inp.select(); }
        });
        return;
      }
      
const NB = (function(){
  try{ if(typeof nbStore==='function') return nbStore(); }catch(_){}
  try{ if(typeof window!=='undefined' && typeof window.nbStore==='function') return window.nbStore(); }catch(_){}
  try{ if(typeof window!=='undefined' && window.NB) return window.NB; }catch(_){}
  try{ const raw = localStorage.getItem('cg_nb_store_v1') || '{}'; return JSON.parse(raw); }catch(_){}
  return {};
})();

      if(UI.editing.type==='nb'){
        const t = (NB.notebooks||[]).find(n=> n.id===UI.editing.id);
        if(t) t.name = v;
      }else{
        const t = (NB.pages||[]).find(p=> p.id===UI.editing.id);
        if(t) t.name = v;
      }
      nbSave(NB);
      try{ window.__BUS__ && __BUS__.emit('nb:changed', {op: UI.editing.type==='nb'?'rename-nb':'rename-page', id:UI.editing.id, name:v}); }catch(e){}
      UI.editing = null;
      renderNbTree();
    }
    window.__commitRename = commitRename;
    function cancelRename(){ UI.editing = null; renderNbTree(); }
    window.__cancelRename = cancelRename;

    // Install dblclick to enter rename (delegate, bind once)
    const tree = $('#cg_nb_tree');
    if(tree && !tree.__renameBound){
      
      tree.addEventListener('dblclick', (e)=>{
        const nameEl = e.target.closest('.nb-item .name, .page .pg-name, li.page');
        if(!nameEl) return;
        // prevent folding click & blank dblclick handler
        e.stopPropagation();
        const pg = nameEl.closest('.page');
        if(pg){
          UI.editing = { type:'pg', id: pg.dataset.pgid, original: (nameEl.textContent||'').trim() };
        }else{
          const nb = nameEl.closest('.nb-item');
          if(nb){
            UI.editing = { type:'nb', id: nb.dataset.nbid, original: (nameEl.textContent||'').trim() };
          }else{
            return;
          }
        }
        renderNbTree();
      });

      tree.__renameBound = true;
    }

    
    // Render input when editing (defer to next frame so that augmentation finished)
    if(UI.editing){
      requestAnimationFrame(()=>{
        const tree = $('#cg_nb_tree');
        const selWrap = UI.editing.type==='nb' ? `.nb-item[data-nbid="${UI.editing.id}"] .name`
                                               : `.page[data-pgid="${UI.editing.id}"] .pg-name`;
        let host = tree && tree.querySelector(selWrap);
        // Fallback: if pg-name not present yet, try again on next frame once
        if(!host && UI.editing.type==='pg'){
          const li = tree && tree.querySelector(`.page[data-pgid="${UI.editing.id}"]`);
          if(li && !li.querySelector('.pg-name')){
            const span = document.createElement('span');
            span.className = 'pg-name';
            span.textContent = (li.textContent||'').trim();
            li.innerHTML = '';
            li.appendChild(span);
            host = span;
          }
        }
        if(host){
          const val = escHtml(UI.editing.original);
          host.innerHTML = `<input class="rename-input" type="text" maxlength="80" value="${val}" />`;
          const inp = host.querySelector('input.rename-input');
          inp.focus(); inp.select();
          inp.addEventListener('keydown', (ev)=>{
            if(ev.key==='Enter'){ ev.preventDefault(); window.__commitRename(inp.value); }
            else if(ev.key==='Escape'){ ev.preventDefault(); window.__cancelRename(); }
          });
          inp.addEventListener('blur', ()=> window.__commitRename(inp.value));
        }else{
          // host missing, keep editing for another frame
          requestAnimationFrame(()=>{
            const tree2 = $('#cg_nb_tree');
            const host2 = tree2 && tree2.querySelector(selWrap);
            if(host2){
              const val = escHtml(UI.editing.original);
              host2.innerHTML = `<input class="rename-input" type="text" maxlength="80" value="${val}" />`;
              const inp2 = host2.querySelector('input.rename-input');
              inp2.focus(); inp2.select();
              inp2.addEventListener('keydown', (ev)=>{
                if(ev.key==='Enter'){ ev.preventDefault(); window.__commitRename(inp2.value); }
                else if(ev.key==='Escape'){ ev.preventDefault(); window.__cancelRename(); }
              });
              inp2.addEventListener('blur', ()=> window.__commitRename(inp2.value));
            }else{
              // still not found; cancel to avoid lock
              UI.editing = null;
            }
          });
        }
      });
    }

  })();;

  // V1.8.6: notebook folding (click row to toggle, dblclick blank to expand all)
  (function(){
    const UI = (window.__NB_UI__ = window.__NB_UI__ || {selected:new Set(), fold:{}, editing:null});
    // Apply per-notebook visibility
    $$('.nb-item', tree).forEach(li=>{
      const nbId = li.dataset.nbid;
      const pages = li.querySelector('ul.pages');
      const expanded = (UI.fold && Object.prototype.hasOwnProperty.call(UI.fold, nbId)) ? !!UI.fold[nbId] : true;
      if(pages) pages.style.display = expanded ? '' : 'none';
    });

    // Bind once: delegate click on notebook row
    if(!tree.__foldBound){
      tree.addEventListener('click', (e)=>{
        const UI = window.__NB_UI__ || {}; if(UI.editing) return; if(e.detail && e.detail>1) return; const row = e.target.closest('.nb-item .row');
        // v2.9.6: ignore '=' directory button clicks
        if(e.target.closest('.dir-btn')) return;

        if(!row || !tree.contains(row)) return;
        // ignore when clicking on checkbox or +页按钮
        if(e.target.closest('input[type="checkbox"]')) return;
        if(e.target.closest('[data-act="add-page"]')) return;
        const li = row.closest('.nb-item'); if(!li) return;
        const nbId = li.dataset.nbid;
        const cur = (UI.fold && Object.prototype.hasOwnProperty.call(UI.fold, nbId)) ? !!UI.fold[nbId] : true;
        UI.fold[nbId] = !cur;
        renderNbTree();
      });
      tree.__foldBound = true;
    }

    // Dblclick blank area to expand all notebooks
    const left = $('#cg_nb_stage .nb-left') || tree.parentElement;
    if(left && !left.__dblAllBound){
      left.addEventListener('dblclick', (e)=>{
        // if dbl on any notebook/page row, ignore (only blank area triggers)
        if(e.target.closest('.nb-item') || e.target.closest('.page')) return;
        
const NB = (function(){
  try{ if(typeof nbStore==='function') return nbStore(); }catch(_){}
  try{ if(typeof window!=='undefined' && typeof window.nbStore==='function') return window.nbStore(); }catch(_){}
  try{ if(typeof window!=='undefined' && window.NB) return window.NB; }catch(_){}
  try{ const raw = localStorage.getItem('cg_nb_store_v1') || '{}'; return JSON.parse(raw); }catch(_){}
  return {};
})();

        const ids = (NB.notebooks||[]).map(n=>n.id);
        let allExpanded = true;
        ids.forEach(id=>{ if(UI.fold && Object.prototype.hasOwnProperty.call(UI.fold,id) && UI.fold[id]===false){ allExpanded=false; }});
// v2.9.21: if drawer is open on mobile, keep it open and ensure header is interactive
try{
  var isOpen = document.body && document.body.getAttribute('data-nbdrawer')==='open';
  if(isOpen){
    // ensure backdrop is hidden to not eat clicks
    var bd = document.getElementById('drawerBackdrop');
    if(bd) bd.style.display='none';
    // keep overflow unlocked to allow header taps
    document.body.style.overflow='';
  }
}catch(__e){}
        if(allExpanded){
          // currently all expanded -> collapse all
          UI.fold = {};
          ids.forEach(id=> UI.fold[id] = false);
        } else {
          // some folded -> expand all
          UI.fold = {};
        }
        renderNbTree();
      });
      left.__dblAllBound = true;
    }

    // Ensure any optional caret icon stays hidden (we're using row-click UX)
    $$('#cg_nb_tree .nb-toggle').forEach(b=> b.style.display='none');
  })();

  // V1.8.6: folding logic overhauled (fallback if no caret)
  

  // V1.8.6 UI (augment DOM elements if missing)
  // 0) Ensure toolbar exists under the new-notebook mini form
  try{
    const left = $('#cg_nb_stage .nb-left');
    const mini = left ? left.querySelector('.mini') : null;
    if(mini && !$('#cg_nb_toolbar')){
      const bar = document.createElement('div');
      bar.id = 'cg_nb_toolbar';
      bar.className = 'nb-toolbar mini';
      bar.innerHTML = '<label class="nb-select-all"><input type="checkbox" id="cg_nb_sel_all"/> 全选</label> <button id=\"cg_nb_export_sel\" class=\"btn\" disabled>导出</button> <button id="cg_nb_del_sel" class="btn" disabled>删除选定</button>';
      mini.insertAdjacentElement('afterend', bar);
    }
  }catch(e){ console.warn('toolbar init fail', e); }

  // 1) Enrich rows: add checkboxes + toggle caret
  $$('.nb-item .row', tree).forEach(row=>{
    // checkbox
    if(!row.querySelector('input[data-act="sel-nb"]')){
      const label = document.createElement('label');
      label.className = 'nb-check';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.setAttribute('data-act','sel-nb');
      label.appendChild(cb);
      row.insertBefore(label, row.firstChild);
    }
    // toggle caret within .act
    const act = row.querySelector('.act');
    if(act && !act.querySelector('button.nb-toggle')){
      const t = document.createElement('button'); t.className='nb-toggle'; t.setAttribute('data-act','toggle-nb'); t.textContent='▾';
      act.appendChild(t);
    }
  });
  $$('.nb-item ul.pages .page', tree).forEach(li=>{
    if(!li.querySelector('input[data-act="sel-pg"]')){
      const lab=document.createElement('label'); lab.className='pg-check';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.setAttribute('data-act','sel-pg');
      lab.appendChild(cb);
      li.insertBefore(lab, li.firstChild);
      // wrap name text in span.pg-name for alignment
      if(!li.querySelector('.pg-name')){
        const nameSpan=document.createElement('span'); nameSpan.className='pg-name'; nameSpan.textContent = li.textContent.replace(/\s+/g,' ').trim();
        li.innerHTML=''; li.appendChild(lab); li.appendChild(nameSpan);
      }
    }
  });

  // V1.8.6: selection checkboxes + collapse toggle UI
  window.__NB_UI__ = window.__NB_UI__ || { selected: new Set(), fold: {}, editing:null };
  const UI = window.__NB_UI__;

  // Apply expanded state (toggle buttons and pages visibility)
  $$('.nb-item', tree).forEach(li=>{
    const nbId = li.dataset.nbid;
    const expanded = (UI.fold && Object.prototype.hasOwnProperty.call(UI.fold, nbId)) ? !!UI.fold[nbId] : true;
    const toggle = li.querySelector('button.nb-toggle');
    const pages = li.querySelector('ul.pages');
    if(toggle){ toggle.textContent = expanded ? '▾' : '▸'; }
    if(pages){ pages.style.display = expanded ? '' : 'none'; }
  });

  // Reflect selected state to checkboxes
  $$('.nb-item', tree).forEach(li=>{
    const nbId = li.dataset.nbid;
    const cb = li.querySelector('input[type="checkbox"][data-act="sel-nb"]');
    if(cb) cb.checked = UI.selected.has('nb:'+nbId);
    $$('.page', li).forEach(pgEl=>{
      const pgId = pgEl.dataset.pgid;
      const cbp = pgEl.querySelector('input[type="checkbox"][data-act="sel-pg"]');
      if(cbp) cbp.checked = UI.selected.has('pg:'+pgId);
    });
  });

  // Hide old delete icons (×) in this UI step
  $$('#cg_nb_tree button.nb-x, #cg_nb_tree button.pg-x').forEach(b=> b.style.display='none');

  // Toggle notebook expand/collapse
  $$('.nb-item .nb-toggle', tree).forEach(btn=> btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    const nbId = btn.closest('.nb-item').dataset.nbid;
    if((UI.fold && (UI.fold[nbId]!==false))) if(UI.fold) UI.fold[nbId]=false; else if(UI.fold) UI.fold[nbId]=true;
    renderNbTree();
  }));

  // Selection handlers
  tree.addEventListener('change', (e)=>{
    const t = e.target;
    if(!t || t.type!=='checkbox') return;
    if(t.matches('[data-act="sel-nb"]')){
      const li = t.closest('.nb-item'); const nbId = li.dataset.nbid;
      if(t.checked) UI.selected.add('nb:'+nbId); else UI.selected.delete('nb:'+nbId);
      updateToolbar();
    }
    if(t.matches('[data-act="sel-pg"]')){
      const li = t.closest('.page'); const pgId = li.dataset.pgid;
      if(t.checked) UI.selected.add('pg:'+pgId); else UI.selected.delete('pg:'+pgId);
      updateToolbar();
    }
  });

  // Toolbar actions
  function updateToolbar(){
    const bar = $('#cg_nb_toolbar');
    if(!bar) return;
    const delBtn = $('#cg_nb_del_sel');
    const selAll = $('#cg_nb_sel_all');
    const count = UI.selected.size;
    if(delBtn){ delBtn.disabled = count===0; }
    const expBtn = $('#cg_nb_export_sel'); if(expBtn){ expBtn.disabled = count===0; }
  }
  updateToolbar();

  const selAll = $('#cg_nb_sel_all');
  if(selAll){
    selAll.onchange = ()=>{
      const check = selAll.checked;
      // select visible items (pages inside expanded notebooks only)
      UI.selected.clear();
      $$('.nb-item', tree).forEach(li=>{
        const nbId = li.dataset.nbid;
        // include notebooks that are visible in list
        if(check) UI.selected.add('nb:'+nbId);
        // pages visible only if expanded
        const expanded = ((UI.fold && (UI.fold[nbId]!==false)));
        if(expanded){
          $$('.page', li).forEach(pgEl=>{
            const pgId = pgEl.dataset.pgid;
            if(check) UI.selected.add('pg:'+pgId);
          });
        }
      });
      renderNbTree();
    };
  }

  
const delBtn = $('#cg_nb_del_sel');
if(delBtn){
  delBtn.onclick = ()=>{
    if(delBtn.disabled) return;
    const UI = window.__NB_UI__ || {selected:new Set(), expanded:new Set()};
    
const NB = (function(){
  try{ if(typeof nbStore==='function') return nbStore(); }catch(_){}
  try{ if(typeof window!=='undefined' && typeof window.nbStore==='function') return window.nbStore(); }catch(_){}
  try{ if(typeof window!=='undefined' && window.NB) return window.NB; }catch(_){}
  try{ const raw = localStorage.getItem('cg_nb_store_v1') || '{}'; return JSON.parse(raw); }catch(_){}
  return {};
})();

    // Collect selected notebooks and pages
    const nbIds = [];
    const pgIds = [];
    UI.selected.forEach(k=>{
      if(k.startsWith('nb:')) nbIds.push(k.slice(3));
      if(k.startsWith('pg:')) pgIds.push(k.slice(3));
    });
    // Build page set: pages under selected notebooks + individually selected pages
    const pagesUnderSelNb = (NB.pages||[]).filter(p=> nbIds.includes(p.notebook_id)).map(p=> p.id);
    const toDeletePagesSet = new Set([...pagesUnderSelNb, ...pgIds]);
    // Guard: must keep at least one notebook
    const remainingNbCount = (NB.notebooks||[]).filter(n=> !nbIds.includes(n.id)).length;
    if(remainingNbCount <= 0){
      alert('至少保留一个笔记本'); return;
    }
    // Confirm
    const pageCount = toDeletePagesSet.size;
    const nbCount = nbIds.length;
    if(!confirm(`将删除 ${nbCount} 个笔记本、${pageCount} 个页面，确认继续？此操作不可恢复。`)) return;

    // Perform deletion
    NB.page_entries = (NB.page_entries||[]).filter(pe=> !toDeletePagesSet.has(pe.page_id));
    NB.pages = (NB.pages||[]).filter(p=> !toDeletePagesSet.has(p.id) && !nbIds.includes(p.notebook_id));
    NB.notebooks = (NB.notebooks||[]).filter(n=> !nbIds.includes(n.id));
    nbSave(NB);

    // Clear UI selections for removed ids
    UI.selected = new Set([...UI.selected].filter(k=>{
      if(k.startsWith('nb:')) return !nbIds.includes(k.slice(3));
      if(k.startsWith('pg:')) return !toDeletePagesSet.has(k.slice(3));
      return true;
    }));
    // Cleanup expanded for removed notebooks
    nbIds.forEach(id=> UI.expanded.delete(id));

    // Fallback: try to keep current if still exists; else choose first available page
    const NB2 = nbStore();
    const firstNb = (NB2.notebooks||[])[0] || null;
    const firstPg = firstNb ? (NB2.pages||[]).find(p=> p.notebook_id===firstNb.id) : null;

    renderNbTree(firstNb? firstNb.id : null, firstPg? firstPg.id : null);
    if(firstPg && typeof renderPageStage==='function') renderPageStage(firstPg.id);
    if(window.toast) toast('已删除所选项');
  };
}



    // --- V1.8.6 UI-polish: gray × icons aligned right (no frames) ---
  try{
    // ensure flex layout for notebook rows
    $$('.nb-item .row', tree).forEach(row=>{
      row.style.display = 'flex';
      row.style.alignItems = 'center';
      const act = row.querySelector('.act') || row;
      act.style.display = 'flex';
      act.style.alignItems = 'center';
      act.style.gap = '6px';
      // add delete icon into action area (right-aligned with +页)
      if(!act.querySelector('button[data-act="del-nb"]')){
        const btn = document.createElement('button');
        btn.className = 'nb-x';
        btn.setAttribute('data-act','del-nb');
        btn.title = '删除笔记本';
        btn.textContent = '×';
        act.appendChild(btn);
      }
    });
    // page items: make li flex and append gray × at far right
    $$('.page', tree).forEach(li=>{
      li.style.display = 'flex';
      li.style.alignItems = 'center';
      li.style.justifyContent = 'space-between';
      if(!li.querySelector('button[data-act="del-page"]')){
        const b = document.createElement('button');
        b.className = 'pg-x';
        b.setAttribute('data-act','del-page');
        b.title = '删除页面';
        b.textContent = '×';
        li.appendChild(b);
      }
    });
    // handlers
    $$('.nb-item .nb-x[data-act="del-nb"]', tree).forEach(btn=> btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const nbId = btn.closest('.nb-item').dataset.nbid;
      const NBc = nbStore();
      if((NBc.notebooks||[]).length<=1){ alert('至少保留一个笔记本'); return; }
      if(!confirm('确定删除该笔记本及其所有页面？此操作不可恢复。')) return;
      const pageIds = new Set((NBc.pages||[]).filter(p=> p.notebook_id===nbId).map(p=> p.id));
      NBc.page_entries = (NBc.page_entries||[]).filter(pe=> !pageIds.has(pe.page_id));
      NBc.pages = (NBc.pages||[]).filter(p=> p.notebook_id!==nbId);
      NBc.notebooks = (NBc.notebooks||[]).filter(n=> n.id!==nbId);
      nbSave(NBc);
      if(window.__BUS__) try{ window.__BUS__.emit('nb:changed', {op:'delete-notebook', nbId}); }catch(e){}
      const NB2 = nbStore();
      const firstNb = (NB2.notebooks||[])[0];
      const firstPg = firstNb ? (NB2.pages||[]).find(p=> p.notebook_id===firstNb.id) : null;
      renderNbTree(firstNb? firstNb.id : null, firstPg? firstPg.id : null);
      if(firstPg && typeof renderPageStage==='function') renderPageStage(firstPg.id);
      if(window.toast) toast('已删除笔记本');
    }));
    $$('.page .pg-x[data-act="del-page"]', tree).forEach(btn=> btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const li = btn.closest('.page');
      const pgId = li.dataset.pgid;
      const NBc = nbStore();
      const pg = (NBc.pages||[]).find(p=> p.id===pgId); const nbId = pg ? pg.notebook_id : null;
      if(!confirm('确定删除此页面？此操作不可恢复。')) return;
      NBc.page_entries = (NBc.page_entries||[]).filter(pe=> pe.page_id!==pgId);
      NBc.pages = (NBc.pages||[]).filter(p=> p.id!==pgId);
      nbSave(NBc);
      if(window.__BUS__) try{ window.__BUS__.emit('nb:changed', {op:'delete-page', pageId:pgId, nbId}); }catch(e){}
      const NB2 = nbStore();
      let nextPg = nbId ? (NB2.pages||[]).find(p=> p.notebook_id===nbId) : null;
      if(!nextPg){
        const firstNb = (NB2.notebooks||[])[0];
        nextPg = firstNb ? (NB2.pages||[]).find(p=> p.notebook_id===firstNb.id) : null;
      }
      renderNbTree(nextPg? nextPg.notebook_id : null, nextPg? nextPg.id : null);
      if(nextPg && typeof renderPageStage==='function') renderPageStage(nextPg.id);
      if(window.toast) toast('已删除页面');
    }));
  }catch(e){ console.error('nb delete buttons init failed', e); }
  // --- /V1.8.6 ---
$$('.nb-item .name', tree).forEach(el=> el.addEventListener('click', ()=>{
  const li=el.closest('.nb-item'); const nbId=li.dataset.nbid;
  $$('.nb-item', tree).forEach(n=> n.classList.remove('active')); li.classList.add('active');
  const NBc = nbStore(); let first = (NBc.pages||[]).find(p=> p.notebook_id===nbId);
  if(!first){ first = {id:uid('pg'), notebook_id:nbId, name:'默认页', order:1, created_at:now(), updated_at:now()}; (NBc.pages=NBc.pages||[]).push(first); nbSave(NBc); }
  try{ renderNbTree(nbId, first.id); }catch(e){}
  renderPageStage(first.id);
}));
  $$('.nb-item .icon-btn[data-act="add-page"]', tree).forEach(btn=> btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    const nbId = btn.closest('.nb-item').dataset.nbid;
    const name = prompt('页面名称'); if(!name) return;
    const cur=nbStore(); const pg={id:uid('pg'), notebook_id:nbId, name, order:(cur.pages.filter(p=>p.notebook_id===nbId).length+1), created_at:now(), updated_at:now()};
    cur.pages.push(pg); nbSave(cur); renderNbTree(nbId, pg.id); renderPageStage(pg.id);
  }));
  $$('.page', tree).forEach(el=> el.addEventListener('click', ()=>{
    const pgId=el.dataset.pgid; $$('.page', tree).forEach(n=> n.classList.remove('active')); el.classList.add('active'); renderPageStage(pgId);
  }));
  if(!activeNbId && NB.notebooks[0]){
    const nbId = NB.notebooks[0].id;
    const first = NB.pages.find(p=> p.notebook_id===nbId);
    if(first) renderPageStage(first.id);
  }

  // V1.8.6: ensure newly active page is visible in list within next frame
  try{
    if(activePgId){
      requestAnimationFrame(()=>{
        const activeEl = tree.querySelector('.page.active');
        if(activeEl && activeEl.scrollIntoView){
          try{ activeEl.scrollIntoView({block:'nearest'}); }catch(e){ activeEl.scrollIntoView(); }
        }
      });
    }
  }catch(e){}
}
function renderPageStage(pgId){
  
const NB = (function(){
  try{ if(typeof nbStore==='function') return nbStore(); }catch(_){}
  try{ if(typeof window!=='undefined' && typeof window.nbStore==='function') return window.nbStore(); }catch(_){}
  try{ if(typeof window!=='undefined' && window.NB) return window.NB; }catch(_){}
  try{ const raw = localStorage.getItem('cg_nb_store_v1') || '{}'; return JSON.parse(raw); }catch(_){}
  return {};
})();

  const canvas = $('#cg_nb_canvas'); if(!canvas) return;
  const links = NB.page_entries.filter(x=> x.page_id===pgId).sort((a,b)=> (a.order||0)-(b.order||0));
  const entries = links.map(l=> NB.entries.find(e=> e.id===l.entry_id)).filter(Boolean);
  
  try{ const st = document.getElementById('cg_nb_stage'); if(st) st.dataset.pageId = pgId; const view=document.getElementById('cg_nb_view'); if(view) view.dataset.pageId = pgId; }catch(e){}
let html='';
  entries.forEach(en=>{
    const metaTitle=(en.meta&&en.meta.conv_title)?en.meta.conv_title:(en.conv_id||'');
    const cnt=(en.snapshot&&en.snapshot.messages)?en.snapshot.messages.length:(en.msg_ids?en.msg_ids.length:0);
    html += `<div class="nb-entry" data-id="${en.id}">
      <div class="nb-entry-head"><div><span class="entry-title" data-eid="${en.id}">${metaTitle}</span> · ${cnt} 条消息</div>
      <div><button class="icon-btn" data-act="add-anno">+ 注释</button><button class="icon-btn" data-act="del-entry">删除</button></div></div>
      <div class="nb-entry-body">`;
    const msgs=(en.snapshot&&en.snapshot.messages)||[];
    
msgs.forEach(m=>{
  try{
    const mb = (window.sanitizeEntryMsg) ? window.sanitizeEntryMsg(m) : { meta: [m.author, m.time].filter(Boolean).join('·'), body: String(m.text||'') };
    const esc = (s)=> String(s||'').replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    html += `<div class="nb-msg"><div class="meta" style="opacity:.7;font-size:12px;">${esc(mb.meta)}</div><div class="text">${esc(mb.body)}</div></div>`;
  }catch(e){}
});
const ann=NB.annotations.filter(a=> a.entry_id===en.id && a.page_id===pgId);
    ann.forEach(a=> html+=`<div class="nb-anno" data-aid="${a.id}"><div class="meta">注释 · ${new Date(a.updated_at||a.created_at).toLocaleString()}<button class="icon-btn anno-x" data-act="del-anno" data-id="${a.id}" title="删除注释" style="float:right;opacity:.7;border:none;background:transparent;cursor:pointer;">×</button></div><div class="text">${(a.content_md||'').replace(/[&<>]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))}</div></div>`);
    html += `</div></div>`;
  });
  if(!html) html='<div style="opacity:.7;">此页面暂无内容。先到“对话”视图批量选择加入。</div>';
  canvas.innerHTML = html;
  // v2.9.9: enable dblclick rename on entry titles
  $$('.nb-entry-head .entry-title', canvas).forEach(span => {
    if(span.__dblRenameBound) return;
    span.__dblRenameBound = true;
    span.addEventListener('dblclick', (ev)=>{
      ev.stopPropagation();
      if(span.querySelector('input.rename-input')) return;
      const oldText = (span.textContent||'').trim();
      span.innerHTML = `<input class="rename-input" type="text" maxlength="80" value="${oldText.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;')}" />`;
      const inp = span.querySelector('input.rename-input');
      inp.focus(); try{ inp.select(); }catch(_){}
      const commit = ()=>{
        const v = String(inp.value||'').trim();
        const entryEl = span.closest('.nb-entry');
        const entryId = entryEl ? entryEl.getAttribute('data-id') : span.getAttribute('data-eid');
        const NB = (typeof nbLoad==='function') ? nbLoad()
                : ( (typeof nbStore==='function') ? nbStore() 
                : ( (typeof window!=='undefined' && window.NB) ? window.NB 
                : (function(){ try{ return JSON.parse(localStorage.getItem('cg_nb_store_v1')||'{}'); }catch(_){ return {}; } })() ));
        const en = (NB.entries||[]).find(e=> String(e.id)===String(entryId));
        if(en){
          en.meta = en.meta || {};
          en.meta.conv_title = v || en.meta.conv_title || en.conv_id || '';
          en.updated_at = Date.now();
          if(typeof nbSave==='function') nbSave(NB);
          else try{ localStorage.setItem('cg_nb_store_v1', JSON.stringify(NB)); }catch(_){}
        }
        try{
          const view = document.getElementById('cg_nb_view');
          const curPgId = view ? view.dataset.pageId : null;
          if(curPgId && typeof renderPageStage==='function'){ renderPageStage(curPgId); }
        }catch(_){}
        try{
          const view = document.getElementById('cg_nb_view');
          const curPgId = view ? view.dataset.pageId : null;
          const NB2 = (typeof nbLoad==='function') ? nbLoad() : NB;
          const pg = (NB2.pages||[]).find(p=> String(p.id)===String(curPgId));
          const nbId = pg ? pg.notebook_id : null;
          if(nbId){
            const li = document.querySelector('#cg_nb_tree .nb-item[data-nbid="'+nbId+'"]');
            if(li){ const box = li.querySelector('.nb-dir-box'); if(box) box.innerHTML=''; if(typeof buildNotebookDir==='function') buildNotebookDir(li); }
          }
        }catch(_){}
      };
      const cancel = ()=>{ span.textContent = oldText; };
      inp.addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){ e.preventDefault(); commit(); }
        else if(e.key==='Escape'){ e.preventDefault(); cancel(); }
      });
      inp.addEventListener('blur', commit);
    });
  });

  $$('.nb-entry .icon-btn', canvas).forEach(btn=> btn.addEventListener('click', ()=>{
    const enEl=btn.closest('.nb-entry'); const entryId=enEl?.dataset.id; if(!entryId) return;
    const cur=nbStore();
    if(btn.dataset.act==='del-entry'){ cur.page_entries = cur.page_entries.filter(pe=> !(pe.page_id===pgId && pe.entry_id===entryId)); nbSave(cur); renderPageStage(pgId); }
    if(btn.dataset.act==='add-anno'){ openAnnoEditorStage(pgId, entryId); }
    if(btn.dataset.act==='del-anno'){
      const aid = btn.dataset.id || (btn.closest('.nb-anno')?.dataset.aid);
      if(aid && confirm('删除这条注释？')){
        const cur2 = nbStore();
        cur2.annotations = (cur2.annotations||[]).filter(a=> String(a.id)!==String(aid));
        nbSave(cur2);
        renderPageStage(pgId);
      }
    }
  }));
  const stage = $('#cg_nb_stage'); if(stage) stage.dataset.pageId = pgId;

  // V1.8.6: after rendering page, bring stage into view and sync active page visibility
  try{
    requestAnimationFrame(()=>{
      const activeEl = document.querySelector('#cg_nb_tree .page.active');
      if(activeEl && activeEl.scrollIntoView){
        try{ activeEl.scrollIntoView({block:'nearest'}); }catch(e){ activeEl.scrollIntoView(); }
      }
      const stageEl = document.querySelector('#cg_nb_stage');
      if(stageEl && stageEl.scrollIntoView){
        try{ stageEl.scrollIntoView({block:'nearest'}); }catch(e){ stageEl.scrollIntoView(); }
      }
    });
  }catch(e){}
}
function openAnnoEditorStage(pgId, entryId){
  const NB = nbStore();
  const canvas = $('#cg_nb_canvas'); if(!canvas) return;

  const entryEl = canvas.querySelector(`.nb-entry[data-id="${entryId}"]`);
  const host = entryEl?.querySelector('.nb-entry-body') || entryEl || canvas;

  const box = document.createElement('div');
  box.className = 'nb-anno nb-anno--editing';
  box.innerHTML = `
    <div class="meta">新增注释</div>
    <textarea class="cg-anno-txt" placeholder="写点什么…"></textarea>
    <div style="margin-top:6px;display:flex;gap:8px;">
      <button class="cg-btn cg-anno-cancel">取消</button>
      <button class="cg-btn primary cg-anno-save">保存</button>
    </div>`;

  host.prepend(box);

  box.querySelector('.cg-anno-cancel').addEventListener('click', ()=> box.remove());
  box.querySelector('.cg-anno-save').addEventListener('click', ()=>{
    const txt = (box.querySelector('.cg-anno-txt').value || '').trim();
    if(!txt) return;
    NB.annotations.push({ id: uid('anno'), page_id: pgId, entry_id: entryId,
                          anchor:{type:'after'}, content_md: txt, created_at: now(), updated_at: now() });
    nbSave(NB);
    renderPageStage(pgId);
  });
}

function findConversationRoot(){ const cands = ['#conversation', '.conversation', '#chat', '.chat', '#main', 'main', '.main']; for(const s of cands){ const el=$(s); if(el && el.offsetParent!==null) return el; } return null; }
function setActiveTab(mode){ $$('#cg_view_tabs .tab').forEach(t=> t.classList.toggle('active', t.dataset.mode===mode)); }
function switchMode(mode){
  try{ localStorage.setItem('cg_view_mode_1', mode); }catch(e){}
  setActiveTab(mode);
  const conv = findConversationRoot();
  const stage = $('#cg_nb_stage');
  $('#cg_bm_full') && ($('#cg_bm_full').style.display='none');
  $('#cg_nb_full') && ($('#cg_nb_full').style.display='none');
  $('#cg_nb_drawer') && ($('#cg_nb_drawer').classList.remove('open'));
  if(mode==='conversation'){ if(conv) conv.style.display=''; if(stage) stage.classList.remove('open'); }
  else if(mode==='notebooks'){ ensureNbStage(); if(conv) conv.style.display='none'; if(stage) stage.classList.add('open'); }
}
function boot(){
  const nbToggle = $('#cg_nb_toggle'); if(nbToggle) nbToggle.style.display='none';
  const nbDrawer = $('#cg_nb_drawer'); if(nbDrawer) nbDrawer.classList.remove('open');
  const bmFull = $('#cg_bm_full'); if(bmFull){ bmFull.remove(); }
  ensureTabs171a(); ensureNbStage();
  const saved = localStorage.getItem('cg_view_mode_1') || 'conversation'; switchMode(saved);
  $('#cg_nb_stage_export')?.addEventListener('click', ()=>{
    try{
      const NB = (typeof nbLoad==='function') ? nbLoad() : (typeof nbStore==='function' ? nbStore() : {});
      const stage = document.getElementById('cg_nb_stage');
      const view  = document.getElementById('cg_nb_view');
      let pageId = (stage && stage.dataset && stage.dataset.pageId) ? stage.dataset.pageId : '';

      if(!pageId){
        const tree = document.getElementById('cg_nb_tree');
        const active = tree && tree.querySelector('.nb-item.active');
        const nbId = active ? active.dataset.nbid : (NB.notebooks && NB.notebooks[0] && NB.notebooks[0].id);
        if(nbId){
          let pg = (NB.pages||[]).find(p=> p.notebook_id===nbId);
          if(!pg){ pg = {id:uid('pg'), notebook_id:nbId, name:'默认页', order:1, created_at:now(), updated_at:now()}; (NB.pages=NB.pages||[]).push(pg); if(typeof nbSave==='function') nbSave(NB); }
          pageId = pg.id;
        }
      }
      if(!pageId){ alert('没有找到可导出的笔记。'); return; }
      if(view) view.dataset.pageId = pageId;
      if(stage) stage.dataset.pageId = pageId;
      if(typeof window.exportCurrentPage === 'function'){ window.exportCurrentPage(); }
      else if(window.__BUS__){ window.__BUS__.emit('nb:export',{page_id:pageId}); }
    }catch(e){ console.error('[Notebook] export failed:', e); alert('导出失败，请稍后再试'); }
  });;
}
if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot); else boot();
})();</script><style>
#cg_nb_stage { position: fixed; left:0; right:0; bottom:0; z-index:999; background:var(--nb-bg,#fff); display:none; box-shadow:0 0 0 1px rgba(0,0,0,.02) inset; }
#cg_nb_stage.open { display:block; }
#cg_nb_stage .nb-layout{ display:grid; grid-template-columns:300px 1fr; min-height:100%; height:100%; }
#cg_nb_stage .nb-left{ border-right:1px solid var(--cg-tab-br,#e5e7eb); padding:10px; overflow:auto; background:var(--nb-bg,#fff); }
#cg_nb_stage .nb-right{ padding:10px; overflow:auto; background:var(--nb-bg,#fff); }

/* Add-to-notebook selection dialog */
#cg_nb_select_modal{ position:fixed; inset:0; z-index:2000; display:none; background:rgba(0,0,0,.35); }
#cg_nb_select_modal.open{ display:block; }
#cg_nb_select_modal .panel{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:520px; max-width:calc(100vw - 24px); background:var(--nb-bg,#fff); border-radius:14px; border:1px solid var(--nb-border,#e5e7eb); box-shadow:0 20px 80px rgba(0,0,0,.25); padding:14px; }
#cg_nb_select_modal .row{ display:flex; gap:8px; margin:8px 0; }
#cg_nb_select_modal select, #cg_nb_select_modal input{ flex:1; padding:8px 10px; border:1px solid var(--nb-border,#e5e7eb); border-radius:8px; background:transparent; color:inherit; }
#cg_nb_select_modal .footer{ display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }
#cg_nb_select_modal .btn{ padding:6px 10px; border-radius:8px; border:1px solid var(--nb-border,#e5e7eb); background:transparent; cursor:pointer; }
#cg_nb_select_modal .btn.primary{ background:var(--nb-accent,#0ea5e9); color:#fff; border-color:var(--nb-accent,#0ea5e9); }

/* Ensure legacy full views & drawers hidden */
#cg_bm_full, #cg_nb_full, #cg_nb_drawer, #cg_nb_toggle { display:none !important; }
</style><script>(function(){'use strict'; if(window.__CG_171B__) return; window.__CG_171B__=true;
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
function sizeNotebookStage(){ const stage=$('#cg_nb_stage'); if(!stage) return; const header=$('header'); const top=header?(header.getBoundingClientRect().bottom + window.scrollY):0; stage.style.top=top+'px'; stage.style.height=`calc(100vh - ${top}px)`; }
window.addEventListener('resize', sizeNotebookStage); window.addEventListener('scroll', sizeNotebookStage, {passive:true});
document.addEventListener('DOMContentLoaded', sizeNotebookStage); setTimeout(sizeNotebookStage,0);

function setActiveTab(mode){ $$('#cg_view_tabs .tab').forEach(t=> t.classList.toggle('active', t.dataset.mode===mode)); }
function findConversationRoot(){ const cands=['#conversation','.conversation','#chat','.chat','#main','main','.main']; for(const s of cands){ const el=$(s); if(el) return el; } return null; }
function switchModeInstant(mode){
  try{ localStorage.setItem('cg_view_mode_1', mode); }catch(e){}
  setActiveTab(mode);
  const conv=findConversationRoot(); const stage=$('#cg_nb_stage');
  $('#cg_bm_full') && ($('#cg_bm_full').style.display='none');
  $('#cg_nb_full') && ($('#cg_nb_full').style.display='none');
  $('#cg_nb_drawer') && ($('#cg_nb_drawer').classList.remove('open'));
  if(mode==='conversation'){ if(conv) conv.style.visibility='visible', conv.style.display=''; if(stage) stage.classList.remove('open'); setTimeout(tryEnhanceStars,0); }
  else if(mode==='notebooks'){ if(conv){ conv.style.visibility='hidden'; conv.style.display='none'; } sizeNotebookStage(); if(stage) stage.classList.add('open'); }
}
(function hookTabs(){ const tabs=$$('#cg_view_tabs .tab'); tabs.forEach(t=>{ if(!t.__patched__){ t.__patched__=true; t.addEventListener('click',(e)=>{ e.preventDefault(); switchModeInstant(t.dataset.mode); }); }}); })();
(function applySavedMode(){ const saved=localStorage.getItem('cg_view_mode_1')||'conversation'; switchModeInstant(saved); })();

(function ensureStageOnly(){ const nbToggle=$('#cg_nb_toggle'); if(nbToggle) nbToggle.style.display='none'; const nbDrawer=$('#cg_nb_drawer'); if(nbDrawer) nbDrawer.classList.remove('open'), nbDrawer.style.display='none'; const bmFull=$('#cg_bm_full'); if(bmFull) bmFull.remove(); })();

function nbLoad(){ try{ return JSON.parse(localStorage.getItem('cg_nb_store_v1')) || {notebooks:[], pages:[], entries:[], page_entries:[], annotations:[]}; }catch(e){ return {notebooks:[], pages:[], entries:[], page_entries:[], annotations:[]}; } }

// V1.8.6: robustly extract snapshot message parts
function cg_extractSnapshotFromNode(n){
  const meta = n.querySelector('.meta');
  const author = (meta && meta.querySelector('.author') && meta.querySelector('.author').textContent || '').trim();
  const time = (meta && meta.querySelector('.time') && meta.querySelector('.time').textContent || '').trim();
  const modelEl = meta && meta.querySelector('[title="\u6A21\u578B"]'); // title="模型"
  const model = (modelEl && modelEl.textContent || '').trim();
  const bodyNode = n.querySelector('.text') || n;
  let text = (bodyNode.textContent || '').trim();
  if(meta){
    const metaText = (meta.textContent || '').trim();
    if(metaText && text.startsWith(metaText)) text = text.substring(metaText.length).trim();
  }
  return { mid: n.dataset.cgMid, author, time, model, text };
}
function nbSave(v){ try{ localStorage.setItem('cg_nb_store_v1', JSON.stringify(v)); }catch(e){} try{ if(window.__BUS__) window.__BUS__.emit('nb:changed',{op:'save'}); }catch(e){} }
function uid(p='id'){ return p+'-'+Math.random().toString(36).slice(2,9); }
function now(){ return Date.now(); }

function ensureSelectDialog(){
  if($('#cg_nb_select_modal')) return;
  const modal=document.createElement('div'); modal.id='cg_nb_select_modal';
  modal.innerHTML=`<div class="panel"><div style="font-weight:600;margin-bottom:6px;">添加到笔记</div>
  <div class="row"><select id="cg_nb_sel_nb"></select></div>
  <div class="row"><input id="cg_nb_new_nb" placeholder="或新建笔记本名称…"/></div>
  <div class="row"><select id="cg_nb_sel_pg"></select></div>
  <div class="row"><input id="cg_nb_new_pg" placeholder="或新建页面名称…"/></div>
  <div class="footer"><button class="btn" id="cg_nb_sel_cancel">取消</button><button class="btn primary" id="cg_nb_sel_ok">确定</button></div></div>`;
  document.body.appendChild(modal);
  $('#cg_nb_sel_cancel').addEventListener('click', ()=> modal.classList.remove('open'));
  $('#cg_nb_sel_ok').addEventListener('click', ()=>{
    let nbId = $('#cg_nb_sel_nb').value;
    const pgIdSel = $('#cg_nb_sel_pg') ? $('#cg_nb_sel_pg').value : '';
    const newPageName = ($('#cg_nb_new_pg') && $('#cg_nb_new_pg').value || '').trim();
    const newNbName = ($('#cg_nb_new_nb') && $('#cg_nb_new_nb').value || '').trim();
    const NB = nbLoad ? nbLoad() : nbStore();
    let pageId = pgIdSel;

    if(newNbName){
      const nb = {id:uid('nb'), name:newNbName, order:(NB.notebooks||[]).length+1, created_at:now(), updated_at:now()};
      (NB.notebooks = NB.notebooks || []).push(nb);
      const pg = {id:uid('pg'), notebook_id:nb.id, name:'默认页', order:1, created_at:now(), updated_at:now()};
      (NB.pages = NB.pages || []).push(pg);
      if (typeof nbSave==='function') nbSave(NB);
      nbId = nb.id; pageId = pg.id;
      try{ if(typeof window.renderNbTree==='function') window.renderNbTree(nbId, pageId); }catch(e){}
    } else if(newPageName){
      let pg = (NB.pages||[]).find(p=> p.notebook_id===nbId);
      if(!pg){ pg = {id:uid('pg'), notebook_id:nbId, name:newPageName||'默认页', order:1, created_at:now(), updated_at:now()}; (NB.pages = NB.pages || []).push(pg); }
      else { pg.name = newPageName; pg.updated_at = now(); }
      if (typeof nbSave==='function') nbSave(NB); pageId = pg.id;
      try{ if(typeof window.renderNbTree==='function') window.renderNbTree(nbId, pageId); }catch(e){}
    }

    modal.classList.remove('open');
    addSelectionToSpecificPage(nbId, pageId);
  });
}
function openSelectDialog(){
  try{
    ensureSelectDialog();
    const modal = $('#cg_nb_select_modal'); if(!modal) return;

    // Load store safely (prefer nbLoad / fallback to nbStore)
    const NB = (typeof nbLoad==='function') ? nbLoad()
              : (typeof nbStore==='function') ? nbStore()
              : {notebooks:[], pages:[], entries:[], page_entries:[], annotations:[]};

    const nbSel = $('#cg_nb_sel_nb');
    const pgSel = $('#cg_nb_sel_pg');

    // First-time use: auto-create default notebook & page, then directly add
    if(!NB.notebooks || NB.notebooks.length===0){
      const nbId = uid('nb');
      const nb = {id: nbId, name: '默认笔记本', isDefault: true, order: 1, created_at: now(), updated_at: now()};
      NB.notebooks = NB.notebooks || [];
      NB.pages = NB.pages || [];
      NB.notebooks.push(nb);
      const pg = {id: uid('pg'), notebook_id: nbId, name: '页面 1', order: 1, created_at: now(), updated_at: now()};
      NB.pages.push(pg);

      if(typeof nbSave==='function') nbSave(NB);
      else if(typeof save==='function') save(NB);

      try{ if(typeof window.renderNbTree==='function') window.renderNbTree(nbId, pg.id); }catch(e){}
      modal.classList.remove('open');
      addSelectionToSpecificPage(nbId, pg.id);
      return;
    }

    // Populate selects
    nbSel.innerHTML = NB.notebooks.map(nb=> `<option value="${nb.id}">${nb.name}</option>`).join('');
    const refreshPages = (id)=>{
      const pages = (NB.pages||[]).filter(p=> p.notebook_id===id);
      pgSel.innerHTML = pages.map(pg=> `<option value="${pg.id}">${pg.name}</option>`).join('');
    };
    const firstNbId = NB.notebooks[0] && NB.notebooks[0].id;
    refreshPages(firstNbId||'');
    nbSel.addEventListener('change', ()=> refreshPages(nbSel.value));

    // Show dialog
    modal.classList.add('open');
  }catch(err){
    console.error('[Notebook] openSelectDialog failed:', err);
    alert('笔记本服务未初始化，请刷新页面后重试');
  }
}
(function injectAddToButton(){
  const mo=new MutationObserver(()=>{
    const bar=$('#cg_batch_bar'); if(!bar) return;
    if(!bar.querySelector('#cg_add_to_nb_choose')){
      const btn=document.createElement('button'); btn.id='cg_add_to_nb_choose'; btn.className='cg-btn'; btn.textContent='添加到…';
      bar.appendChild(btn); btn.addEventListener('click', openSelectDialog);
    }
  });
  mo.observe(document.body,{childList:true,subtree:true});
})();

function getSelectedMids(){ const cont=$('#chat, #conversation, .chat, .conversation, #main, main') || document; const mids=[]; $$('.msg', cont).forEach(n=>{ const ck=n.querySelector('.cg-check'); if(ck && ck.checked) mids.push(n.dataset.cgMid); }); return mids; }
function activeConvId(){ const a=$('.conv-item.active'); if(a) return a.dataset.id||a.id||''; const first=$('.conv-item'); return first?(first.dataset.id||first.id||''):''; }
function convTitleById(id){ const it=id && $(`.conv-item[data-id="${id}"], .conv-item[id="${id}"]`); const t=it && (it.querySelector('.title')||it); return (t && (t.textContent||'').trim()) || ''; }

function addSelectionToSpecificPage(nbId, pageId){
  // V2.9.1: normalize to notebook's single default page
  try{
    const NBx = (typeof nbLoad==='function') ? nbLoad() : (typeof nbStore==='function' ? nbStore() : {});
    const pagesArr = (NBx && NBx.pages) ? NBx.pages : [];
    if(nbId && (!pageId || !pagesArr.some(p=> p.id===pageId))){
      let pg = pagesArr.find(p=> p.notebook_id===nbId);
      if(!pg){ pg = {id:uid('pg'), notebook_id:nbId, name:'默认页', order:1, created_at:now(), updated_at:now()}; (NBx.pages = pagesArr).push(pg); if(typeof nbSave==='function') nbSave(NBx); }
      pageId = pg.id;
    }
  }catch(e){}
  const mids=getSelectedMids(); if(!mids.length){ alert('请先选择消息'); return; }
  const NB=nbLoad();
  const cont=$('#chat, #conversation, .chat, .conversation, #main, main') || document;
  const convId=activeConvId(); const convTitle=convTitleById(convId);
  const msgs=$$('.msg', cont).filter(n=> mids.includes(n.dataset.cgMid)).sort((a,b)=> Number(a.dataset.cgMid)-Number(b.dataset.cgMid));
  const snap = Array.from(msgs, n => {
  const meta = n.querySelector('.meta, .time, .timestamp');
  const time = meta ? (meta.textContent || '').trim() : '';
  const authorEl = n.querySelector('.author, .nickname, .user');
  const author = authorEl ? (authorEl.textContent || '').trim() : '';
  const text = (n.textContent || '').trim();

  return { mid: n.dataset?.cgMid || '', author, time, text };
});

  const entry={id:uid('en'), conv_id:convId, msg_ids:mids, mode:'snapshot', snapshot:{messages:snap, captured_at:now()}, meta:{conv_title:convTitle}, created_at:now(), updated_at:now()};
  NB.entries.push(entry); NB.page_entries.push({id:uid('pe'), page_id:pageId, entry_id:entry.id, order:(NB.page_entries.filter(x=>x.page_id===pageId).length+1)}); nbSave(NB);

    // === 即时刷新补丁 · Stest2.0 ===
    try {
      var nbView  = document.getElementById('cg_nb_view');
      var nbStage = document.getElementById('cg_nb_stage');
      if (nbView)  nbView.dataset.pageId  = pageId;
      if (nbStage) nbStage.dataset.pageId = pageId;

      if (typeof window.renderPage === 'function')       window.renderPage(pageId);
      if (typeof window.renderPageStage === 'function')  window.renderPageStage(pageId);

      if (typeof window.renderNotebooks === 'function')  window.renderNotebooks();
      if (typeof window.renderPages === 'function')      window.renderPages();
    } catch (e) {}
    

  try{ if(window.__BUS__) window.__BUS__.emit('nb:changed',{op:'add-entry', nbId:nbId, pageId:pageId}); if(window.renderNbTree) window.renderNbTree(nbId, pageId); if(window.toast) toast('已添加到笔记本'); }catch(e){}
  alert(`已添加 ${mids.length} 条消息到选定页面。`);
  
  /* v2.9.22: mobile hard refresh to avoid stale Drawer & stuck hamburger */
  try{
    var mql = window.matchMedia ? window.matchMedia('(max-width: 900px)') : null;
    var isMobile = mql ? mql.matches : (window.innerWidth <= 900);
    if(isMobile){
      // tiny delay to allow any pending toasts/stateless UI to settle
      setTimeout(function(){
        try{ sessionStorage.setItem('cg_nb_auto_refreshed','1'); }catch(_e){}
        /* patched: no auto reload */ void 0;
      }, 60);
    }
  }catch(_e){} 
const stage=$('#cg_nb_stage'); if(stage && stage.classList.contains('open')){ try{ stage.dataset.pageId=pageId; if(typeof window.renderPageStage==='function') window.renderPageStage(pageId);}catch(e){} }
  const clearBtn=$('#cg_clear_sel'); clearBtn && clearBtn.click();

  /* v2.9.21: post-add mobile cleanup to avoid frozen UI / hamburger blocked */
  try{
    // ensure selection mode fully exits
    if (typeof window.SELECT_ON !== 'undefined' && window.SELECT_ON) {
      try { window.SELECT_ON = false; } catch(__e){}
      try {
        var btn = document.getElementById('cg_select_toggle');
        if (btn) btn.textContent = '选择';
        var root = document.querySelector('#chat, #conversation, .chat, .conversation, #main, main') || document;
        if (root) Array.from(root.querySelectorAll('.msg .cg-check')).forEach(function(n){ try{ n.remove(); }catch(__e){} });
      } catch(__e){}
      try{ if (typeof updateBatchBar === 'function') updateBatchBar(); }catch(__e){}
    }
    // close any drawers/backdrops that might be intercepting clicks
    try{ document.body && document.body.removeAttribute('data-nbdrawer'); }catch(__e){}
    try{ document.body && document.body.removeAttribute('data-drawer'); }catch(__e){}
    try{ if (document && document.body) document.body.style.overflow=''; }catch(__e){}
    try{ var bd=document.getElementById('drawerBackdrop'); if(bd) bd.style.display='none'; }catch(__e){}
  }catch(__e){}

}

/* Star init fallback */
function tryEnhanceStars(){
  try{
    const cont=$('#chat, #conversation, .chat, .conversation, #main, main') || document;
    if(!cont) return;
    const active=$('.conv-item.active'); if(!active){ const first=$('.conv-item'); if(first){ first.classList.add('active'); } }
    const ev=new Event('cg:conv-enhance'); document.dispatchEvent(ev);
    const conv=findConversationRoot(); if(conv){ conv.setAttribute('data-cg-enhanced','1'); setTimeout(()=> conv.removeAttribute('data-cg-enhanced'),0); }
  }catch(e){}
}
document.addEventListener('DOMContentLoaded', tryEnhanceStars); setTimeout(tryEnhanceStars,50);
})();</script>
<style>
/* === V1.7.2 (deep fix) === */
/* Keep conversation visible even if legacy code toggles cg-hide on it */
.cg-keep-visible.cg-hide { 
  display: initial !important; 
  visibility: visible !important;
}
/* Ensure notebook stage never blocks clicks when closed */
#cg_nb_stage:not(.open){
  display: none !important;
  visibility: hidden !important;
  pointer-events: none !important;
}
</style>


<script>
/*! V1.7.2: Root-cause fix for conversation disappearing after switching from notebooks
  Strategy:
  1) Overlay-only notebooks: never hide conversation intentionally.
  2) Cache & mark the real conversation root (.cg-keep-visible).
  3) Deep-unhide on switch back (clear inline display/visibility & hiding classes up the ancestor chain).
  4) MutationObserver watchdog: if conversation becomes hidden while notebooks overlay is closed, restore it.
*/
(function(){
  'use strict';
  if (window.__CG_172_DEEP_FIX__) return;
  window.__CG_172_DEEP_FIX__ = true;

  const $ = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));

  /* ---------------- Conversation Root Helpers ---------------- */
  function getConvRoot(){
    if (window.__CG_CONV_ROOT__ && document.body.contains(window.__CG_CONV_ROOT__)) return window.__CG_CONV_ROOT__;
    // Prefer containers that have .msg children (actual conversation content)
    const cands = ['#conversation', '.conversation', '#chat', '.chat', '#main', 'main', '.main'];
    let best = null, maxMsgs = -1;
    cands.forEach(sel=> {
      const el = document.querySelector(sel);
      if (!el) return;
      const count = el.querySelectorAll('.msg').length;
      if (count > maxMsgs) { maxMsgs = count; best = el; }
    });
    if (!best){
      // fallback: any candidate
      best = document.querySelector('#conversation, .conversation, #chat, .chat, #main, main, .main');
    }
    if (best){
      window.__CG_CONV_ROOT__ = best;
      try { best.classList.add('cg-keep-visible'); best.setAttribute('data-cg-keep','1'); } catch(e){}
    }
    return best;
  }

  function unhideDeep(node){
    if(!node) return;
    const HIDE_CLASSES = ['cg-hide','hidden','is-hidden'];
    let el = node;
    while (el && el !== document.documentElement){
      // remove hiding classes
      HIDE_CLASSES.forEach(cls => el.classList && el.classList.remove(cls));
      // clear inline display/visibility
      try{
        if (el.style && (el.style.display === 'none' || (el.getAttribute && /display:\s*none/i.test(el.getAttribute('style')||'')))){
          el.style.display = '';
        }
        if (el.style && (el.style.visibility === 'hidden' || (el.getAttribute && /visibility:\s*hidden/i.test(el.getAttribute('style')||'')))){
          el.style.visibility = '';
        }
      }catch(e){}
      el = el.parentElement;
    }
  }

  /* ---------------- Notebook Stage Show/Hide ---------------- */
  function hideStage(){
    const stage = $('#cg_nb_stage');
    if (!stage) return;
    stage.classList.remove('open');
    stage.style.display = 'none';
    stage.style.visibility = 'hidden';
    stage.style.pointerEvents = 'none';
  }
  function showStage(){
    const stage = $('#cg_nb_stage');
    if (!stage) return;
    stage.classList.add('open');
    stage.style.display = '';
    stage.style.visibility = '';
    stage.style.pointerEvents = '';
    // Position below header
    const header = $('header');
    const top = header ? (header.getBoundingClientRect().bottom + window.scrollY) : 0;
    stage.style.position = 'fixed';
    stage.style.left = '0'; stage.style.right = '0'; stage.style.bottom = '0';
    stage.style.top = top + 'px';
    stage.style.height = `calc(100vh - ${top}px)`;
  }

  function ensureConvVisible(){
    const conv = getConvRoot();
    hideStage(); // notebooks overlay away
    if (!conv) return;
    unhideDeep(conv);
    // Restore stored original display if present
    try{
      if (!conv.dataset.cgPrevDisp){
        const cs = getComputedStyle(conv);
        conv.dataset.cgPrevDisp = cs && cs.display ? cs.display : 'block';
      }
      conv.style.display = conv.dataset.cgPrevDisp || 'block';
    }catch(e){ conv.style.display = 'block'; }
    conv.style.visibility = '';
    // Let layout settle then notify enhancers
    requestAnimationFrame(()=> document.dispatchEvent(new Event('cg:conv-enhance')));
  }

  /* ---------------- Hook Tabs (post-run) ---------------- */
  document.addEventListener('click', function(e){
    const tab = e.target.closest && e.target.closest('#cg_view_tabs .tab');
    if (!tab) return;
    const mode = tab.dataset.mode;
    setTimeout(()=> {
      if (mode === 'conversation') ensureConvVisible();
      if (mode === 'notebooks')  showStage();
    }, 0);
  });

  /* ---------------- Apply Saved Mode on load ---------------- */
  document.addEventListener('DOMContentLoaded', ()=>{
    const saved = localStorage.getItem('cg_view_mode_1') || 'conversation';
    if (saved === 'conversation') ensureConvVisible();
    else if (saved === 'notebooks') showStage();
  });

  /* ---------------- Watchdog: if conv hides unexpectedly, bring it back ---------------- */
  const mo = new MutationObserver(()=>{
    const stageOpen = $('#cg_nb_stage') && $('#cg_nb_stage').classList.contains('open');
    const conv = getConvRoot();
    if(!conv) return;
    // If notebooks overlay isn't open and conv computed display is 'none' or visibility hidden, restore
    try{
      const cs = getComputedStyle(conv);
      if(!stageOpen && (cs.display === 'none' || cs.visibility === 'hidden')){
        ensureConvVisible();
      }
    }catch(e){}
  });
  mo.observe(document.documentElement, { attributes:true, childList:true, subtree:true, attributeFilter:['class','style'] });

  /* ---------------- Make version explicit ---------------- */
  try{
    const VER = 'V1.7.2';
    window.__BUILD_META__ = window.__BUILD_META__ || {};
    window.__BUILD_META__.version = VER;
    if (document.title && !document.title.includes(VER)) document.title = document.title + ' · ' + VER;
    const badge = document.getElementById('cg_version_badge');
    if (badge) badge.textContent = VER;
  }catch(e){}
})();
</script>


<script>
/*! V1.7.2b — ENTER-only patch (safe & local):
   - Press Enter in "新建模块" input (bookmark drawer) => trigger existing "新增模块" button
   - Press Enter in "或新建页面名称" input (Add-to-Notebook modal) => trigger existing "确定/添加" button
   No global MutationObserver, no node cloning, no data-structure change.
*/
(function(){
  'use strict';
  if (window.__CG_172B_ENTER_PATCH__) return;
  window.__CG_172B_ENTER_PATCH__ = true;

  function isInput(el){ return el && el.tagName && /^(INPUT|TEXTAREA)$/i.test(el.tagName); }

  function isBookmarkNewModuleInput(el){
    if (!isInput(el)) return false;
    const ph = (el.getAttribute('placeholder')||''); const id = el.id||''; const name=el.name||'';
    return (
      /新建模块|新建标签|新建书签|模块名|标签名/i.test(ph) ||
      /bm_tag_input/i.test(id+name)
    );
  }

  function isNotebookNewPageInput(el){
    if (!isInput(el)) return false;
    const ph = (el.getAttribute('placeholder')||''); const id = el.id||''; const name = el.name||'';
    return (
      /新建页面|新建页|页面名称|或新建页面/i.test(ph) ||
      /nb_new_pg|new_page/i.test(id+name)
    );
  }

  function findButton(container, selectors, textRegex){
    if (!container) container = document;
    // Try specific selectors first
    for (const sel of selectors){
      const btn = container.querySelector(sel);
      if (btn) return btn;
    }
    // Fallback: any button whose text matches
    const list = Array.from(container.querySelectorAll('button'));
    const found = list.find(b => textRegex.test((b.textContent||'').trim()));
    return found || null;
  }

  document.addEventListener('keydown', function(e){
    if (e.isComposing) return;
    if (e.key !== 'Enter') return;
    const t = e.target;
    if (!isInput(t)) return;

    // Case A: Bookmark drawer — "新建模块" input
    if (isBookmarkNewModuleInput(t)){
      e.preventDefault();
      const drawer = t.closest('#cg_bm_drawer, .drawer, .bm-drawer, .bm-panel') || document;
      const btn = findButton(drawer,
        ['#cg_bm_add_tag', '#cg_bm_add_tag_full', 'button[data-action="add-tag"]'],
        /新增|新建|添加/
      );
      if (btn){ btn.click(); }
      return;
    }

    // Case B: Add-to-Notebook modal — "或新建页面名称" input
    if (isNotebookNewPageInput(t)){
      e.preventDefault();
      const modal = t.closest('#cg_nb_select_modal, #cg_nb_select_modal_ext, .modal, [role="dialog"]') || document;
      // Click the existing Confirm/OK handler so we reuse all original logic
      const ok = findButton(modal,
        ['#cg_nb_sel_ok', '#cg_nb_sel_ok_ext', 'button[data-action="confirm"]', '.btn.primary'],
        /确定|添加/
      );
      if (ok){ ok.click(); }
      return;
    }
  }, false);

  // Version badge/title sync
  try{
    const VER = 'V1.8.6';
    window.__BUILD_META__ = window.__BUILD_META__ || {};
    window.__BUILD_META__.version = VER;
    if (document.title && !document.title.includes(VER)) document.title = document.title + ' · ' + VER;
    const badge = document.getElementById('cg_version_badge');
    if (badge) badge.textContent = VER;
  }catch(e){}
})();
</script>

<script>(function(){
  function firstEnhance(){ try{ if(typeof enhanceCurrent==='function') enhanceCurrent(); }catch(e){} }
  function ensureSubs(){
    if(!window.__BUS__ || window.__BUS__.__wired__) return;
    try{
      const BUS = window.__BUS__; BUS.__wired__=true;
      let raf1=0, raf2=0, raf3=0;
      BUS.on('bm:changed', ()=>{ cancelAnimationFrame(raf1); raf1=requestAnimationFrame(()=>{ try{
        if(typeof renderTags==='function') renderTags();
        if(typeof renderList==='function') renderList();
        if(typeof enhanceCurrent==='function') enhanceCurrent();
      }catch(e){} }); });
      BUS.on('tag:changed', ()=>{ cancelAnimationFrame(raf2); raf2=requestAnimationFrame(()=>{ try{
        if(typeof renderTags==='function') renderTags();
        if(typeof renderList==='function') renderList();
      }catch(e){} }); });
      BUS.on('nb:changed', (p)=>{ cancelAnimationFrame(raf3); raf3=requestAnimationFrame(()=>{ try{
        if(typeof renderNbTree==='function') renderNbTree(p && p.nbId, p && p.pageId);
        if(typeof renderPage==='function' && p && p.pageId) renderPage(p.pageId); if(typeof renderPageStage==='function' && p && p.pageId) renderPageStage(p.pageId);
      }catch(e){} }); });
    }catch(e){}
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    firstEnhance();
    requestAnimationFrame(firstEnhance);
    requestAnimationFrame(firstEnhance);
    ensureSubs();
    let target = document.querySelector('#chat, #conversation, .chat, .conversation, #main, main');
    const ensureObserve = ()=>{
      if(!target){
        const mo = new MutationObserver((muts, obs)=>{
          target = document.querySelector('#chat, #conversation, .chat, .conversation, #main, main');
          if(target && target.children.length){ firstEnhance(); obs.disconnect(); }
        });
        mo.observe(document.body, {childList:true, subtree:true});
      }else if(!target.children.length){
        const mo = new MutationObserver((muts, obs)=>{
          if(target.children.length){ firstEnhance(); obs.disconnect(); }
        });
        mo.observe(target, {childList:true});
      }
    };
    ensureObserve();
    setTimeout(ensureSubs, 100);
    setTimeout(firstEnhance, 200);
  });
})();</script>
<script>
// V1.8.6 sanitize utilities (fix syntax; strip model/star from body only)
(function(){
  // idempotent
  window.__NB_SANITIZE__ = true;

  function makeMetaLine(author, time){
    let t = '';
    if (author) t += String(author).trim();
    if (time) t += (t ? '·' : '') + String(time).trim();
    // keep meta as-is per requirement (no stripping of model here)
    return t;
  }

  function stripLeadingPrefixOnce(txt){
    if(!txt) return txt;
    let s = String(txt);
    s = s.replace(/^\u200B+/, '').replace(/^\s+/, '');

    // 1) nickname · time [AM/PM] [TZ] [model]? [★]? [sep]? (strip once)
    const rePrefix = /^(You|Me|User|Assistant|系统|助手|\S{1,32})\s*[·:：]\s*\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}(?::\d{2})?(?:\s*(?:AM|PM))?(?:\s*[+-]\d{2}:\d{2})?(?:\s*(?:gpt[\-\.\w]+|o\d[\w\-\.]*|claude[\-\w\.]+|gemini[\-\w\.]+|llama[\-\w\.]+))?(?:\s*★+)?(?:\s*[-—:：,，|·])?\s*/i;
    if (rePrefix.test(s)) {
      s = s.replace(rePrefix, '');
    } else {
      // If first line alone matches, drop that line
      const nl = s.indexOf('\n');
      if (nl > -1) {
        const first = s.slice(0, nl);
        if (rePrefix.test(first)) s = s.slice(nl + 1);
      }
    }

    // 2) leading plain "· model [★]" without nickname/time (strip once)
    const reModelOnly = /^\s*[·:：|,，\-—]*\s*(gpt[\-\.\w]+|o\d[\w\-\.]*|claude[\-\w\.]+|gemini[\-\w\.]+|llama[\-\w\.]+)\s*★*\s*/i;
    s = s.replace(reModelOnly, '');

    // 3) residual separators/stars
    s = s.replace(/^\s*★+\s*/, '');
    s = s.replace(/^\s*[-—:：|·，,]+\s*/, '');
    return s;
  }

  function sanitizeEntryMsg(m){
    const meta = makeMetaLine(m && m.author, m && m.time);
    const body = stripLeadingPrefixOnce((m && m.text) || '');
    return { meta, body };
  }

  window.sanitizeEntryMsg = sanitizeEntryMsg;
})();
</script>

<button class="settings-fab" id="openTheme" title="外观">⚙️</button>
<div id="themePanel" aria-label="外观设置面板">
  <header>
    <strong>外观</strong>
    <div>
      <button class="btn" id="hideNavToggle">切换侧栏</button>
      <button class="btn" id="closeTheme">关闭</button>
    </div>
  </header>
  <div class="sec">
    <!-- ==== 昵称区（同一行两列） ==== -->
    
    <!-- ==== 身份（4x2 紧凑布局） ==== -->
    <div class="row-identity-2r">
      <label class="lbl">用户：</label>
      <input id="userName" type="text" placeholder="You" />
      <label class="lbl">助手：</label>
      <input id="assistantName" type="text" placeholder="Assistant" />
      <div class="avatar-cell">
        <div class="avatar-box xs">
          <img id="userAvatarPreview" class="avatar-img" src="" alt="U" />
          <div id="userAvatarDefault" class="avatar-default">U</div>
        </div>
      </div>
      <div class="upload-cell">
        <label for="userAvatar" class="btn linklike">上传头像</label>
        <input id="userAvatar" type="file" accept="image/*" style="display:none"/>
      </div>
      <div class="avatar-cell">
        <div class="avatar-box xs">
          <img id="assistantAvatarPreview" class="avatar-img" src="" alt="A" />
          <div id="assistantAvatarDefault" class="avatar-default">A</div>
        </div>
      </div>
      <div class="upload-cell">
        <label for="assistantAvatar" class="btn linklike">上传头像</label>
        <input id="assistantAvatar" type="file" accept="image/*" style="display:none"/>
      </div>
    </div>
    

    <!-- ==== 身份（紧凑一行，随宽度自适） ==== -->
    
    <div class="divider"></div>

    
    <!-- ==== 头像（双列，与昵称列对齐） ==== -->
    
    


    <!-- ==== 用户头像区 ==== -->
    

    <div class="divider"></div>

    

    
    

    
    

    
    
    
    

    
    

    
  </div>
<div class="sec sec--controls">

    <div class="row3 thememode">
      <div class="label">主题</div>
      <div class="val"></div>
      <div class="ctrl">
      <div class="seg" id="th_mode_seg">
        <label class="segbtn"><input type="radio" name="th_mode" id="th_mode_light" value="light">纯白</label>
        <label class="segbtn"><input type="radio" name="th_mode" id="th_mode_dark" value="dark">夜间</label>
        <label class="segbtn"><input type="radio" name="th_mode" id="th_mode_custom" value="custom">自定义</label>
      </div>
</div>
    </div>

<div class="row3"><div class="label">字体</div><div class="val"></div>
      <div class="ctrl" style="min-width:0">
        <select id="th_font" style="width:100%">
          <option value="system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'PingFang SC', 'Noto Sans CJK SC', 'Microsoft YaHei', sans-serif">系统默认</option>
          <option value="Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif">Inter（若可用）</option>
          <option value="'PingFang SC', 'Microsoft YaHei', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif">中文优先</option>
        </select>
      </div>
    </div><div class="row3"><div class="label">字号</div><div class="val"></div><div class="ctrl" style="min-width:0"><input type="range" id="th_fontSize" min="12" max="20" step="1"></div></div><div class="row3"><div class="label">行高</div><div class="val"></div><div class="ctrl" style="min-width:0"><input type="range" id="th_lineHeight" min="1.2" max="2.0" step="0.05"></div></div><div class="row3"><div class="label">圆角</div><div class="val"></div><div class="ctrl" style="min-width:0"><input type="range" id="th_radius" min="8" max="24" step="1"></div></div><div class="row3"><div class="label">阴影</div><div class="val"></div><div class="ctrl" style="min-width:0"><input type="range" id="th_shadow" min="0" max="1" step="0.05"></div></div><div class="row3"><div class="label">视图比例</div><div class="val"></div><div class="ctrl" style="min-width:0"><input type="range" id="th_notesWidth" min="30" max="100" step="1"></div></div><div class="row3"><div class="label">气泡宽度</div><div class="val"></div><div class="ctrl" style="min-width:0"><input type="range" id="th_maxw" min="50" max="90" step="1"></div></div><div class="row3 color" style="min-width:0"><div class="label">助手颜色</div><div class="val"><span class="swatch" id="assistSwatch"></span></div><div class="ctrl" style="min-width:0"><input type="color" id="th_assistColor"><input type="range" id="th_assistOpacity" min="0.4" max="1" step="0.05"></div></div><div class="row3 color" style="min-width:0"><div class="label">我方颜色</div><div class="val"><span class="swatch" id="userSwatch"></span></div><div class="ctrl" style="min-width:0"><input type="color" id="th_userColor"><input type="range" id="th_userOpacity" min="0.4" max="1" step="0.05"></div></div><div class="row3 color" style="min-width:0"><div class="label">导航颜色</div><div class="val"><span class="swatch" id="navSwatch"></span></div><div class="ctrl" style="min-width:0"><input type="color" id="th_navBg"><input type="range" id="th_navOpacity" min="0.4" max="1" step="0.05"></div></div>
    <div class="row3 color">
      <div class="label">页面背景</div>
      <div class="val">
        <div id="bgSwatch" class="swatch"></div>
      </div>
      <div class="ctrl">
        <input type="color" id="th_bg"/>
        <label for="bgImageInput" class="btn linklike">上传图片</label>
        <button id="clearBgImage" class="btn linklike" type="button">清除图片</button>
        <input id="bgImageInput" type="file" accept="image/*" style="display:none"/>
      </div>
    </div>


</div>
</div>

<script id="theme-logic-1_8_5a">
  // V2.4.7-fix6 helpers: name initial & themed letter avatar
  function initialChar(name, fallback){
    try{ const s=(name||'').trim(); if(!s) return fallback||'?'; const c=s[0]; return /[a-z]/i.test(c)? c.toUpperCase(): c; }
    catch(e){ return fallback||'?'; }
  }
  function getThemeColor(varName, fallback){
    try{ const v=getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); return v || fallback; }
    catch(e){ return fallback; }
  }
  function makeLetterAvatar(letter, bg, fg){
    const L=(letter||'?').slice(0,1);
    const W=36,H=36,R=18;
    const bgColor = bg || '#f3f4f6';
    const fgColor = fg || '#374151';
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
      <rect rx="${R}" ry="${R}" width="${W}" height="${H}" fill="${bgColor}"/>
      <text x="50%" y="54%" text-anchor="middle" dominant-baseline="middle"
        font-family="ui-sans-serif,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif"
        font-size="18" fill="${fgColor}">${L}</text></svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }

  // V2.4.7-fix2: derive a dataURL from the panel's preview (letter+solid bg)
  function panelPreviewAvatar(role){
    try{
      if(role==='user'){
        const img = document.getElementById('userAvatarPreview');
        if(img && img.getAttribute('src')) return img.getAttribute('src');
        const d = document.getElementById('userAvatarDefault');
        if(d){
          const letter = (d.textContent||'U').trim().charAt(0) || 'U';
          const bg = getComputedStyle(d).backgroundColor || getThemeColor('--user-solid', '#d2f9ee');
          return makeLetterAvatar(letter, bg, '#374151');
        }
  // V2.4.7-fix3: centralized selection to guarantee a valid src
  function effectiveAvatar(role){
    try{
      if(role==='user'){
        return (typeof userAvatar==='string' && userAvatar) ? userAvatar
          : panelPreviewAvatar('user') || defaultUser();
      }else if(role==='assistant'){
        return (typeof assistantAvatar==='string' && assistantAvatar) ? assistantAvatar
          : panelPreviewAvatar('assistant') || defaultAssistant();
      }else{
        return defaultOther(role||'?');
      }
    }catch(e){ return role==='assistant' ? defaultAssistant() : defaultUser(); }
  }

      }else if(role==='assistant'){
        const img = document.getElementById('assistantAvatarPreview');
        if(img && img.getAttribute('src')) return img.getAttribute('src');
        const d = document.getElementById('assistantAvatarDefault');
        if(d){
          const letter = (d.textContent||'A').trim().charAt(0) || 'A';
          const bg = getComputedStyle(d).backgroundColor || getThemeColor('--assistant-solid', '#f7f7f8');
          return makeLetterAvatar(letter, bg, '#111827');
        }
      }
    }catch(e){}
    return '';
  }

(function(){
  const KEY='cg_theme_v1';
  const $ = (s,sc)=> (sc||document).querySelector(s);
  // V2.4.7-fix1: load persisted avatars once
  var userAvatar = (function(){ try{ const v=localStorage.getItem('cg_userAvatar'); return (typeof v==='string' && v.startsWith('data:image')) ? v : ''; }catch(e){ return ''; } })();
  var assistantAvatar = (function(){ try{ const v=localStorage.getItem('cg_assistantAvatar'); return (typeof v==='string' && v.startsWith('data:image')) ? v : ''; }catch(e){ return ''; } })();

  function hexToRgb(h){ h=(h||'').trim(); if(!h||h[0]!=='#') return [255,255,255];
    if(h.length===4){ return [parseInt(h[1]+h[1],16), parseInt(h[2]+h[2],16), parseInt(h[3]+h[3],16)]; }
    if(h.length===7){ return [parseInt(h.substr(1,2),16), parseInt(h.substr(3,2),16), parseInt(h.substr(5,2),16)]; }
    return [255,255,255];
  }
  function toRgba(hex, a){ const [r,g,b]=hexToRgb(hex); return `rgba(${r},${g},${b},${a})`; }

  const defaults = {
    fontFamily: getComputedStyle(document.documentElement).getPropertyValue('--font-family').trim(),
    fontSize: 15, lineHeight: 1.6,
    assist: '#F0F4FF', assistOpacity: 1,
    user: '#D2F9EE',  userOpacity: 1,
    radius: 14, maxw: 85, shadow: 0,
    bg: '#FAFAFA',
    bgImg: '',
    navBg: '#FFFFFF', navOpacity: 0.92,
    notesMaxw: 980,
    notesPct: 1,
    navHidden: false
  };
  function load(){ try{ return Object.assign({}, defaults, JSON.parse(localStorage.getItem(KEY)||'{}')); }catch(e){ return Object.assign({}, defaults); } }
  function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

  function apply(state){
    const root = document.documentElement.style;
    root.setProperty('--font-family', state.fontFamily);
    root.setProperty('--font-size', state.fontSize+'px');
    root.setProperty('--line-height', String(state.lineHeight));
    root.setProperty('--assistant', toRgba(state.assist, state.assistOpacity));
    root.setProperty('--user', toRgba(state.user, state.userOpacity));
    // solid (opacity=1) for avatar previews & letter avatars
    root.setProperty('--assistant-solid', state.assist);
    root.setProperty('--user-solid', state.user);
    root.setProperty('--bubble-radius', state.radius+'px');
    root.setProperty('--bubble-maxw', state.maxw+'%');
    root.setProperty('--bubble-shadow', state.shadow);
    root.setProperty('--bg-base', state.bg);
    // V2.4.6 apply background image via CSS var (safe & decoupled)
    try{
      // clear first to avoid transient bad values
      root.setProperty('--page-bg-image', 'none');
      var img = (state.bgImg && typeof state.bgImg==='string') ? state.bgImg : '';
      if(img && (img.startsWith('data:image') || img.startsWith('blob:'))){
        var quoted = 'url("' + img.replace(/"/g, '\\"') + '")';
        root.setProperty('--page-bg-image', quoted);
      }else{
        root.setProperty('--page-bg-image', 'none');
      }
    }catch(e){}

    root.setProperty('--nav-bg', state.navBg);
    root.setProperty('--nav-opacity', state.navOpacity);
    root.setProperty('--nav-bg-rgba', toRgba(state.navBg, state.navOpacity));
    root.setProperty('--notes-maxw', (state.notesMaxw||980) + 'px');
    root.setProperty('--notes-width-pct', (state.notesPct||1));
    if(state.navHidden){ document.body.setAttribute('data-layout','nav-hidden'); } else { document.body.removeAttribute('data-layout'); }
    try{ window.__BUS__ && __BUS__.emit('theme:changed', state); }catch(e){}
    safeApplyNoteSkins();
  }

  function safeApplyNoteSkins(){
    try{
      const cs = getComputedStyle(document.documentElement);
      const bg = cs.getPropertyValue('--bg-base').trim();
      const nav = cs.getPropertyValue('--nav-bg-rgba').trim();
      const L = document.querySelector('#cg_nb_stage .nb-left, .nb-left, .notes-nav');
      const R = document.querySelector('#cg_nb_stage .nb-right, .nb-right, .notes-main, .nb-content');
      const P = document.querySelectorAll('#cg_nb_stage .nb-right .page, .nb-right .page, .notes-main .page');
      if(L) L/*blocked-inline-bg*/ .style.background = nav;
      if(R) R/*blocked-inline-bg*/ .style.background = bg;
      P.forEach(el => el/*blocked-inline-bg*/ .style.background = 'transparent');
    }catch(e){}
  }

  const state = load();
  // V2.4.6-fix1: sanitize persisted bgImg
  try{
    if(state && (typeof state.bgImg !== 'string' || !(state.bgImg.startsWith('data:image') || state.bgImg.startsWith('blob:')))){
      state.bgImg=''; save(state);
    }
  }catch(e){}
  apply(state);

  function open(){ const p=$('#themePanel'); if(p) p.setAttribute('data-open','1'); }
  function close(){ const p=$('#themePanel'); if(p) p.removeAttribute('data-open'); }

  document.addEventListener('click', function(e){
    const t=e.target;
    if(t && (t.id==='openTheme' || (t.closest && t.closest('#openTheme')))){ e.preventDefault(); e.stopPropagation(); open(); }
    if(t && (t.id==='closeTheme')){ e.preventDefault(); close(); }
    if(t && t.id==='hideNavToggle'){ e.preventDefault(); state.navHidden=!state.navHidden; save(state); apply(state); }
  }, true);

  document.addEventListener('keydown', function(e){
    if((e.ctrlKey||e.metaKey) && e.key===','){ e.preventDefault(); open(); }
  });

  function updateSwatches(){
    const setSw=(id,hex)=>{ const s=$(id); if(s) s/*blocked-inline-bg*/ .style.background = hex; };
    setSw('#assistSwatch', state.assist);
    setSw('#userSwatch', state.user);
    setSw('#bgSwatch', state.bg);
    setSw('#navSwatch', state.navBg);
  }

  function initControls(){
    const map = {
      '#th_font': state.fontFamily, '#th_fontSize': state.fontSize, '#th_lineHeight': state.lineHeight,
      '#th_assistColor': state.assist, '#th_assistOpacity': state.assistOpacity,
      '#th_userColor': state.user, '#th_userOpacity': state.userOpacity,
      '#th_radius': state.radius, '#th_maxw': state.maxw, '#th_shadow': state.shadow,
      '#th_notesWidth': Math.round((state.notesPct||1)*100),
      '#th_bg': state.bg, '#th_navBg': state.navBg, '#th_navOpacity': state.navOpacity
    };
    for(const sel in map){ const el=$(sel); if(el) el.value = map[sel]; }
    updateSwatches();
  }

  function onChange(e){
    const el=e.target; if(!el) return;
    switch(el.id){
      case 'th_font': state.fontFamily = el.value; break;
      case 'th_fontSize': state.fontSize = +el.value; break;
      case 'th_lineHeight': state.lineHeight = +el.value; break;
      case 'th_assistColor': state.assist = el.value; break;
      case 'th_assistOpacity': state.assistOpacity = +el.value; break;
      case 'th_userColor': state.user = el.value; break;
      case 'th_userOpacity': state.userOpacity = +el.value; break;
      case 'th_radius': state.radius = +el.value; break;
      case 'th_maxw': state.maxw = +el.value; break;
      case 'th_shadow': state.shadow = +el.value; break;
      case 'th_notesWidth': state.notesPct = (+el.value)/100; break;
      case 'th_bg': state.bg = el.value; break;
      case 'th_navBg': state.navBg = el.value; break;
      case 'th_navOpacity': state.navOpacity = +el.value; break;
    }
    save(state); apply(state); updateSwatches();
  }

  document.addEventListener('DOMContentLoaded', function(){
    initControls();
    const p=document.getElementById('themePanel');
    if(p){ p.addEventListener('input', onChange); p.addEventListener('change', onChange); }
    // V2.4.6 Background image upload & clear (robust, minimal)
    try{
      const bgInput = document.getElementById('bgImageInput');
      const clearBtn = document.getElementById('clearBgImage');
      function setBgImg(dataURL){
        if(typeof dataURL === 'string' && (dataURL.startsWith('data:image') || dataURL.startsWith('blob:'))){
          state.bgImg = dataURL;
          save(state); apply(state);
          try{ window.toast && toast('已设置页面背景'); }catch(e){}
        }else{
          // invalid image
          try{ window.toast && toast('图片读取失败'); }catch(e){}
        }
      }
      if(bgInput){
        bgInput.addEventListener('change', function(ev){
          // prevent the outer onChange from racing
          ev.stopPropagation && ev.stopPropagation();
          ev.stopImmediatePropagation && ev.stopImmediatePropagation();
          const f = ev.target && ev.target.files && ev.target.files[0];
          if(!f){ return; }
          if(window.openCropper){ (async ()=>{ try{ const cropped = await window.openCropper(f, {mode:'bg', aspect:'16:9'}); if(cropped) setBgImg(cropped); }catch(_){ try{ window.toast && toast('图片读取失败'); }catch(e){} } })(); } else { const reader = new FileReader(); reader.onload=function(){ const res=reader.result; if(typeof res==='string'){ setBgImg(res);} else { try{ window.toast&&toast('图片读取失败'); }catch(e){} } }; reader.onerror=function(){ try{ window.toast&&toast('图片读取失败'); }catch(e){} }; reader.readAsDataURL(f); }
        }, true);
      }
      if(clearBtn){ clearBtn.addEventListener('click', function(ev){ ev.stopPropagation && ev.stopPropagation(); ev.stopImmediatePropagation && ev.stopImmediatePropagation();
          ev.preventDefault();
          state.bgImg='';
          save(state); apply(state);
          const inp = document.getElementById('bgImageInput'); if(inp) inp.value='';
          try{ window.toast && toast('已清除页面背景'); }catch(e){}
        });
      }
    }catch(e){}

    try{
      const tgt = document.querySelector('#cg_nb_stage') || document.body;
      const mo = new MutationObserver(()=> safeApplyNoteSkins());
      mo.observe(tgt, {subtree:true, childList:true});
    }catch(e){}
  });

  // 标题更新
  (function(){
    try{
      var fname = (location.pathname.split('/').pop() || '').replace(/\.html.*$/,'');
      var ver = '1.8.5c';
      document.title = 'ChatGPT 对话查看器 V（' + fname + '）' + ver;
      var candidates = Array.from(document.querySelectorAll('h1, .app-title, [data-app-title]'));
      var hit = candidates.find(el=> /ChatGPT\s*对话查看器/i.test(el.textContent||''));
      if(hit){ hit.textContent = 'ChatGPT 对话查看器 VV1.9（' + fname + '）' + ver; }
    }catch(e){}
  })();
})();

  // V2.4.7-fix4: force-apply preview/default avatars into chat list (robust fallback)
  function hydrateAvatars(root){
    try{
      const scope = root || document;
      const items = scope.querySelectorAll('.msg');
      items.forEach(it => {
        const role = it.classList.contains('right') ? 'user' : 'assistant';
        let img = it.querySelector('img.avatar');
        if(!img){
          img = document.createElement('img');
          img.className = 'avatar';
          it.insertBefore(img, it.firstChild);
        }
        if(!img.getAttribute('src') || img.getAttribute('src')===''){
          img.src = effectiveAvatar(role);
          img.onerror = function(){ this.onerror=null; this.src = (role==='assistant') ? defaultAssistant() : defaultUser(); };
        }
      });
    }catch(e){}
  }
  (function initAvatarHydrator(){
    try{
      const chat = document.getElementById('chat');
      if(chat){
        hydrateAvatars(chat);
        const obs = new MutationObserver(muts => {
          for(const mu of muts){
            for(const n of mu.addedNodes){
              if(n.nodeType===1){ hydrateAvatars(n); }
            }
          }
        });
        obs.observe(chat, {childList:true, subtree:true});
      }
    }catch(e){}
  })();

  // V2.4.7-fix5: absolute fallback hydration, overwrite .msg .avatar content if missing or broken
  function enforceAvatarIntegrity(){
    try {
      const msgs = document.querySelectorAll('.msg');
      msgs.forEach(m => {
        let role = m.classList.contains('right') ? 'user' : 'assistant';
        let av = m.querySelector('.avatar');
        if (!av) {
          av = document.createElement('img');
          av.className = 'avatar';
          m.insertBefore(av, m.firstChild);
        }
        const expected = effectiveAvatar(role);
        if (!av.getAttribute('src') || av.getAttribute('src') === '' || av.getAttribute('src') !== expected) {
          av.setAttribute('src', expected);
          av.onerror = function () {
            this.onerror = null;
            this.src = (role === 'assistant') ? defaultAssistant() :
                       (role === 'user') ? defaultUser() :
                       defaultOther(role);
          };
        }
      });
    } catch(e){ console.warn('Avatar hydration failed:', e); }
  }
  setTimeout(enforceAvatarIntegrity, 10);
</script>
  
<!-- V1.9 Export Modal -->
<div id="cg_export_modal" class="cg-modal" aria-hidden="true">
  <div class="cg-mask" data-act="close"></div>
  <div class="cg-card" role="dialog" aria-label="导出">
    <header class="cg-card-hd">
      <strong id="cg_export_title">导出</strong>
      <button class="icon-btn" id="cg_export_close" title="关闭">×</button>
    </header>
    <div class="cg-card-bd">
      <div class="cg-row">
        <div class="lbl">范围</div>
        <div class="val"><div id="cg_export_scope" class="scope-list"></div></div>
      </div>
      <div class="cg-row">
        <div class="lbl">格式</div>
        <div class="val cg-formats">
          <label><input type="checkbox" id="fmt_json" checked/> JSON</label>
          <label><input type="checkbox" id="fmt_md" /> Markdown</label>
          <label><input type="checkbox" id="fmt_txt" /> TXT</label>
        </div>
      </div>
      <details class="cg-adv" open><summary>高级选项</summary>
        <div class="cg-row">
          <div class="lbl">合并导出</div>
          <div class="val"><label><input type="checkbox" id="opt_merge" checked/> 将所选内容合并为单文件</label></div>
        </div>
        <div class="cg-row">
          <div class="lbl">包含元数据</div>
          <div class="val"><label><input type="checkbox" id="opt_meta" /> 在 MD/TXT 中包含时间戳与角色信息</label></div>
        </div>
      </details>
      <div class="cg-hint">提示：未勾选“包含元数据”时，导出文本仅包含<strong>正文</strong>（不含昵称、时间、模型名、星标）。</div>
    </div>
    <footer class="cg-card-ft">
      <button class="btn" id="cg_export_cancel">取消</button>
      <button class="btn primary" id="cg_export_confirm" disabled>确定导出</button>
    </footer>
  </div>
</div>
<style>
/* V1.9 Export Modal */
#cg_export_modal pre,
#cg_export_modal code,
#cg_export_modal .export-preview {
  font-family: "Noto Sans CJK SC","PingFang SC","Microsoft YaHei",
               system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif !important;
  white-space: pre-wrap;
  word-break: break-word;
  letter-spacing: normal;
}
.cg-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;}
.cg-modal.open{display:flex;}
.cg-mask{position:absolute;inset:0;background:rgba(0,0,0,.35);}
.cg-card{position:relative;background:var(--panel-bg, #fff);color:var(--panel-fg,#111);width:min(680px, 92vw);max-height:86vh;overflow:auto;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.25);}
[data-theme="dark"] .cg-card{--panel-bg:#0b1220;--panel-fg:#e5e7eb;}
.cg-card-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(148,163,184,.35);position:sticky;top:0;background:inherit;}
.cg-card-bd{padding:16px;display:flex;flex-direction:column;gap:12px;}
.cg-card-ft{display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid rgba(148,163,184,.25);position:sticky;bottom:0;background:inherit;}
.cg-row{display:grid;grid-template-columns:100px 1fr;gap:8px;align-items:center;}
.cg-row .lbl{color:#64748b;}
.cg-formats{display:flex;gap:16px;flex-wrap:wrap;}
.scope-list{display:flex;flex-direction:column;gap:6px;max-height:40vh;overflow:auto;background:rgba(148,163,184,.08);border:1px dashed rgba(148,163,184,.4);border-radius:10px;padding:8px 10px;}
.scope-item{display:flex;justify-content:space-between;gap:8px;padding:6px 8px;background:rgba(148,163,184,.12);border-radius:8px;}
.scope-item .name{font-weight:600;}
.icon-btn{border:none;background:transparent;font-size:18px;line-height:1;cursor:pointer;color:inherit;}
.btn.primary{background:#2563eb;color:#fff;border-color:#2563eb;}
.cg-adv{margin:6px 0 4px 0;}
.cg-hint{font-size:12px;color:#6b7280;}
</style>
<style>
/* V1.9.5 Export Modal UI polish (UI-only; no behavior changes) */
.cg-adv > summary{ display:none; }             /* hide the fold toggle */
.cg-adv[open]{ display:block; }                /* keep content visible */
.cg-card-bd .cg-row{ margin: 6px 0; }          /* equal vertical spacing for rows */

/* Buttons: rounded gray, consistent size & typography */
.cg-card-ft{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  gap:12px;
  padding:16px;
  justify-content: initial;
  border-top: 1px solid rgba(148,163,184,.25);
  position: sticky;
  bottom: 0;
  background: inherit;
}
.cg-card-ft #cg_export_cancel{ grid-column: 2 / 3; }
.cg-card-ft #cg_export_confirm{ grid-column: 3 / 4; }

.btn{
  background:#F3F4F6;
  color:#111827;
  border:1px solid #E5E7EB;
  border-radius:8px;
  padding:8px 14px;
  line-height:1;
  font-size:14px;
}
.btn.primary{               /* keep class but match the same gray style */
  background:#F3F4F6;
  color:#111827;
  border-color:#E5E7EB;
}
.btn:hover{ background:#E9ECEF; }
.btn:disabled{ opacity:.55; cursor:not-allowed; }

/* Dark theme adjustments */
[data-theme="dark"] .btn{
  background:#1F2937;
  color:#E5E7EB;
  border-color:#374151;
}
[data-theme="dark"] .btn:hover{ background:#374151; }
</style>



<script>
// V1.9 Export: modal orchestration + serializers
(function(){
  const $ = s=>document.querySelector(s);
  const $$ = (s, root)=> Array.from((root||document).querySelectorAll(s));
  
function normalizeTs(t){
  if (t == null || t === '') return null;
  if (typeof t === 'number') return t < 1e12 ? (t * 1000) : t;
  if (typeof t === 'string'){
    var n = Number(t);
    if (!Number.isNaN(n)) return n < 1e12 ? (n * 1000) : n;
    var p = Date.parse(t);
    if (!isNaN(p)) return p;
    return null;
  }
  try{
    var p2 = Date.parse(String(t));
    return isNaN(p2) ? null : p2;
  }catch(e){ return null; }
}


function safePart(name, maxLen){
  try{
    let s = String(name==null?'':name);
    // Remove illegal filename characters, normalize spaces
    s = s.replace(/[\\/:*?"<>|]/g,'').replace(/\s+/g,' ').trim();
    // Collapse dots/ellipses to avoid accidental visual truncation in actual names
    s = s.replace(/\.\.\.+/g,'..');
    if(!s) s = '未命名';
    const MAX = maxLen || 120;
    if(s.length > MAX) s = s.slice(0, MAX);
    return s;
  }catch(e){ return '未命名'; }
}
function fmtExportTime(d){
  try{
    d = d ? new Date(d) : new Date();
    const p = n=> String(n).padStart(2,'0');
    return d.getFullYear() + '-' + p(d.getMonth()+1) + '-' + p(d.getDate()) + '_' + p(d.getHours()) + '-' + p(d.getMinutes());
  }catch(e){ return String(Date.now()); }
}
function fmtTS(t){
    try{
      var ms = normalizeTs(t);
      if (ms == null) return '';
      var d = new Date(ms);
      var p = function(n){ return String(n).padStart(2,'0'); };
      return d.getFullYear() + '-' + p(d.getMonth()+1) + '-' + p(d.getDate()) + ' ' + p(d.getHours()) + ':' + p(d.getMinutes()) + ':' + p(d.getSeconds());
    }catch(e){ return ''; }
  }

function slug(s){ return String(s||'').replace(/[\s\/\\:*?"<>|]+/g,'-').slice(0,64) || 'item'; }

function toMDSection(title, level){ const hash = '#'.repeat(Math.max(1,Math.min(6, level||1))); return `\\n${hash} ${title}\\n\\n`; }



  // Build scope summary
  function buildScope(scope, ids){
    const box = $('#cg_export_scope'); box.innerHTML='';
    const items=[];
    if(scope==='chat'){
      // conversations selectedIds is a Set of conv.id
      const list = ((window.conversations || (typeof conversations!=='undefined'?conversations:[])) || []).filter(c=> ids.has(String(c.id)));
      list.forEach(c=>{
        const counts = (c.messages||[]).length;
        const el = document.createElement('div'); el.className='scope-item';
        el.innerHTML = `<div class="name">${slug(c.title||'未命名会话')}</div><div class="meta">${counts} 条</div>`;
        box.appendChild(el);
        items.push({id:c.id, title:c.title||'会话'});
      });
    
} else if(scope==='notes'){
  // Show selected Notebooks/Pages with robust name resolution (nbStore -> DOM -> fallback)
  const NB = (typeof window.nbStore==='function') ? nbStore() : {notebooks:[], pages:[], entries:[], page_entries:[]};
  const mapNB = new Map((NB.notebooks||[]).map(n=> [String(n.id), n]));
  const mapPG = new Map((NB.pages||[]).map(p=> [String(p.id), p]));

  function findNameInDOM(kind, id){
    // Tolerant selectors for different implementations
    const sel = (kind==='nb')
      ? `[data-nbid="${id}"], .nb-item[data-id="${id}"], .nb-item[data-nb="${id}"]`
      : `[data-pgid="${id}"], .page[data-id="${id}"], .page[data-pg="${id}"]`;
    const host = document.querySelector(sel);
    if(!host) return '';
    const title = host.querySelector('.title, .name, [data-title]');
    return (title && (title.textContent || title.getAttribute('data-title'))) || '';
  }

  (ids||new Set());
  // Normalize: when a notebook is selected, suppress listing its child pages
  const nbSelected = new Set();
  (ids||new Set()).forEach(tk=>{ if(String(tk).startsWith('nb:')) nbSelected.add(String(tk).slice(3)); });
  (ids||new Set()).forEach(tk=>{
    if(tk.startsWith('nb:')){
      const id = tk.slice(3);
      const n = mapNB.get(String(id));
      const name = (n && n.name) || findNameInDOM('nb', id) || `Notebook#${id}`;
      const el = document.createElement('div'); el.className='scope-item';
      el.innerHTML = `<div class="name">📒 ${name}</div><div class="meta">Notebook</div>`;
      box.appendChild(el); items.push({type:'nb', id, name});
    }else if(tk.startsWith('pg:')){
      const id = tk.slice(3);
      const p = mapPG.get(String(id));
      const parentId = p && p.notebook_id ? String(p.notebook_id) : null;
      if(parentId && nbSelected.has(parentId)) return; // suppressed by parent selection
      const name = (p && p.name) || findNameInDOM('pg', id) || `Page#${id}`;
      const el = document.createElement('div'); el.className='scope-item';
      el.innerHTML = `<div class="name">📄 ${name}</div><div class="meta">Page</div>`;
      box.appendChild(el); items.push({type:'pg', id, name});
    }
  });} else if(scope==='bookmarks'){ 
      const el = document.createElement('div'); el.className='scope-item';
      try{
        const count = (STORE && Array.isArray(STORE.bookmarks)) ? STORE.bookmarks.length : 0;
        el.innerHTML = `<div class="name">🔖 书签</div><div class="meta">${count} 条</div>`;
      }catch(_e){ el.innerHTML = `<div class="name">🔖 书签</div><div class="meta">0 条</div>`; }
      box.appendChild(el); items.push({type:'bm'});
    }
    // enable confirm if there is any item & any format ticked
    const fmtOk = ( $('#fmt_json').checked || $('#fmt_md').checked || $('#fmt_txt').checked );
    $('#cg_export_confirm').disabled = items.length===0 || !fmtOk;
  }

  function openExportModal(payload){
    const {scope, ids} = payload || {};
    const modal = $('#cg_export_modal');
    
    /* v2.9.26: lift export modal to very top */
    try{
      if(modal && document && document.body){
        if(modal.parentElement !== document.body || document.body.lastElementChild !== modal){
          document.body.appendChild(modal);
        }
        modal.style.zIndex = '2147483647';
      }
    }catch(_e){}
modal.dataset.scope = scope;
    // mark selection for confirmation gating
    modal.__ids = ids;
    $('#fmt_json').checked = false;
    $('#fmt_md').checked = false;
    $('#fmt_txt').checked = true;
    $('#opt_merge').checked = false;
    $('#opt_meta').checked = true;

    // V2.9.3: notes-only minimal modal (hide JSON/merge/meta and their hint)
    try{
      const jsonLabel = $('#fmt_json') && $('#fmt_json').closest('label');
      const mergeRow = $('#opt_merge') && $('#opt_merge').closest('.cg-row');
      const metaRow  = $('#opt_meta') && $('#opt_meta').closest('.cg-row');
      const hint     = modal.querySelector('.cg-hint');
      if(scope==='notes'){
        if($('#fmt_json')) $('#fmt_json').checked = false;
        if($('#fmt_md'))   $('#fmt_md').checked = true;   // ensure at least one format
        if($('#fmt_txt'))  $('#fmt_txt').checked = false;
        if($('#opt_merge')) $('#opt_merge').checked = false;
        if($('#opt_meta'))  $('#opt_meta').checked = false;
        if(jsonLabel) jsonLabel.style.display = 'none';
        if(mergeRow)  mergeRow.style.display  = 'none';
        if(metaRow)   metaRow.style.display   = 'none';
        if(hint)      hint.style.display      = 'none';
      }else{
        if(jsonLabel) jsonLabel.style.display = '';
        if(mergeRow)  mergeRow.style.display  = '';
        if(metaRow)   metaRow.style.display   = '';
        if(hint)      hint.style.display      = '';
      }
    }catch(e){ console.warn('V2.9.3 modal trim failed', e); }
    $('#cg_export_title').textContent = (scope==='chat') ? '导出 对话' : (scope==='notes' ? '导出 笔记' : '导出 书签');
    buildScope(scope, ids);
    modal.classList.add('open');
    modal.setAttribute('aria-hidden','false');
  
    
    /* v2.9.25: A11y & focus management on open */
    try{
      // remove inert if previously set
      modal.removeAttribute('inert');
      // store previously focused element to restore on close
      modal.__prevFocus = (document.activeElement && document.activeElement !== document.body) ? document.activeElement : null;
      // move focus into the dialog
      setTimeout(function(){
        try{
          var focusable = modal.querySelector('#cg_export_confirm') 
                       || modal.querySelector('#cg_export_close') 
                       || modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
          if(focusable && focusable.focus) focusable.focus();
        }catch(_e){}
      }, 0);
    }catch(_e){}
/* v2.9.24: mobile sizing for export modal */
    try{
      const card = modal.querySelector('.cg-card');
      const hd = modal.querySelector('.cg-card-hd');
      const bd = modal.querySelector('.cg-card-bd');
      const ft = modal.querySelector('.cg-card-ft');
      function __fitExportModal(){
        try{
          var isMobile = (window.matchMedia ? window.matchMedia('(max-width: 900px)').matches : ((window.innerWidth||1000) <= 900));
          if(!card) return;
          if(isMobile){
            card.style.maxWidth = '96vw';
            card.style.width = '96vw';
            var vmax = Math.floor((window.innerHeight||600) * 0.9);
            card.style.maxHeight = vmax + 'px';
            if(bd){
              var top = hd ? hd.offsetHeight : 0;
              var bottom = ft ? ft.offsetHeight : 0;
              var avail = vmax - top - bottom - 16;
              if(avail < 120) avail = 120;
              bd.style.maxHeight = avail + 'px';
              bd.style.overflow = 'auto';
              bd.style.webkitOverflowScrolling = 'touch';
            }
          }else{
            card.style.maxWidth = '720px';
            card.style.width = '';
            card.style.maxHeight = '';
            if(bd){ bd.style.maxHeight = ''; bd.style.overflow = ''; }
          }
        }catch(_e){}
      }
      __fitExportModal();
      modal.__fitHandler = __fitExportModal;
      window.addEventListener('resize', __fitExportModal, {passive:true});
    }catch(_e){}
}

  function closeExportModal(){
    const modal = $('#cg_export_modal');
    
    /* v2.9.25: A11y & focus management on close */
    try{
      // prevent focus inside
      modal.setAttribute('inert','');
      // if focus is inside dialog, move it out before aria-hidden
      if (modal.contains(document.activeElement)) {
        var target = modal.__prevFocus && document.contains(modal.__prevFocus) ? modal.__prevFocus 
                    : (document.getElementById('cg_hamburger') || document.querySelector('main, #main, body'));
        if(target && target.focus){
          // ensure body target is focusable if needed
          if(target === document.body){ try{ document.body.setAttribute('tabindex','-1'); }catch(_e){} }
          try{ target.focus(); }catch(_e){}
          if(target === document.body){ try{ document.body.removeAttribute('tabindex'); }catch(_e){} }
        }
      }
    }catch(_e){}
modal.classList.remove('open');
    modal.setAttribute('aria-hidden','true');
    try{ if(modal.__fitHandler){ window.removeEventListener('resize', modal.__fitHandler); modal.__fitHandler=null; } }catch(_e){}

    modal.__ids = null;
  }

  // Wire modal events
  (function(){
    const modal = $('#cg_export_modal');
    $('#cg_export_close').onclick = closeExportModal;
    $('#cg_export_cancel').onclick = closeExportModal;
    modal.addEventListener('click', (e)=>{ if(e.target.classList.contains('cg-mask')) closeExportModal(); });
    // enable/disable confirm on format change
    ['fmt_json','fmt_md','fmt_txt'].forEach(id=>{
      const el = $('#'+id); if(el){ el.onchange = ()=> buildScope(modal.dataset.scope, modal.__ids); }
    });
    $('#cg_export_confirm').onclick = async ()=>{
      const scope = modal.dataset.scope;
      const ids = modal.__ids;
      const formats = { json: $('#fmt_json').checked, md: $('#fmt_md').checked, txt: $('#fmt_txt').checked };
      const options = { merge: $('#opt_merge').checked, meta: $('#opt_meta').checked };
      try{
        if(scope==='chat'){ await doExportChats(ids, formats, options); }
        else if(scope==='notes'){ await doExportNotes(ids, formats, options); }
        else { await doExportBookmarks(formats, options); }
      }catch(err){
        console.error('export failed:', err);
        alert('导出失败：' + (err && err.message || err));
      }finally{ closeExportModal(); }
    };
  })();

  
  // Bookmarks export (JSON only; uses existing drawer exporter)
  async function doExportBookmarks(formats, opt){
    // For now we only support JSON for bookmarks; ignore md/txt options
    try{
      if(formats && (formats.json || formats.md || formats.txt)){
        // Reuse existing drawer/exporter implementation
        if(typeof exportAll === 'function'){
          exportAll();
          return;
        }
      }
      // Fallback: minimal JSON blob from STORE
      const payload = { version: (window.__BUILD_META && __BUILD_META.version) || 'V1.9.4', exportedAt: new Date().toISOString(), ...STORE };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      const now = new Date(); const stamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
      a.href = URL.createObjectURL(blob);
      a.download = `bookmarks_${stamp}.json`;
      document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1500);
    }catch(e){
      console.error('doExportBookmarks failed', e);
      throw e;
    }
  }

// Normalize newline for export (Windows-friendly)
function toCRLF(s){
  try{ return String(s||'').replace(/\r?\n/g, '\r\n'); }catch(e){ return String(s||''); }
}
// ===== Serializers =====
  
function cleanText(raw){
  try{
    let t = String(raw ?? '');

    // 1) Decode basic HTML entities (minimal set we actually see)
    t = t.replace(/&nbsp;/gi, ' ')
         .replace(/&lt;/gi, '<')
         .replace(/&gt;/gi, '>')
         .replace(/&amp;/gi, '&');

    // 2) Unescape literal newlines first (already done in unescapeNL, but keep idempotent)
    t = t.replace(/\\r\\n/g,'\n').replace(/\\n/g,'\n').replace(/\\r/g,'\n');

    // 3) Normalize exotic line separators to \n
    t = t.replace(/[\u2028\u2029]/g, '\n');

    // 4) Remove UTF-8 BOM and zero-width / joiner characters that常导致“空格感”
    t = t.replace(/[\ufeff\u200b-\u200f\u2060\u2061\u2062\u2063]/g, '');
    // 4.1 额外去除少见但会“把中文渲染成大片空白”的控制符
    // ① 双向嵌入/覆盖：LRE,RLE,LRO,RLO,PDF
    t = t.replace(/[\u202A\u202B\u202D\u202E\u202C]/g, '');
    // ② 双向隔离：LRI,RLI,FSI,PDI
    t = t.replace(/[\u2066\u2067\u2068\u2069]/g, '');
    // ③ 软连字符 SHY（不少查看器里会造成诡异断行/空白）
    t = t.replace(/\u00AD/g, '');

    // 5) Remove C0 控制字符（保留 \n\t），避免被渲染为空格或方框
    t = t.replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F]/g, '');

    // 6) 把不换行空格统一成普通空格（避免奇怪对齐）
    t = t.replace(/\u00A0/g, ' ').replace(/\u202F/g,' ').replace(/\u3000/g,' ');

    return t;
  }catch(e){
    return String(raw ?? '');
  }
}

// Gather strings recursively from nested structures (arrays/objects)
// depth-limited to avoid cycles
function pluckTextDeep(node, depth=0, out){
  out = out || [];
  if (depth > 5) return out;
  if (node == null) return out;
  const t = typeof node;
  if (t === 'string') { out.push(node); return out; }
  if (t === 'number' || t === 'boolean') { out.push(String(node)); return out; }
  if (Array.isArray(node)) {
    for (let i=0;i<node.length;i++) pluckTextDeep(node[i], depth+1, out);
    return out;
  }
  if (t === 'object') {
    // Prefer common text-like keys first
    const keys = ['text','content','value','string_value','utf8','message','body','data'];
    for (let k of keys) if (k in node) pluckTextDeep(node[k], depth+1, out);
    // Fallback: traverse other enumerable props
    for (let k in node) if (!keys.includes(k)) pluckTextDeep(node[k], depth+1, out);
    return out;
  }
  return out;
}
// Heuristic blank check (tolerates exotic spaces)
function isBlankish(s){
  if (s == null) return true;
  try{
    const stripped = String(s).replace(/[\s\u00A0\u202F\u3000\u2000-\u200F\u2060-\u2063\uFEFF]/g,'').trim();
    return stripped.length === 0;
  }catch(e){ return false; }
}
function extractPlainText(m){
  function unescapeNL(x){ return String(x||'').replace(/\\r\\n/g,'\n').replace(/\\n/g,'\n').replace(/\\r/g,'\n'); }
  try{
    let raw = '';
    if(typeof m === 'string') raw = m;
    else if(m && typeof m.content === 'string') raw = m.content;
    else if(m && m.content && Array.isArray(m.content.parts)) raw = m.content.parts.join('\n');
    else if(Array.isArray(m && m.contents)) raw = pluckTextDeep(m.contents).join('\n');
    else if(typeof m.text === 'string') raw = m.text;
    else raw = pluckTextDeep(m).join('\n');

    raw = cleanText(unescapeNL(raw));

    // Fallback: if text is still blankish, try a deeper pluck and final escape
    if(isBlankish(raw)){
      const plucked = pluckTextDeep(m).join('\n');
      raw = cleanText(unescapeNL(plucked));
    }
    return raw;
  }catch(e){
    try{ return cleanText(unescapeNL(String(m && (m.text||m.content)||''))); }catch(_){ return ''; }
  }
}

async function doExportChats(idSet, formats, opt){
  const __tasks__ = [];
  const __pushTask__ = (format, filename, blob)=>{ __tasks__.push({format, filename, blob}); };

  const ids = Array.from(idSet||[]).map(String);
  const __src = (window.conversations || (typeof conversations!=='undefined'?conversations:[])) || [];
  const list = __src.filter(c=> ids.includes(String(c.id)));
  const now = new Date(); const stamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;

  const makeTitle = (c, i)=> (c.title || `会话${i+1}`);

  // Helper: build text for one conv
  const mkOneText = (c, asMD)=>{
    let out='';
    const title = makeTitle(c, 0);
    if(asMD) out += toMDSection(title, 1);
    else out += `【${title}】` + "\n\n";
    (c.messages||[]).forEach(m=>{
      const body = extractPlainText(m);
      if(!opt.meta){
        out += body + "\n\n";
      } else {
        const head = asMD
          ? `> [${m.role||''} | ${fmtTS(m.createdAt||m.ts||'')}]` + "\n"
          : `[${m.role||''} ${fmtTS(m.createdAt||m.ts||'')}]` + "\n";
        out += head + body + "\n\n";
      }
    });
    return out;
  };

  if(list.length===0){ alert('没有找到可导出的会话，请检查是否已选择会话。'); return; }
  if(opt.merge){
    const base = `chat-selected-${stamp}`;
    if(formats.json){
      const obj = { meta:{ version:(window.__BUILD_META__&&window.__BUILD_META__.ver)||'1.9', exportedAt: new Date().toISOString(), scope:'chat' },
                    items: list.map(c=> ({ id:c.id, title:c.title||'', messages:(c.messages||[]).map(m=> ({ role:m.role, content:extractPlainText(m), createdAt:m.createdAt||m.ts||'', category:m.category||'dialogue', model:m.model||'' })) })) };
      __pushTask__('json', `${base}.json`, new Blob([JSON.stringify(obj,null,2)], {type:'application/json;charset=utf-8'}));
    }
    if(formats.md){
      let out=''; list.forEach((c,i)=>{ out += mkOneText(c,true); });
      __pushTask__('md', `${base}.md`, new Blob([toCRLF(out)], {type:'text/markdown;charset=utf-8'}));
    }
    if(formats.txt){
      let out=''; list.forEach((c,i)=>{ out += mkOneText(c,false); });
      __pushTask__('txt', `${base}.txt`, new Blob([new Uint8Array([0xEF,0xBB,0xBF]), toCRLF(out)], {type:'text/plain;charset=utf-8'}));
    }
  }else{
    // separate files
    list.forEach((c,i)=>{
      const base = `chat-${slug(makeTitle(c,i))}-${stamp}`;
      if(formats.json){
        const obj = { meta:{ version:(window.__BUILD_META__&&window.__BUILD_META__.ver)||'1.9', exportedAt: new Date().toISOString(), scope:'chat' },
                      item: { id:c.id, title:c.title||'', messages:(c.messages||[]).map(m=> ({ role:m.role, content:extractPlainText(m), createdAt:m.createdAt||m.ts||'', category:m.category||'dialogue', model:m.model||'' })) } };
        __pushTask__('json', `${base}.json`, new Blob([JSON.stringify(obj,null,2)], {type:'application/json;charset=utf-8'}));
      }
      if(formats.md){
        __pushTask__('md', `${base}.md`, new Blob([toCRLF(mkOneText(c,true))], {type:'text/markdown;charset=utf-8'}));
      }
      if(formats.txt){
        __pushTask__('txt', `${base}.txt`, new Blob([new Uint8Array([0xEF,0xBB,0xBF]), toCRLF(mkOneText(c,false))], {type:'text/plain;charset=utf-8'}));
      }
    });
  }

  await finalizeDownloads(__tasks__, 'chats');
}


// Serializer for a single note page (self-contained)
const mkNoteText = (p, asMD)=>{
  const nbName = (p && (p.notebookName||'')) || '笔记本';
  const pageName = (p && (p.name||p.title||'')) || '页面';
  const msgs = Array.isArray(p && p.messages) ? p.messages : [];
  const texts = msgs.map(m=> extractPlainText(m));
  const charCount = texts.reduce((n,t)=> n + (t?String(t).length:0), 0);
  let firstTs = null, lastTs = null;
  for (const m of msgs){
    const t = (m && (m.ts||m.createdAt||m.time));
    if (t!=null){
      const ms = normalizeTs(t);
      if (ms!=null){
        if (firstTs==null || ms < firstTs) firstTs = ms;
        if (lastTs==null || ms > lastTs) lastTs = ms;
      }
    }
  }
  const firstTimeStr = firstTs ? fmtTS(firstTs) : '';
  const headLine = `${nbName}#${pageName}`.trim();
  const statsLine = `${msgs.length} 条 · ${charCount} 字符` + (firstTimeStr?` 首条时间：${firstTimeStr}`:'');

  let out = '';
  if (asMD){
    out += toMDSection(headLine || '笔记', 1);
    out += `> ${statsLine}\n\n`;
  }else{
    out += `【${headLine||'笔记'}】\n${statsLine}\n\n`;
  }

  if (msgs.length){
    msgs.forEach(m=>{
      const role = (m && (m.role||m.author||'')).trim();
      const model = (m && (m.model||m.engine||'')) ? String(m.model||m.engine) : '';
      const ts = fmtTS(m && (m.createdAt||m.ts||m.time));
      const prefix = asMD ? `**${role||'Note'}** · ${ts}${model?` · ${model}`:''}`
                          : `${role||'Note'}·${ts}${model?`· ${model}`:''}`;
      const body = extractPlainText(m);
      out += prefix + "\n\n" + body + "\n\n"; // one blank line between header and body, and one after body
    });
  }else{
    
    // Robust DOM fallback: only read the visible **notes right pane**.
    // We deliberately restrict the scraping scope to #cg_nb_stage .nb-right to avoid grabbing chat/nav.
    try{
      const stage = document.querySelector('#cg_nb_stage');
      const q = (sel) => stage ? stage.querySelector(sel) : document.querySelector(sel);

      // Candidate roots ordered by likelihood, all resolved **within stage** when possible
      const candidates = [];
      if(p && p.id){
        candidates.push(`[data-page-id="${p.id}"]`);
        candidates.push(`.page[data-page-id="${p.id}"]`);
        candidates.push(`.page[data-id="${p.id}"]`);
      }
      candidates.push('.nb-right .page');
      candidates.push('.nb-right');
      candidates.push('.notes-main .page');
      candidates.push('.notes-main');
      candidates.push('.nb-content .page');
      candidates.push('.nb-content');

      let root = null;
      for(const sel of candidates){
        const n = q(sel);
        if(n){ root = n; break; }
      }
      if(!root){
        // Last-chance: clamp to the stage (never to the whole body)
        root = stage ? (stage.querySelector('.nb-right') || stage) : document.querySelector('#cg_nb_stage') || document.body;
      }

      // Reject sidebars/menus even if they appear under stage
      const denyMatches = (el)=>{
        if(!el || el.nodeType!==1) return false;
        const cls = (el.className||'')+'';
        const id  = (el.id||'')+'';
        const role = (el.getAttribute && el.getAttribute('role')) || '';
        const denyClass = /(\bnav\b|\bsidebar\b|\bnb-left\b|\btree\b|\btoolbar\b|\bmenu\b|\bheader\b)/i.test(cls);
        const denyId = /(cg_nb_tree|cg_nb_toolbar|chat)/i.test(id);
        const denyRole = /^(navigation|menu|toolbar|complementary)$/i.test(role||'');
        return denyClass || denyId || denyRole;
      };

      const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
        acceptNode(node){
          const text = node.nodeValue||'';
          if(!text.trim()) return NodeFilter.FILTER_REJECT;
          let el = node.parentElement;
          while(el){
            if(denyMatches(el)) return NodeFilter.FILTER_REJECT;
            el = el.parentElement;
          }
          return NodeFilter.FILTER_ACCEPT;
        }
      });
      const parts = [];
      let current;
      while(current = walker.nextNode()){
        parts.push(current.nodeValue);
      }
      let txt = parts.join('\n');
      txt = txt.replace(/\r/g,'').replace(/[\t\x0B\x0C ]+/g,' ').replace(/\n{3,}/g,'\n\n').trim();
      // Insert a blank line between dialogue groups: add one before each header line and after header line
      (function(){
        const lines = txt.split('\n');
        const outLines = [];
        const isHeader = (line)=>{
          const l = line.trim();
          if(!l) return false;
          // Match patterns like "Assistant·2025-.." or "You·2025-.." (allow variations)
          return /^(Assistant|You|User|系统|注释|助手|Tool|工具)[·\s].*\d{4}-\d{2}-\d{2}/.test(l) || (/^(Assistant|You|User|助手|Tool|工具)/.test(l) && /\d{4}-\d{2}-\d{2}|★/.test(l));
        };
        for(let i=0;i<lines.length;i++){
          const line = lines[i];
          if(isHeader(line)){
            if(outLines.length>0 && outLines[outLines.length-1] !== '') outLines.push(''); // blank line before new group
            outLines.push(line);
            if(lines[i+1]!==undefined && lines[i+1] !== '') outLines.push(''); // blank line between header and body
          }else{
            outLines.push(line);
          }
        }
        txt = outLines.join('\n').replace(/\n{3,}/g,'\n\n');
      })();
      out += (txt ? String(txt) : '（未加载正文）') + "\n\n";
    }catch(e){
      out += "（未加载正文）\n\n";
    }
  }
  return out;
};;;;
async function doExportNotes(idSet, formats, opt){
  // Normalize formats into iterable list (compat: object {json,md,txt} or array)
  const fmtList = Array.isArray(formats) ? formats :
                  Object.keys(formats||{}).filter(k => !!(formats&&formats[k]));

  const tasks = [];
  const pushTask = (format, filename, blob)=> tasks.push({format, filename, blob});

  // Normalize store
  const NB0 = (typeof window.nbStore==='function') ? (nbStore()||{}) : (window.NB||{});
  const NB = {
    notebooks: Array.isArray(NB0.notebooks)? NB0.notebooks : [],
    pages: Array.isArray(NB0.pages)? NB0.pages : [],
    entries: Array.isArray(NB0.entries)? NB0.entries : [],
    page_entries: Array.isArray(NB0.page_entries)? NB0.page_entries : [],
    annotations: Array.isArray(NB0.annotations)? NB0.annotations : []
  };
  const mapNB = new Map((NB.notebooks||[]).map(n=> [String(n.id),n]));
  const mapPG = new Map((NB.pages||[]).map(p=> [String(p.id),p]));
  const entriesById = new Map((NB.entries||[]).map(e=> [String(e.id),e]));
  const linksByPage = (NB.page_entries||[]).reduce((acc,pe)=>{ const k=String(pe.page_id); (acc[k]||(acc[k]=[])).push(pe); return acc; }, {});

  // --- V2.9.2 NOTE→PAGE normalization shim ---
  // Treat each notebook as having exactly one default page; create if missing.
  function __ensureDefaultPage(nbid){
    nbid = String(nbid);
    let pg = (NB.pages||[]).find(p => String(p.notebook_id)===nbid);
    if(!pg){
      const pid = (typeof uid==='function') ? uid('pg') : ('pg-'+Date.now()+Math.random().toString(36).slice(2,8));
      pg = { id: pid, notebook_id: nbid, name: '默认页', order: 1, created_at: Date.now(), updated_at: Date.now() };
      (NB.pages = NB.pages || []).push(pg);
      try{ mapPG.set(String(pg.id), pg); }catch(_){}
      try{ if(typeof nbSave==='function') nbSave(NB); }catch(_){}
    }
    return String(pg.id);
  }

  // Selection normalization
  const tokens = Array.from(idSet||[]).map(String);
  const selectedNBs = new Set();
  const selectedPages = new Set();
  for(const tk of tokens){
    if(tk.startsWith('nb:')) selectedNBs.add(tk.slice(3));
    else if(tk.startsWith('pg:')) selectedPages.add(tk.slice(3));
  }
  // Expand notebooks -> all pages; remove child pages duplicates
  const finalPageIds = new Set();
  if(selectedNBs.size>0){
    // Ensure each selected notebook has a default page (create if missing)
    selectedNBs.forEach(nbid => {
      const pid = __ensureDefaultPage(nbid);
      finalPageIds.add(String(pid));
    });
    // Also include any additional pages already present under these notebooks
    for(const p of NB.pages||[]){
      if(p && selectedNBs.has(String(p.notebook_id))) finalPageIds.add(String(p.id));
    }
  }
  // add standalone pages not covered by selected notebooks
  for(const pid of selectedPages){
    const pg = mapPG.get(String(pid));
    if(!pg || !selectedNBs.has(String(pg.notebook_id))) finalPageIds.add(String(pid));
  }
  if(finalPageIds.size===0){
    alert('没有找到可导出的页面/笔记，请检查选择。'); 
    return;
  }

  // Build per-page rich object
    // Helper: resolve notebook display name (store → DOM → fallback)
    function resolveNotebookName(nbid){
    // 1) 首选数据存储（nbStore）
    const n = mapNB.get(String(nbid)) || {};
    const t = (n.name || n.title || '').trim();
    if (t) return t;

    // 2) 退化读取 DOM（兼容多种实现的容器/类名）
    try{
      const el = document.querySelector(
        `[data-nbid="${nbid}"] .title, 
         [data-nbid="${nbid}"] .name, 
         .nb-item[data-id="${nbid}"] .title, 
         .nb-item[data-nb="${nbid}"] .title`
      );
      const s = (el && el.textContent ? el.textContent.trim() : '') || '';
      if (s) return s;
    }catch(_){}
    // 3) 兜底
    return '笔记本';
  }

  const pages = [];
  for(const pid of finalPageIds){
    const p0 = mapPG.get(String(pid)) || {id: pid};
    const nb = mapNB.get(String(p0.notebook_id)) || {};
    const links = linksByPage[String(pid)]||[];
    const msgs = [];
    // Try entries linked to this page
    for(const pe of links){
      const e = entriesById.get(String(pe.entry_id));
      if(!e) continue;
      const m = {
        role: e.role || e.author || '',
        model: e.model || e.engine || '',
        ts: e.ts || e.createdAt || e.time || e.timestamp || null,
        text: e.text || e.content || e.body || ''
      };
      // normalize message object for extractPlainText
      m.content = (typeof m.text==='string') ? m.text : (m.content||m.text||'');
      msgs.push(m);
    }
    // fallback to page.messages if exists
    if(Array.isArray(p0.messages) && p0.messages.length && msgs.length===0){
      for(const m of p0.messages) msgs.push(m);
    }
    pages.push({
      id: p0.id, 
      name: p0.name || p0.title || ('页面-'+String(p0.id)),
      notebook_id: p0.notebook_id,
      notebookName: resolveNotebookName(p0.notebook_id),
      messages: msgs
    });
  }

  // Naming helpers
  const stamp = fmtExportTime(new Date());
  function nameForSingle(p, ext){
    const nb = safePart(p.notebookName, 60);
    return nb + ' & ' + stamp + '.' + ext;
  }
  function nameForMerged(pages, nbName, ext){
    const nb = safePart(nbName||'多本笔记', 60);
    const names = (pages||[]).map(p => safePart(p && (p.name||p.title||'未命名'), 40)).filter(Boolean);
    const head = names.slice(0, 3).join('#');
    const more = names.length > 3 ? `# +${names.length-3}` : '';
    const list = head ? `#${head}${more}` : '#全部页';
    return `${nb}${list} & ${stamp}.${ext}`;
  }

  // Group by notebook for merged naming

  const byNB = new Map();
  for(const p of pages){
    const key = String(p.notebook_id||'unknown');
    if(!byNB.has(key)) byNB.set(key, {name: p.notebookName, items: []});
    byNB.get(key).items.push(p);
  }

  // Emit tasks
  const needMerge = !!opt && !!opt.merge;
  for(const fmt of fmtList){
    if(needMerge){
      // merge per notebook (if multiple notebooks selected, produce one file per notebook)
      for(const [nbid, grp] of byNB){
        const items = grp.items;
        const nbName = grp.name || '笔记本';
        if(fmt==='json'){
          const payload = {
            type:'notebook',
            notebook: { id: String(nbid), name: nbName },
            exportedAt: new Date().toISOString(),
            pages: items.map(p=>{
              const msgs = Array.isArray(p && p.messages) ? p.messages : [];
              let charCount = 0;
              let firstTs = null, lastTs = null;
              for(const m of msgs){
                const body = extractPlainText(m) || '';
                charCount += String(body).length;
                const t = m && (m.ts||m.createdAt||m.time);
                if(t!=null){
                  const ms = normalizeTs(t);
                  if(ms!=null){
                    if(firstTs==null || ms < firstTs) firstTs = ms;
                    if(lastTs==null || ms > lastTs) lastTs = ms;
                  }
                }
              }
              return {
                id: p.id,
                name: p.name,
                stats: {
                  messageCount: msgs.length,
                  charCount,
                  firstTs: firstTs? fmtTS(firstTs): '',
                  lastTs: lastTs? fmtTS(lastTs): '',
                  annotations: 0
                }
              };
            })
          };
          const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json;charset=utf-8'});
          pushTask('json', nameForMerged(items, nbName, 'json'), blob);
        }else{
          const asMD = (fmt==='md');
          const joined = items.map(p=> mkNoteText(p, asMD)).join("\n\n");
          const blob = new Blob([asMD? toCRLF(joined) : new Uint8Array([0xEF,0xBB,0xBF]), asMD? '' : toCRLF(joined)], {type: asMD? 'text/markdown;charset=utf-8' : 'text/plain;charset=utf-8'});
          pushTask(fmt, nameForMerged(items, nbName, fmt), blob);
        }
      }
    }else{
      // not merged: one file per page
      for(const p of pages){
        if(fmt==='json'){
          const msgs = Array.isArray(p && p.messages) ? p.messages : [];
          let charCount = 0;
          let firstTs = null, lastTs = null;
          for(const m of msgs){
            const body = extractPlainText(m) || '';
            charCount += String(body).length;
            const t = m && (m.ts||m.createdAt||m.time);
            if(t!=null){
              const ms = normalizeTs(t);
              if(ms!=null){
                if(firstTs==null || ms < firstTs) firstTs = ms;
                if(lastTs==null || ms > lastTs) lastTs = ms;
              }
            }
          }
          const payload = {
            type:'page',
            notebook: { name: p.notebookName },
            page: { id: p.id, name: p.name },
            exportedAt: new Date().toISOString(),
            stats: {
              messageCount: msgs.length,
              charCount,
              firstTs: firstTs? fmtTS(firstTs): '',
              lastTs: lastTs? fmtTS(lastTs): '',
              annotations: 0
            }
          };
          const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json;charset=utf-8'});
          pushTask('json', nameForSingle(p, 'json'), blob);
        }else{
          const asMD = (fmt==='md');
          const text = mkNoteText(p, asMD);
          const blob = new Blob([asMD? toCRLF(text) : new Uint8Array([0xEF,0xBB,0xBF]), asMD? '' : toCRLF(text)], {type: asMD? 'text/markdown;charset=utf-8' : 'text/plain;charset=utf-8'});
          pushTask(fmt, nameForSingle(p, fmt), blob);
        }
      }
    }
  }

  // Kick off downloads (auto zip if multiple)
  await finalizeDownloads(tasks, 'notes');
}
function triggerDownload(filename, blob){
    const a=document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=> { URL.revokeObjectURL(a.href); a.remove(); }, 800);
  }

  
// ===== ZIP packaging helpers (V1.9.6, UI-neutral) =====
async function finalizeDownloads(tasks, zipBaseName){
  try{
    if(!Array.isArray(tasks) || tasks.length===0) return;
    if(tasks.length===1){
      const t = tasks[0];
      triggerDownload(t.filename, t.blob);
      return;
    }
    // Decide grouping rules
    const fmtCount = tasks.reduce((acc,t)=>{ acc[t.format]=(acc[t.format]||0)+1; return acc; }, {});
    const formats = Object.keys(fmtCount);
    const multipleFormats = formats.length>=2;
    const anyFormatHasMany = formats.some(f=> fmtCount[f]>1);
    const useFolders = multipleFormats && anyFormatHasMany; // 多格式且每种格式存在多文件 -> 用文件夹

    // Build zip entries [{name, data(Uint8Array)}]
    const enc = new TextEncoder();
    const entries = [];
    for(const t of tasks){
      const ab = await t.blob.arrayBuffer();
      const data = new Uint8Array(ab);
      const dir = useFolders ? (t.format + '/') : '';
      entries.push({ name: dir + t.filename, data });
    }
    const zipBlob = makeZip(entries);
    const now = new Date();
    const stamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
    const zipName = `${zipBaseName||'export'}_${stamp}.zip`;
    triggerDownload(zipName, zipBlob);
  }catch(err){
    console.error('zip failed, fallback to multi-file downloads', err);
    try{
      for(const t of tasks){ triggerDownload(t.filename, t.blob); }
    }catch(_){ /* ignore */ }
  }
}

// Minimal ZIP builder (STORE mode, no compression). Names must be ASCII-safe.
function makeZip(fileEntries){
  // CRC32
  const crcTable = (function(){
    let c, table = new Uint32Array(256);
    for (let n = 0; n < 256; n++) {
      c = n;
      for (let k = 0; k < 8; k++) { c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1); }
      table[n] = c >>> 0;
    }
    return table;
  })();
  function crc32(u8){
    let crc = 0 ^ (-1);
    for(let i=0;i<u8.length;i++){ crc = (crc >>> 8) ^ crcTable[(crc ^ u8[i]) & 0xFF]; }
    return (crc ^ (-1)) >>> 0;
  }
  function dosDate(dt){
    const year = dt.getFullYear() - 1980;
    const month = dt.getMonth() + 1;
    const day = dt.getDate();
    const time = (dt.getHours() << 11) | (dt.getMinutes() << 5) | (Math.floor(dt.getSeconds()/2));
    const date = (year << 9) | (month << 5) | day;
    return {time, date};
  }
  function strToU8(str){
    return new TextEncoder().encode(str);
  }
  const files = fileEntries;
  const now = new Date();
  const {time:modTime, date:modDate} = dosDate(now);
  let totalSize = 0;
  const fileRecords = [];
  // Build local file headers + data
  const localParts = [];
  for(const f of files){
    const nameBytes = strToU8(f.name);
    const data = f.data instanceof Uint8Array ? f.data : strToU8(String(f.data||''));
    const crc = crc32(data);
    const localHeader = new Uint8Array(30 + nameBytes.length);
    const dv = new DataView(localHeader.buffer);
    let o=0;
    dv.setUint32(o, 0x04034b50, true); o+=4;          // local file header signature
    dv.setUint16(o, 20, true); o+=2;                  // version needed
    dv.setUint16(o, 0x0800, true); o+=2;              // general purpose bit flag (UTF-8 filenames)
    dv.setUint16(o, 0, true); o+=2;                   // compression method (0=store)
    dv.setUint16(o, modTime, true); o+=2;             // last mod file time
    dv.setUint16(o, modDate, true); o+=2;             // last mod file date
    dv.setUint32(o, crc, true); o+=4;                 // crc-32
    dv.setUint32(o, data.length, true); o+=4;         // compressed size
    dv.setUint32(o, data.length, true); o+=4;         // uncompressed size
    dv.setUint16(o, nameBytes.length, true); o+=2;    // file name length
    dv.setUint16(o, 0, true); o+=2;                   // extra field length
    localHeader.set(nameBytes, 30);
    const offset = totalSize;
    totalSize += localHeader.length + data.length;
    localParts.push(localHeader, nameBytes, data);    // note: nameBytes already in header, added again harmlessly? fix: remove duplicate
    // Actually we already placed name in header. Do not push nameBytes again.
  }
  // Correct the above: rebuild properly
  totalSize = 0;
  localParts.length = 0;
  fileRecords.length = 0;
  for(const f of files){
    const nameBytes = strToU8(f.name);
    const data = f.data instanceof Uint8Array ? f.data : strToU8(String(f.data||''));
    const crc = crc32(data);
    const localHeader = new Uint8Array(30 + nameBytes.length);
    const dv = new DataView(localHeader.buffer);
    let o=0;
    dv.setUint32(o, 0x04034b50, true); o+=4;
    dv.setUint16(o, 20, true); o+=2;
    dv.setUint16(o, 0, true); o+=2;
    dv.setUint16(o, 0, true); o+=2;
    const now2 = new Date();
    const d2 = dosDate(now2);
    dv.setUint16(o, d2.time, true); o+=2;
    dv.setUint16(o, d2.date, true); o+=2;
    dv.setUint32(o, crc, true); o+=4;
    dv.setUint32(o, data.length, true); o+=4;
    dv.setUint32(o, data.length, true); o+=4;
    dv.setUint16(o, nameBytes.length, true); o+=2;
    dv.setUint16(o, 0, true); o+=2;
    localHeader.set(nameBytes, 30);
    const localOffset = totalSize;
    totalSize += localHeader.length + data.length;
    localParts.push(localHeader, data);
    // Record for central directory
    fileRecords.push({nameBytes, crc, size:data.length, offset:localOffset, modTime:d2.time, modDate:d2.date});
  }
  // Build central directory
  const centralParts = [];
  let centralSize = 0;
  for(const r of fileRecords){
    const centralHeader = new Uint8Array(46 + r.nameBytes.length);
    const dv2 = new DataView(centralHeader.buffer);
    let p=0;
    dv2.setUint32(p, 0x02014b50, true); p+=4;   // central file header signature
    dv2.setUint16(p, 20, true); p+=2;           // version made by
    dv2.setUint16(p, 20, true); p+=2;           // version needed
    dv2.setUint16(p, 0x0800, true); p+=2;       // flags (UTF-8 filenames)
    dv2.setUint16(p, 0, true); p+=2;            // method
    dv2.setUint16(p, r.modTime, true); p+=2;
    dv2.setUint16(p, r.modDate, true); p+=2;
    dv2.setUint32(p, r.crc, true); p+=4;
    dv2.setUint32(p, r.size, true); p+=4;       // compressed
    dv2.setUint32(p, r.size, true); p+=4;       // uncompressed
    dv2.setUint16(p, r.nameBytes.length, true); p+=2;
    dv2.setUint16(p, 0, true); p+=2;            // extra len
    dv2.setUint16(p, 0, true); p+=2;            // comment len
    dv2.setUint16(p, 0, true); p+=2;            // disk number start
    dv2.setUint16(p, 0, true); p+=2;            // internal attrs
    dv2.setUint32(p, 0, true); p+=4;            // external attrs
    dv2.setUint32(p, r.offset, true); p+=4;     // relative offset
    centralHeader.set(r.nameBytes, 46);
    centralParts.push(centralHeader);
    centralSize += centralHeader.length;
  }
  const end = new Uint8Array(22);
  const dv3 = new DataView(end.buffer);
  dv3.setUint32(0, 0x06054b50, true);      // end of central dir
  dv3.setUint16(4, 0, true);               // disk number
  dv3.setUint16(6, 0, true);               // disk with central dir
  dv3.setUint16(8, fileRecords.length, true); // total entries this disk
  dv3.setUint16(10, fileRecords.length, true);// total entries
  dv3.setUint32(12, centralSize, true);    // size of central dir
  dv3.setUint32(16, totalSize, true);      // offset of start of central
  dv3.setUint16(20, 0, true);              // comment length

  // Concatenate all
  const allSize = totalSize + centralSize + end.length;
  const out = new Uint8Array(allSize);
  let pos=0;
  for(const part of localParts){ out.set(part, pos); pos+=part.length; }
  for(const part of centralParts){ out.set(part, pos); pos+=part.length; }
  out.set(end, pos);
  return new Blob([out], {type:'application/zip'});
}
// ===== Hook buttons =====
  function ensureExportButtons(){
    // helpers: collect selected ids from DOM as fallback
    function collectChatIds(){
      const ids = new Set();
      try{
        if(window.selectedIds && window.selectedIds.size>0){ window.selectedIds.forEach(v=>ids.add(v)); }
        const side = document.getElementById('sidebar');
        if(ids.size===0 && side){
          side.querySelectorAll('.conv-item input[type="checkbox"]:checked').forEach(cb=>{
            const li = cb.closest('.conv-item'); if(li && li.dataset && li.dataset.id) ids.add(li.dataset.id);
          });
        }
      }catch(e){}
      return ids;
    }
    function collectNoteTokens(){
      const ids = new Set();
      try{
        const UI = window.__NB_UI__ || {};
        if(UI.selected && UI.selected.size>0){ UI.selected.forEach(v=>ids.add(v)); }
        const tree = document.getElementById('cg_nb_stage') || document;
        tree.querySelectorAll('input[data-act="sel-nb"]:checked').forEach(cb=>{
          const li = cb.closest('.nb-item'); if(li && li.dataset && li.dataset.nbid){ ids.add('nb:'+li.dataset.nbid); }
        });
        tree.querySelectorAll('input[data-act="sel-pg"]:checked').forEach(cb=>{
          const li = cb.closest('.page'); if(li && li.dataset && li.dataset.pgid){ ids.add('pg:'+li.dataset.pgid); }
        });
      }catch(e){}
      return ids;
    }

    // chat toolbar
    const exportBtn = document.getElementById('exportSelected');
    const deleteSelectedBtn = document.getElementById('deleteSelected');
    const checkAll = document.getElementById('checkAll');
    if(exportBtn){
      // gate by selectedIds size
      function update(){ try{ exportBtn.disabled = false; }catch(e){} }
      // Removed MutationObserver to avoid attribute-change feedback loops
// basic listeners
      exportBtn.disabled = false;
      exportBtn.addEventListener('click', ()=>{
        const ids = collectChatIds();
        if(!(ids && ids.size>0)){ alert('请先选择要导出的会话'); return; }
        openExportModal({scope:'chat', ids});
      });
      // also wire checkAll and deleteSelected to update state changes
      if(checkAll){ checkAll && checkAll.addEventListener('change', update); }
      const sidebar = document.getElementById('sidebar'); if(sidebar){ sidebar.addEventListener('change', update); }
      if(deleteSelectedBtn){ deleteSelectedBtn && deleteSelectedBtn.addEventListener('click', ()=> setTimeout(update, 50)); }
        const sidebarEl = document.getElementById('sidebar');
      if(sidebarEl){ sidebarEl.addEventListener('change', ()=> setTimeout(update, 10)); }
      // reorder buttons: Export | Delete
      try{
        const bar = document.querySelector('.sidebar-controls');
        const exp = document.getElementById('exportSelected');
        const del = document.getElementById('deleteSelected');
        if(bar && exp && del && exp.nextElementSibling !== del){ bar.insertBefore(exp, del); }
      }catch(e){}
      update();
    }

    // notes toolbar
    const nbExportBtn = document.getElementById('cg_nb_export_sel');
    if(nbExportBtn){
      nbExportBtn.disabled = true;
      nbExportBtn.addEventListener('click', ()=>{
        const ids = collectNoteTokens();
        if(!(ids && ids.size>0)){ alert('请先选择要导出的笔记本/页面'); return; }
        openExportModal({scope:'notes', ids});
      });
      // augment updateToolbar to enable export when selection exists
      const stage = document.getElementById('cg_nb_stage');
      if(stage){ stage.addEventListener('change', ()=>{ const set = collectNoteTokens(); nbExportBtn.disabled = !(set && set.size>0); });
        // runtime reorder: Export | Delete
        try{ const bar=document.getElementById('cg_nb_toolbar'); const exp=bar && bar.querySelector('#cg_nb_export_sel'); const del=bar && bar.querySelector('#cg_nb_del_sel'); if(bar && exp && del && exp.nextElementSibling!==del){ bar.insertBefore(exp, del); } }catch(e){} }
    }
  }

// ==== Robust collectors & global delegation (V1.9c-safe) ====
(function(){
  function getSidebarRoot(){
    return document.getElementById('sidebar') || document.querySelector('.sidebar') || document.body;
  }
  function attrIn(el, names){
    for(const n of names){
      if(el.hasAttribute && el.hasAttribute(n)) return el.getAttribute(n);
      if(el.dataset && n.startsWith('data-')){
        const key = n.slice(5).replace(/-([a-z])/g, (_,c)=>c.toUpperCase());
        if(el.dataset[key]) return el.dataset[key];
      }
    }
    return null;
  }
  window.__collectChatIdsRobust = function(){
    const ids = new Set();
    const root = getSidebarRoot();
    if(!root) return ids;
    // try official way first
    try{
      if(window.selectedIds && window.selectedIds.size>0){ window.selectedIds.forEach(v=>ids.add(String(v))); }
    }catch(e){}
    // DOM fallback (tolerant selectors)
    const boxes = root.querySelectorAll('input[type="checkbox"]:checked');
    boxes.forEach(cb=>{
      let host = cb.closest('.conv-item, .conversation-item, [data-id], [data-cid], [data-conv-id], [data-key]') || cb;
      let id = attrIn(host, ['data-id','data-cid','data-conv-id','data-key','data-item-id']);
      if(!id && host.dataset && host.dataset.id) id = host.dataset.id;
      if(!id && cb.value && cb.value !== 'on') id = cb.value;
      if(id) ids.add(String(id));
    });
    return ids;
  };
  window.__collectNoteTokensRobust = function(){
    const ids = new Set();
    const stage = document.getElementById('cg_nb_stage') || document;
    // official selection if present
    try{
      const UI = window.__NB_UI__ || {};
      if(UI.selected && UI.selected.size>0){ UI.selected.forEach(v=>ids.add(String(v))); }
    }catch(e){}
    // DOM fallbacks
    const nbCbs = stage.querySelectorAll('input[data-act="sel-nb"]:checked, .nb-item input[type="checkbox"]:checked');
    nbCbs.forEach(cb=>{
      const li = cb.closest('.nb-item, [data-nbid]') || cb;
      const nbid = attrIn(li, ['data-nbid','data-id','data-nb']);
      if(nbid) ids.add('nb:'+String(nbid));
    });
    const pgCbs = stage.querySelectorAll('input[data-act="sel-pg"]:checked, .page input[type="checkbox"]:checked');
    pgCbs.forEach(cb=>{
      const li = cb.closest('.page, [data-pgid]') || cb;
      const pgid = attrIn(li, ['data-pgid','data-id','data-pg']);
      if(pgid) ids.add('pg:'+String(pgid));
    });
    return ids;
  };
  // Global delegation so even after re-render, clicks work
  document.addEventListener('click', function(e){
    const expChat = e.target.closest && e.target.closest('#exportSelected');
    if(expChat){
      const ids = window.__collectChatIdsRobust();
      if(!(ids && ids.size)){ alert('请先选择要导出的会话'); return; }
      if(typeof openExportModal === 'function'){ openExportModal({scope:'chat', ids}); }
      return;
    }
    const expNotes = e.target.closest && e.target.closest('#cg_nb_export_sel');
    if(expNotes){
      const ids = window.__collectNoteTokensRobust();
      if(!(ids && ids.size)){ alert('请先选择要导出的笔记本/页面'); return; }
      if(typeof openExportModal === 'function'){ openExportModal({scope:'notes', ids}); }
      return;
    }
  }, true);
})();
// ==== end robust collectors ====

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', ensureExportButtons);
  else ensureExportButtons();
})();
</script>



<style id="page-bg-override">
/* V2.4.6-fix3: apply bg image only to content panes (chat main & notes stage) */
main{
  background-image: var(--page-bg-image) !important;
  background-position: center !important;
  background-size: cover !important;
  background-repeat: no-repeat !important;
}
#cg_nb_stage{
  background-image: var(--page-bg-image) !important;
  background-position: center !important;
  background-size: cover !important;
  background-repeat: no-repeat !important;
}
/* When an image is active, keep nav/sidebars opaque so the image doesn't bleed through */
[data-bgimg="1"] :is(aside, .nb-left, .notes-nav){
  background: var(--nav-bg) !important;
  background-image: none !important;
}
</style>



<script id="avatar-persist-patch-v2_4_8">
(() => {
  function safeInitial(name, fallback){
    try{ const s=(name||'').trim(); if(!s) return fallback||'?'; const c=s[0]; return /[a-z]/i.test(c)? c.toUpperCase(): c; }
    catch(e){ return fallback||'?'; }
  }
  function solid(varName, fallback){
    try{ const v=getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); return v || fallback; }
    catch(e){ return fallback; }
  }
  function letterAvatar(letter, bg, fg){
    const L=(letter||'?').slice(0,1);
    const W=36,H=36,R=18;
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
      <rect rx="${R}" ry="${R}" width="${W}" height="${H}" fill="${bg||'#f3f4f6'}"/>
      <text x="50%" y="54%" text-anchor="middle" dominant-baseline="middle"
        font-family="ui-sans-serif,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif"
        font-size="18" fill="${fg||'#374151'}">${L}</text></svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }
  function toDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
  function readLS(key){ try{ const v=localStorage.getItem(key); return (typeof v==='string' && v.startsWith('data:image')) ? v : ''; }catch(e){ return ''; } }
  function writeLS(key,val){ try{ localStorage.setItem(key,val);}catch(e){} }

  function applyPreviews(){
    const uPrev = document.getElementById('userAvatarPreview');
    const aPrev = document.getElementById('assistantAvatarPreview');
    if(window.userAvatar) { if(uPrev) uPrev.src = window.userAvatar; }
    if(window.assistantAvatar) { if(aPrev) aPrev.src = window.assistantAvatar; }
  }

  function ensureMessageAvatars(){
    const chat = document.getElementById('chat'); if(!chat) return;
    chat.querySelectorAll('.msg').forEach(m => {
      const role = m.classList.contains('right') ? 'user' : 'assistant';
      let img = m.querySelector('img.avatar');
      if(!img){ img = document.createElement('img'); img.className='avatar'; m.insertBefore(img, m.firstChild); }
      let url = (role==='user') ? window.userAvatar : window.assistantAvatar;
      if(!url){
        const name = (role==='user') ? (window.userName || document.getElementById('userName')?.value || 'U')
                                     : (window.assistantName || document.getElementById('assistantName')?.value || 'A');
        const letter = safeInitial(name, role==='user'?'U':'A');
        const bg = solid(role==='user'?'--user-solid':'--assistant-solid', role==='user'?'#d2f9ee':'#f7f7f8');
        const fg = role==='user' ? '#374151' : '#111827';
        url = letterAvatar(letter, bg, fg);
      }
      if(img.getAttribute('src') !== url){
        img.setAttribute('src', url);
        img.onerror = function(){ this.onerror=null; this.src = letterAvatar(role==='user'?'U':'A', role==='user'?'#d2f9ee':'#f7f7f8', role==='user' ? '#374151' : '#111827'); };
      }
    });
  }

  function bindUploads(){
    const uIn = document.getElementById('userAvatar');
    const aIn = document.getElementById('assistantAvatar');
    const uPrev = document.getElementById('userAvatarPreview');
    const aPrev = document.getElementById('assistantAvatarPreview');
    function bind(input, role){
      if(!input) return;
      input.addEventListener('change', async (ev)=>{
        if(ev && ev.stopImmediatePropagation){ ev.stopImmediatePropagation(); }
        if(ev && ev.stopPropagation){ ev.stopPropagation(); }
        const file = input.files && input.files[0]; if(!file) return;
        try{
          const url = (window.openCropper ? await window.openCropper(file, {mode: role==='user' ? 'avatar':'avatar'}) : await toDataURL(file));
          if(role==='user'){ window.userAvatar = url; writeLS('cg_userAvatar', url); if(uPrev) uPrev.src = url; }
          else { window.assistantAvatar = url; writeLS('cg_assistantAvatar', url); if(aPrev) aPrev.src = url; }
          ensureMessageAvatars();
        }catch(e){ /* swallow */ }
      }, {capture:true});
    }
    bind(uIn,'user'); bind(aIn,'assistant');
  }

  function init(){
    window.userAvatar = readLS('cg_userAvatar');
    window.assistantAvatar = readLS('cg_assistantAvatar');
    applyPreviews();
    ensureMessageAvatars();
    bindUploads();
    const chat = document.getElementById('chat');
    if(chat){
      const obs = new MutationObserver(()=> ensureMessageAvatars());
      obs.observe(chat, {childList:true, subtree:true});
    }
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init, {once:true}); }
  else { init(); }
})();
</script>


<style id="cg-cropper-style">
#cgCropperMask{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:saturate(90%) blur(2px);display:none;z-index:9999;}
#cgCropper{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(92vw,980px);height:min(82vh,700px);background:#111;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35);display:flex;flex-direction:column;overflow:hidden;color:#eee}
#cgCropper .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#1a1a1a;border-bottom:1px solid #2a2a2a}
#cgCropper .hd .title{font-weight:600;font-size:14px}
#cgCropper .bd{position:relative;flex:1;display:flex;align-items:center;justify-content:center;background:#0f0f0f}
#cgCropper .ft{display:flex;align-items:center;gap:10px;padding:10px 14px;border-top:1px solid #2a2a2a;background:#141414}
#cgCropperCanvas{max-width:100%;max-height:100%;background:#000}
#cgCropper .btn{appearance:none;border:0;border-radius:10px;padding:8px 12px;cursor:pointer;background:#2a2a2a;color:#eee}
#cgCropper .btn.primary{background:#4f46e5}
#cgCropper .btn.ghost{background:transparent;border:1px solid #3a3a3a}
#cgCropper .tools{display:flex;gap:10px;align-items:center;margin-left:auto}
#cgCropper .ratio{display:flex;gap:6px}
#cgCropper .ratio .btn{padding:6px 10px;font-size:12px}
#cgCropper .zoom{display:flex;align-items:center;gap:8px}
#cgCropper .zoom input{width:160px}
#cgCropper .preview{display:flex;align-items:center;gap:10px;margin-left:10px}
#cgCropper .chip{border:1px solid #3a2a2a;border-radius:8px;padding:4px 8px;font-size:12px;opacity:.85}
#cgCropper .close{background:transparent;color:#aaa;border:0;font-size:18px;cursor:pointer}
</style>

<div id="cgCropperMask" aria-hidden="true">
  <div id="cgCropper" role="dialog" aria-modal="true" aria-label="裁剪图片">
    <div class="hd">
      <div class="title">裁剪图片</div>
      <button class="close" id="cgCropperClose">✕</button>
    </div>
    <div class="bd">
      <canvas id="cgCropperCanvas"></canvas>
      <canvas id="cgCropperOverlay" style="position:absolute;inset:0;pointer-events:none;"></canvas>
    </div>
    <div class="ft">
      <div class="ratio" id="cgCropperRatio"></div>
      <div class="zoom"><span class="chip">缩放</span><input type="range" id="cgCropperZoom" min="0.5" max="3" step="0.01" value="1"></div>
      <div class="tools">
        <button class="btn ghost" id="cgCropperReset">重置</button>
        <button class="btn" id="cgCropperRotate">旋转90°</button>
        <button class="btn" id="cgCropperCancel">取消</button>
        <button class="btn primary" id="cgCropperOk">确定</button>
      </div>
    </div>
  </div>
</div>

<script id="cg-cropper-module">
(() => {
  const $ = s => document.querySelector(s);
  const mask = $('#cgCropperMask');
  const canvas = $('#cgCropperCanvas');
  const overlay = $('#cgCropperOverlay');
  const zoomEl = $('#cgCropperZoom');
  const ratioWrap = $('#cgCropperRatio');
  const btnOk = $('#cgCropperOk'), btnCancel=$('#cgCropperCancel'), btnClose=$('#cgCropperClose'), btnReset=$('#cgCropperReset'), btnRotate=$('#cgCropperRotate');
  let ctx = null, octx = null, current = null;
  function ensure(){ if(!ctx){ ctx = canvas.getContext('2d'); } if(!octx){ octx = overlay.getContext('2d'); } }
  function ensureShown(shown){ mask.style.display = shown ? 'block' : 'none'; mask.setAttribute('aria-hidden', shown ? 'false' : 'true'); }
  function setTitle(t){ $('#cgCropper .title').textContent = t || '裁剪图片'; }
  function aspectButton(label, val, active){
    const b = document.createElement('button'); b.className = 'btn' + (active?' primary':''); b.textContent = label; b.dataset.ratio = val;
    b.addEventListener('click', ()=>{ [...ratioWrap.children].forEach(x=>x.classList.remove('primary')); b.classList.add('primary'); setAspect(val); });
    return b;
  }
  function setAspect(val){ if(!current) return; current.aspect = val; layout(); draw(); }
  function layout(){
    if(!current) return; ensure();
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const w = canvas.clientWidth = canvas.parentElement.clientWidth;
    const h = canvas.clientHeight = canvas.parentElement.clientHeight;
    canvas.width = Math.round(w*dpr); canvas.height = Math.round(h*dpr);
    overlay.width = canvas.width; overlay.height = canvas.height; overlay.style.width = w+'px'; overlay.style.height = h+'px';
    const pad = 24*dpr;
    let cw = w*dpr - pad*2, ch = h*dpr - pad*2;
    if(current.aspect && current.aspect!=='free'){
      const [a,b] = current.aspect.split(':').map(Number); const r=a/b;
      if(cw/ch > r) cw = ch*r; else ch = cw/r;
    }
    current.cropW = cw; current.cropH = ch;
    if(!current._laidOut){
      const iw=current.img.width, ih=current.img.height; const rs=Math.max(cw/iw, ch/ih);
      current.scale = rs; current.tx = (canvas.width - iw*rs)/2; current.ty = (canvas.height - ih*rs)/2; current.rot = 0; current._laidOut = true;
      zoomEl.value = String(Math.min(3, Math.max(0.5, rs)));
    }
    drawOverlay();
  }
  function drawOverlay(){
    if(!current) return; ensure();
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    octx.save(); octx.clearRect(0,0,overlay.width, overlay.height); octx.fillStyle='rgba(0,0,0,.45)'; octx.fillRect(0,0,overlay.width, overlay.height);
    const x=(overlay.width-current.cropW)/2, y=(overlay.height-current.cropH)/2;
    octx.clearRect(x,y,current.cropW,current.cropH);
    octx.strokeStyle='rgba(255,255,255,.85)'; octx.lineWidth=2*dpr; octx.strokeRect(x+octx.lineWidth/2,y+octx.lineWidth/2,current.cropW-octx.lineWidth,current.cropH-octx.lineWidth);
    octx.restore();
  }
  function draw(){
    if(!current) return; ensure();
    ctx.save(); ctx.clearRect(0,0,canvas.width, canvas.height);
    ctx.translate(current.tx, current.ty); ctx.translate(current.img.width*current.scale/2, current.img.height*current.scale/2);
    ctx.rotate((current.rot||0)*Math.PI/180); ctx.translate(-current.img.width*current.scale/2, -current.img.height*current.scale/2);
    ctx.drawImage(current.img,0,0,current.img.width,current.img.height, 0,0,current.img.width*current.scale,current.img.height*current.scale);
    ctx.restore();
  }
  let dragging=false, lastX=0, lastY=0;
  canvas.addEventListener('pointerdown', e=>{ dragging=true; lastX=e.clientX; lastY=e.clientY; canvas.setPointerCapture(e.pointerId); });
  canvas.addEventListener('pointermove', e=>{ if(!dragging) return; const dx=(e.clientX-lastX)*(window.devicePixelRatio||1); const dy=(e.clientY-lastY)*(window.devicePixelRatio||1); lastX=e.clientX; lastY=e.clientY; current.tx+=dx; current.ty+=dy; draw(); });
  canvas.addEventListener('pointerup', ()=> dragging=false);
  canvas.addEventListener('pointercancel', ()=> dragging=false);
  canvas.addEventListener('wheel', e=>{ e.preventDefault(); const f = e.deltaY<0 ? 1.06 : 0.94; current.scale=Math.max(0.2, Math.min(6, current.scale*f)); zoomEl.value=String(current.scale); draw(); }, {passive:false});
  zoomEl.addEventListener('input', ()=>{ current.scale=parseFloat(zoomEl.value); draw(); });
  btnReset.addEventListener('click', ()=>{ current._laidOut=false; layout(); draw(); });
  btnRotate.addEventListener('click', ()=>{ current.rot=((current.rot||0)+90)%360; draw(); });
  function finish(ok){
    ensureShown(false);
    if(!current){ return; }
    if(!ok){ current.reject(null); current=null; return; }
    // render viewport then crop
    const dpr = Math.max(1, window.devicePixelRatio||1);
    const x=(canvas.width-current.cropW)/2, y=(canvas.height-current.cropH)/2;
    const tmp = document.createElement('canvas').getContext('2d'); tmp.canvas.width=canvas.width; tmp.canvas.height=canvas.height;
    tmp.save(); tmp.translate(current.tx, current.ty); tmp.translate(current.img.width*current.scale/2, current.img.height*current.scale/2); tmp.rotate((current.rot||0)*Math.PI/180); tmp.translate(-current.img.width*current.scale/2, -current.img.height*current.scale/2);
    tmp.drawImage(current.img,0,0,current.img.width,current.img.height, 0,0,current.img.width*current.scale,current.img.height*current.scale); tmp.restore();
    const crop = tmp.getImageData(x,y,current.cropW,current.cropH);
// output size
let outW=current.outW, outH=current.outH;
if(!outW || !outH){
  if(current.mode==='avatar'){ outW=512; outH=512; }
  else { if(current.aspect==='9:16'){ outW=1080; outH=1920; } else if(current.aspect==='16:9'){ outW=1920; outH=1080; } else { outW=Math.min(1920,current.cropW); outH=Math.round(outW*(current.cropH/current.cropW)); } }
}
// Create src canvas exactly crop size, then scale to target to avoid top-left quadrant shrink
const srcC = document.createElement('canvas').getContext('2d');
srcC.canvas.width = current.cropW; srcC.canvas.height = current.cropH;
srcC.putImageData(crop, 0, 0);
const outCtx = document.createElement('canvas').getContext('2d');
outCtx.canvas.width = outW; outCtx.canvas.height = outH;
outCtx.imageSmoothingEnabled = true; outCtx.imageSmoothingQuality='high';
outCtx.drawImage(srcC.canvas, 0,0, current.cropW, current.cropH, 0,0, outW, outH);
const mime = (current.mode==='avatar') ? 'image/png' : 'image/jpeg'; const url = outCtx.canvas.toDataURL(mime, 0.9);
    current.resolve(url); current=null;
  }
  btnOk.addEventListener('click', ()=> finish(true));
  btnCancel.addEventListener('click', ()=> finish(false));
  $('#cgCropperClose').addEventListener('click', ()=> finish(false));

  async function openCropper(file, opts){
    const mode = (opts&&opts.mode) || 'avatar'; const aspect = (opts&&opts.aspect) || (mode==='avatar'?'1:1':'16:9');
    ratioWrap.innerHTML='';
    if(mode==='avatar'){ ratioWrap.appendChild(aspectButton('1:1','1:1',true)); setTitle('裁剪头像（1:1）'); }
    else { ratioWrap.appendChild(aspectButton('16:9','16:9',aspect==='16:9')); ratioWrap.appendChild(aspectButton('9:16','9:16',aspect==='9:16')); ratioWrap.appendChild(aspectButton('自由','free',aspect==='free')); setTitle('裁剪背景（16:9 / 9:16）'); }
    const img = new Image(); const url = URL.createObjectURL(file);
    await new Promise((res,rej)=>{ img.onload=()=>res(); img.onerror=rej; img.src=url; }); URL.revokeObjectURL(url);
    current = { img, mode, aspect, scale:null, tx:0, ty:0, rot:0, cropW:0, cropH:0, outW:null, outH:null, _laidOut:false };
    ensureShown(true); setTimeout(()=>{ layout(); draw(); }, 0);
    return new Promise((resolve,reject)=>{ current.resolve=resolve; current.reject=reject; });
  }
  window.openCropper = (file, options)=> openCropper(file, options||{});
})();
</script>








<!-- === Custom tweaks V2.5.3re === -->
<style id="custom253re">
/* general styles */
header .title .hint{display:none !important;}
#resetOrder{display:none !important;}
.cg-searchbar button{color:#6b7280;}

/* layout reorder */
header #status{
  order:50;
  flex:1 1 auto;
  text-align:center;
}
header #cg_bm_toggle{order:80;}
header select#viewMode{order:85;} /* parent inherits order if not flex item; ensure on its own */
header select#viewMode{margin-left:0;}

/* ensure group holding viewMode inherits correct order by wrapping selector */
header select#viewMode{
  position:relative;
}
header select#viewMode::before{}
</style>
<script id="custom253re">
(function(){
  // Clean storage text in status without flicker
  function cleanStatus(){
    const st=document.getElementById('status');
    if(!st) return;
    const txt=st.textContent;
    if(/存储[:：]/.test(txt)){
      st.textContent = txt.replace(/ *[·•]? *存储[:：].*/, '');
    }
  }
  // replace arrow buttons once
  function fixArrows(){
    const btns=document.querySelectorAll('.cg-searchbar button');
    if(btns.length>=2){
      btns[0].textContent='⬅';
      btns[1].textContent='➡';
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    cleanStatus();
    fixArrows();
    // Mutation observer to monitor status content
    const st=document.getElementById('status');
    if(st){
      new MutationObserver(()=>{cleanStatus();}).observe(st,{childList:true,characterData:true,subtree:true});
    }
  });
})();
</script>
<!-- end custom 253re -->


<script id="v264-theme-mode-js">
(function(){
  const LS_KEY = 'cg_theme_mode';
  function setValue(sel, val){
    try{
      const el = document.querySelector(sel);
      if(!el) return;
      el.value = val;
      el.dispatchEvent(new Event('input', {bubbles:true}));
      el.dispatchEvent(new Event('change', {bubbles:true}));
    }catch(e){}
  }
  function applyMode(mode){
    const root = document.documentElement;
    if(!mode) mode = 'light';
    const attr = (mode==='dark')?'dark': (mode==='light')?'light':'custom';
    root.setAttribute('data-theme', attr);
    localStorage.setItem(LS_KEY, mode);
    if(mode==='light'){
      // Bubbles: pure white in light theme
      setValue('#th_assistColor', '#ffffff');
      setValue('#th_userColor', '#ffffff');
      setValue('#th_assistOpacity', '1');
      setValue('#th_userOpacity', '1');
      document.documentElement.style.setProperty('--assistant-text', '#111827');
      document.documentElement.style.setProperty('--user-text', '#111827');
      document.documentElement.style.setProperty('--assistant-text','#111827');
      document.documentElement.style.setProperty('--user-text','#111827');
      setValue('#th_bg', '#ffffff');
      setValue('#th_navBg', '#ffffff');
      setValue('#th_navOpacity', '0.92');
      root.style.setProperty('--text', '#111827');
      root.style.setProperty('--panel', '#ffffff');
      root.style.setProperty('--border', '#e5e7eb');
    }else if(mode==='dark'){
      // Bubbles: pure black in dark theme
      setValue('#th_assistColor', '#000000');
      setValue('#th_userColor', '#000000');
      setValue('#th_assistOpacity', '1');
      setValue('#th_userOpacity', '1');
      document.documentElement.style.setProperty('--assistant-text', '#ffffff');
      document.documentElement.style.setProperty('--user-text', '#ffffff');
      document.documentElement.style.setProperty('--assistant-text','#e5e7eb');
      document.documentElement.style.setProperty('--user-text','#e5e7eb');
      setValue('#th_bg', '#0b1220');
      setValue('#th_navBg', '#111827');
      setValue('#th_navOpacity', '0.92');
      root.style.setProperty('--text', '#e5e7eb');
      root.style.setProperty('--panel', '#111827');
      root.style.setProperty('--border', '#374151');
    }else{ // custom
      // keep user's custom selections; do not override
    }
  }
  document.addEventListener('DOMContentLoaded', function(){
    const saved = localStorage.getItem(LS_KEY) || 'light';
    const panel = document.getElementById('themePanel');
    const light = document.getElementById('th_mode_light');
    const dark  = document.getElementById('th_mode_dark');
    const custom= document.getElementById('th_mode_custom');
    if(saved==='dark' && dark) dark.checked = true;
    else if(saved==='custom' && custom) custom.checked = true;
    else if(light) light.checked = true;
    applyMode(saved);
    if(panel){
      panel.addEventListener('change', function(e){
        const t=e.target;
        if(t && t.name==='th_mode'){ applyMode(t.value); }
      }, true);
    }
  });
})();
</script>

<!-- Patch v2.7.2E injected 2025-08-18 15:45:10 -->


<!-- Patch v2.7.2G -->
<script id="patch_export_v2_7_2G">
;(function(){
  if (window.__EXPORT_PATCH_2G__) return;
  window.__EXPORT_PATCH_2G__ = true;

  function $$(sel){ return document.querySelector(sel); }
  function by(sel){ return Array.from(document.querySelectorAll(sel)); }

  function html2plain(html){
    if(!html) return '';
    var doc = new DOMParser().parseFromString(String(html),'text/html');
    var msgWrap = doc.querySelector('.msg-wrap,.messages,.chat-body');
    var root = msgWrap ? msgWrap.cloneNode(true) : doc.body;
    var junk = '.nav,.navbar,.sidebar,.btn,.toolbar,.header,.footer';
    root.querySelectorAll(junk).forEach(function(n){ n.remove(); });
    root.querySelectorAll('pre code').forEach(function(code){
      var fence = '```' + (code.dataset.lang||'') + '\n' + code.textContent + '\n```';
      code.parentElement.outerHTML = fence;
    });
    var raw = root.textContent.replace(/\u00A0/g,' ');
    var lines = raw.split('\n').filter(function(l){
      return !/^\s*(全选|导出|删除选定|新建笔记|笔记本|上一页|下一页)\b/.test(l);
    });
    return lines.join('\n').trim();
  }

  function safeName(s){ return String(s||'').replace(/[\\/:*?"<>|\n\r]+/g,' ').trim().slice(0,120)||'untitled'; }
  function fmtTS(ts){ return ts||''; }

  function mdFromPage(page, withMeta){
    var head = '# ' + (page.notebookName||'') + ' ' + (page.name||'') + '\n' + (withMeta ? ((page.metaStamp||'')+'\n') : '');
    var body = (page.messages||[]).map(function(m){
      var role=m.role||''; var tail=(role==='You')?'★':('·'+(m.model||'')+'★');
      return role+'·'+fmtTS(m.ts||'')+tail+'\n'+(m.text||'')+'\n';
    }).join('\n');
    return head+body;
  }

  function getStore(){
    var s = (typeof window.nbStore==='function') ? (window.nbStore()||{}) : (window.NB||{});
    s.notebooks = Array.isArray(s.notebooks)?s.notebooks:[];
    s.pages = Array.isArray(s.pages)?s.pages:[];
    s.entries = Array.isArray(s.entries)?s.entries:[];
    s.page_entries = Array.isArray(s.page_entries)?s.page_entries:(Array.isArray(s.pageEntries)?s.pageEntries:[]);
    return s;
  }

  function collectTokensFallback(){
    if (typeof window.collectNoteTokens==='function') {
      try { return new Set(Array.from(window.collectNoteTokens()||[])); } catch(e){}
    }
    var out = new Set();
    by('[data-token].checked, input[type=checkbox][data-token]:checked').forEach(function(el){ out.add(String(el.getAttribute('data-token'))); });
    by('[data-nbid].selected, input[type=checkbox][data-nbid]:checked, [data-nb]').forEach(function(el){
      var v = el.getAttribute('data-nbid') || el.getAttribute('data-nb');
      if (v!=null) out.add('nb:'+String(v));
    });
    by('[data-pgid].selected, input[type=checkbox][data-pgid]:checked, [data-pg]').forEach(function(el){
      var v = el.getAttribute('data-pgid') || el.getAttribute('data-pg');
      if (v!=null) out.add('pg:'+String(v));
    });
    return out;
  }

  function buildPagesFromIds(idSet){
    var store=getStore();
    var notebooks=store.notebooks, pages=store.pages, entries=store.entries, links=store.page_entries;
    var mapPage = new Map(pages.map(function(p){return [String(p.id),p];}));
    var mapEntry= new Map(entries.map(function(e){return [String(e.id),e];}));
    var linksByPage = links.reduce(function(acc,pe){ var k=String(pe.page_id||pe.pid||pe.pageId); (acc[k]||(acc[k]=[])).push(pe); return acc; },{});

    var nbPageIds=new Map();
    pages.forEach(function(p){
      var nbid = (p.nb_id!=null?p.nb_id:(p.notebook_id!=null?p.notebook_id:(p.nid!=null?p.nid:p.nbId)));
      if(nbid==null) return; var k=String(nbid);
      if(!nbPageIds.has(k)) nbPageIds.set(k,new Set()); nbPageIds.get(k).add(String(p.id));
    });

    var tokens = Array.from(idSet||[]).map(String);
    var selectedPageIds=new Set();
    tokens.forEach(function(s){
      if(s.indexOf('nb:')===0){
        var set=nbPageIds.get(s.slice(3)); if(set) set.forEach(function(id){selectedPageIds.add(id);});
      } else if(s.indexOf('pg:')===0){
        selectedPageIds.add(s.slice(3));
      } else {
        if(mapPage.has(s)) selectedPageIds.add(s); // raw id
      }
    });

    var out=[];
    selectedPageIds.forEach(function(pid){
      var pg=mapPage.get(String(pid)); if(!pg) return;
      var pageTitle=pg.title||pg.name||'';
      var nbid=(pg.nb_id!=null?pg.nb_id:(pg.notebook_id!=null?pg.notebook_id:(pg.nid!=null?pg.nid:pg.nbId)));
      var nb=(notebooks.find(function(n){return String(n.id)===String(nbid);} ))||{};
      var nbTitle=nb.title||nb.name||'';
      var peLinks=linksByPage[String(pid)]||[];
      var msgs=peLinks.map(function(link){
        var e=mapEntry.get(String(link.entry_id||link.eid||link.id));
        if(!e) return null;
        var html=e.html||e.content||e.text||'';
        return { role:e.role||e.author||'', model:e.model||e.engine||'', ts:e.ts||e.createdAt||e.time||'', html:html, text:html2plain(html) };
      }).filter(Boolean);
      out.push({ page_id:String(pid), notebookName:nbTitle||'未命名笔记本', name:pageTitle||'未命名页面', metaStamp:'', messages:msgs });
    });
    return out;
  }

  function downloadBlob(name, blob){
    var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name;
    document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(a.href); a.remove();},0);
  }

  var confirmBtn=document.getElementById('cg_export_confirm');
  if(!confirmBtn){ console.error('Exporter 2.7.2G: confirm button not found'); return; }

  confirmBtn.addEventListener('click', function(ev){
    try{
      var modal=document.getElementById('cg_export_modal');
      var scope=(modal&&modal.dataset&&modal.dataset.scope)||'notes';
      if(scope!=='notes') return;
      var ids = (modal && modal.__ids) ? modal.__ids : null;
      if(!ids || (ids.size!==undefined && ids.size===0) || (Array.isArray(ids) && ids.length===0)) {
        ids = collectTokensFallback();
      }
      var setIds = (ids instanceof Set) ? ids : new Set(Array.from(ids||[]));
      var pages = buildPagesFromIds(setIds);
      if(!pages.length){ console.warn('patch 2.7.2G: no pages resolved from tokens', Array.from(setIds)); return; }
      ev.stopImmediatePropagation(); ev.preventDefault();

      var fmts={ json: $$('#fmt_json') && $$('#fmt_json').checked,
                 md:   $$('#fmt_md') && $$('#fmt_md').checked,
                 txt:  $$('#fmt_txt') && $$('#fmt_txt').checked };
      var withMeta = !!($$('#opt_meta') && $$('#opt_meta').checked);

      pages.forEach(function(p){
        var base=safeName((p.notebookName||'')+'_'+(p.name||''));
        if(fmts.md)  downloadBlob(base+'.md',  new Blob([mdFromPage(p, withMeta)], {type:'text/markdown;charset=utf-8'}));
        if(fmts.txt) downloadBlob(base+'.txt', new Blob([new Uint8Array([0xEF,0xBB,0xBF]), mdFromPage(p, withMeta).replace(/^# .+?\n/, '')], {type:'text/plain;charset=utf-8'}));
        if(fmts.json) downloadBlob(base+'.json', new Blob([JSON.stringify(p,null,2)], {type:'application/json'}));
      });

      if(typeof window.closeExportModal==='function') window.closeExportModal();
    }catch(e){ console.error('Exporter 2.7.2G error:', e); }
  }, true);

  console.info('%cExporter 2.7.2G ready','color:#0f0');
})();</script>


<script id="v290-singlepage-migrate">
(function(){
  'use strict';
  function uid(p){ try{ return (typeof window.uid==='function') ? window.uid(p) : ((p||'id')+'-'+Math.random().toString(36).slice(2,9)); }catch(e){ return (p||'id')+'-'+Date.now(); } }
  function now(){ try{ return (typeof window.now==='function') ? window.now() : Date.now(); }catch(e){ return Date.now(); } }
  function nbStoreSafe(){ try{ return (typeof nbStore==='function') ? nbStore() : (JSON.parse(localStorage.getItem('cg_nb_store_v1')||'{}')); }catch(e){ return {}; } }
  function nbSaveSafe(NB){ try{ return (typeof nbSave==='function') ? nbSave(NB) : localStorage.setItem('cg_nb_store_v1', JSON.stringify(NB)); }catch(e){} }

  function migrateToSinglePageOnce(){
    try{
      if(localStorage.getItem('cg_nb_migrated_singlepage_v1')) return;
      const NB = nbStoreSafe(); if(!NB || !Array.isArray(NB.notebooks)) return;
      try{ localStorage.setItem('cg_nb_store_backup_'+Date.now(), JSON.stringify(NB)); }catch(e){}
      (NB.notebooks||[]).forEach(nb=>{
        const pages = (NB.pages||[]).filter(p=> p.notebook_id===nb.id).sort((a,b)=> (a.order||0)-(b.order||0));
        if(pages.length===0){
          const def = {id:uid('pg'), notebook_id:nb.id, name: nb.name || '默认页', order:1, created_at:now(), updated_at:now()};
          NB.pages = NB.pages || []; NB.pages.push(def);
        }else if(pages.length>1){
          const def = pages[0]; const rest = pages.slice(1);
          const links = (NB.page_entries||[]); const annos = (NB.annotations||[]);
          const merged=[];
          pages.forEach(pg=>{
            const arr = links.filter(x=> x.page_id===pg.id).sort((a,b)=>(a.order||0)-(b.order||0));
            merged.push.apply(merged, arr);
          });
          merged.forEach((pe, idx)=>{ pe.page_id = def.id; pe.order = idx+1; });
          annos.forEach(a=>{ if(rest.some(r=> r.id===a.page_id)) a.page_id = def.id; });
          NB.pages = NB.pages.filter(p=> p.notebook_id!==nb.id || p.id===def.id);
        }
      });
      nbSaveSafe(NB);
      localStorage.setItem('cg_nb_migrated_singlepage_v1','1');
      try{ if(typeof renderNbTree==='function') renderNbTree(); }catch(e){}
    }catch(e){}
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', migrateToSinglePageOnce);
  else migrateToSinglePageOnce();

  // Tweak export button label if needed
  try{
    const btn = document.getElementById('cg_nb_stage_export');
    if(btn && /导出当前页/.test(btn.textContent||'')) btn.textContent = '导出当前笔记';
  }catch(e){}
})();
</script>

<script>
/* ==================================================
   Chat Notebook v2.9.4b  ——  “目录”按钮 + Entry Navigator Panel
   -------------------------------------------------- */
(function(){
  // add button
  function ensureToolbar(){
    let bar=document.getElementById('cg_nb_toolbar');
    if(!bar){
      // try find existing view-bar
      bar=document.querySelector('.cg-view-bar')||document.body;
    }
    return bar;
  }

  function createButton(){
    const btn=document.createElement('button');
    btn.id='entryIndexBtn';
    btn.textContent='目录';
    btn.style.cssText='padding:4px 10px;border:1px solid var(--border);background:var(--panel);border-radius:4px;cursor:pointer;font-size:12px;';
    btn.addEventListener('click',togglePanel);
    return btn;
  }

  function togglePanel(){
    let panel=document.getElementById('entryIndexPanel');
    if(panel){
      // toggle visibility
      panel.style.display = panel.style.display==='none'?'block':'none';
      if(panel.style.display!=='none') rebuildPanel(panel);
      return;
    }
    panel=document.createElement('div');
    panel.id='entryIndexPanel';
    panel.style.cssText='position:fixed;top:60px;right:0;width:260px;height:80%;overflow:auto;background:#fff;border-left:1px solid var(--border);box-shadow:0 0 8px rgba(0,0,0,.1);z-index:1000;padding:12px;display:block;';
    document.body.appendChild(panel);
    rebuildPanel(panel);
  }

  function rebuildPanel(panel){
    panel.innerHTML='<h3 style="margin:0 0 8px;font-size:14px;">对话集目录</h3>';
    const entries=document.querySelectorAll('#cg_nb_canvas .nb-entry');
    if(!entries.length){
       panel.insertAdjacentHTML('beforeend','<p style="font-size:12px;color:var(--muted);">暂无对话集</p>');
       return;
    }
    entries.forEach((entry,i)=>{
      const eid=entry.dataset.id;
      const head=entry.querySelector('.nb-entry-head .title, .nb-entry-head div');
      const label=(head&&head.textContent.trim())||('Entry '+(i+1));
      const item=document.createElement('div');
      item.textContent='• '+label;
      item.style.cssText='padding:4px 0;font-size:13px;cursor:pointer;';
      item.addEventListener('click',()=>{
        entry.scrollIntoView({behavior:'smooth', block:'start'});
        entry.classList.add('flash');
        setTimeout(()=>entry.classList.remove('flash'),1500);
      });
      panel.appendChild(item);
    });
  }

  document.addEventListener('DOMContentLoaded',()=>{
    const bar=ensureToolbar();
    if(bar && !document.getElementById('entryIndexBtn')){
      bar.appendChild(createButton());
    }
  });

})();
</script>
<script>
/* =========================================
   V2.9.5plus  Notebook & Entry Directory Buttons
   ========================================= */
(function(){
  /* ---------- Styles ---------- */
  const style = document.createElement('style');
  style.textContent = `
    .dir-btn{border:0;background:transparent;font-weight:700;font-size:14px;
             color:var(--muted);cursor:pointer;padding:0 4px;}
    .dir-btn:hover{color:var(--text);}
    .nb-dir-box{margin-left:26px;border-left:2px solid var(--border);
                padding:4px 0 6px 4px;display:none;max-height:300px;overflow:auto;}
    .nb-dir-item{padding:2px 6px;font-size:13px;line-height:20px;color:var(--muted);
                 white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;}
    .nb-dir-item:hover{color:var(--text);background:var(--assistant);}
    @keyframes flashNav{0%{background:rgba(255,230,160,.6)}100%{background:transparent}}
    .nb-entry.flashNav{animation:flashNav 1.2s}
  `;
  document.head.appendChild(style);

  /* ---------- Helper to highlight target ---------- */
  function highlight(el){
    el.classList.add('flashNav');
    setTimeout(()=>el.classList.remove('flashNav'),1200);
  }

  /* ---------- Build notebook directory box ---------- */
  function buildNotebookDir(nbItem){
  // v2.9.6: Build per-notebook directory from data store, not from current canvas.
  let box = nbItem.querySelector('.nb-dir-box');
  if(!box){
    box = document.createElement('div');
    box.className = 'nb-dir-box';
    nbItem.appendChild(box);
  }else{
    box.innerHTML='';
  }
  try{
    const li = nbItem.closest('.nb-item');
    const nbId = li && li.dataset ? li.dataset.nbid : null;
    
const NB = (function(){
  try{ if(typeof nbStore==='function') return nbStore(); }catch(_){}
  try{ if(typeof window!=='undefined' && typeof window.nbStore==='function') return window.nbStore(); }catch(_){}
  try{ if(typeof window!=='undefined' && window.NB) return window.NB; }catch(_){}
  try{ const raw = localStorage.getItem('cg_nb_store_v1') || '{}'; return JSON.parse(raw); }catch(_){}
  return {};
})();

    const pages = (NB.pages||[]).filter(p=>p.notebook_id===nbId)
                   .sort((a,b)=>(a.order||0)-(b.order||0));
    if(!pages.length){
      box.innerHTML = '<div class="nb-dir-item" style="color:var(--muted)">暂无对话集</div>';
      return box;
    }
    pages.forEach(pg=>{
      // Entries under page
      const links = (NB.page_entries||[]).filter(pe=>pe.page_id===pg.id)
                      .sort((a,b)=>(a.order||0)-(b.order||0));
      links.forEach(link=>{
        const en = (NB.entries||[]).find(e=>e.id===link.entry_id);
        if(!en) return;
        const metaTitle = (en.meta && en.meta.conv_title) ? en.meta.conv_title : (en.conv_id || '[对话集]');
        // Count messages (best-effort)
        const cnt = (en.snapshot && en.snapshot.messages) ? en.snapshot.messages.length
                   : (en.msg_ids ? en.msg_ids.length : 0);
        const item = document.createElement('div');
        item.className='nb-dir-item';
        item.textContent='› ' + metaTitle + (cnt?(' · '+cnt+'条'):"");
        item.addEventListener('click', ()=> {
  try {
    const goTree = (typeof renderNbTree === 'function')
      ? renderNbTree
      : (typeof window !== 'undefined' && typeof window.renderNbTree === 'function'
          ? window.renderNbTree
          : null);

    const goPage = (typeof renderPageStage === 'function')
      ? renderPageStage
      : (typeof window !== 'undefined' && typeof window.renderPageStage === 'function'
          ? window.renderPageStage
          : null);

    if (goTree && goPage) {
      goTree(nbId, pg.id);
      goPage(pg.id);
    } else {
      const pageEl = document.querySelector(
        '#cg_nb_tree .nb-item[data-nbid="' + nbId + '"] .page[data-pgid="' + pg.id + '"]'
      );
      if (pageEl) {
        pageEl.dispatchEvent(new MouseEvent('click', { bubbles: true }));
      }
    }

    requestAnimationFrame(() => {
      const target =
        document.querySelector('#cg_nb_canvas .nb-entry[data-id="' + en.id + '"]') ||
        document.querySelector('#cg_nb_canvas .nb-entry');
      if (!target) return;
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      target.classList.add('flashNav');
      setTimeout(() => target.classList.remove('flashNav'), 1200);
    });
  } catch (err) {
    console.warn('nav to entry failed', err);
  }
});
        box.appendChild(item);
      });
    });
  }catch(e){
    console.error('buildNotebookDir v2.9.6 error', e);
    box.innerHTML = '<div class="nb-dir-item" style="color:var(--muted)">目录生成失败</div>';
  }
  return box;
}

  /* ---------- Inject buttons into notebook rows ---------- */
  function injectNotebookButtons(){
    document.querySelectorAll('#cg_nb_tree .nb-item .row').forEach(row=>{
      if(!row.querySelector('.dir-btn')){
        const btn = document.createElement('button');
        btn.className = 'dir-btn';
        btn.textContent = '＝';
        row.appendChild(btn);
      }
    });
  }

  /* ---------- Event delegation for notebook dir toggle ---------- */
  function setupNotebookToggle(){
    const tree = document.getElementById('cg_nb_tree');
    if(!tree) return;
    tree.addEventListener('click', e=>{
      const btn = e.target.closest('.dir-btn');
      if(!btn) return;
      const nbItem = btn.closest('.nb-item');
      if(!nbItem) return;

      let box = nbItem.querySelector('.nb-dir-box');
      const visible = box && box.style.display !== 'none';
      if(visible){
        box.style.display = 'none';
        nbItem.classList.remove('open');
      }else{
        // collapse others
        document.querySelectorAll('#cg_nb_tree .nb-item.open').forEach(it=>{
          if(it!==nbItem){
            const bx = it.querySelector('.nb-dir-box');
            if(bx) bx.style.display='none';
            it.classList.remove('open');
          }
        });
        box = buildNotebookDir(nbItem);
        box.style.display='block';
        nbItem.classList.add('open');
      }
      e.stopPropagation();
    });
  }

  /* ---------- Initialise after DOM ready ---------- */
  document.addEventListener('DOMContentLoaded', ()=>{
    injectNotebookButtons();
    setupNotebookToggle();
    // Also re-inject buttons if notebook list is re-rendered
    const tree = document.getElementById('cg_nb_tree');
    if(tree){
      const mo = new MutationObserver(()=>injectNotebookButtons());
      mo.observe(tree,{childList:true,subtree:true});
    }
  });
})();
</script>

<script id="v297-expose">
(function(){
  try{ if(typeof window!=='undefined' && typeof renderNbTree==='function' && !window.renderNbTree){ window.renderNbTree = renderNbTree; } }catch(_){}
  try{ if(typeof window!=='undefined' && typeof renderPageStage==='function' && !window.renderPageStage){ window.renderPageStage = renderPageStage; } }catch(_){}
})();
</script>


<style id="v298re-hide-dir-btn">
/* V2.9.8re: force-hide global '目录' button and its side panel */
#entryIndexBtn, #entryIndexPanel { display:none !important; visibility:hidden !important; }
button#entryIndexBtn { display:none !important; }
</style>
<script id="v298re-hide-dir-btn-js">
(function(){
  function purge(){
    try{
      var b=document.getElementById('entryIndexBtn');
      if(b){ b.remove(); }
      var p=document.getElementById('entryIndexPanel');
      if(p){ p.remove(); }
      // Extra: remove any button whose text is exactly '目录'
      var cand = document.querySelectorAll('button');
      for(var i=0;i<cand.length;i++){
        var t=(cand[i].textContent||'').trim();
        if(t==='目录'){ cand[i].remove(); }
      }
    }catch(e){}
  }
  // Run now, on DOM ready, and on load
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', purge, {once:true});
  }
  window.addEventListener('load', purge);
  purge();
  // Observe future insertions
  try{
    var mo = new MutationObserver(function(){ purge(); });
    mo.observe(document.documentElement, {childList:true, subtree:true});
  }catch(e){}
  // And periodic check as last resort
  setInterval(purge, 1500);
})();
</script>




<style id="v299r3-nb-rename-css">
/* Wider input for notebook rename */
#cg_nb_tree .row .name .rename-input{
  width: 95%;
  max-width: none;
  font: inherit;
  padding: 2px 6px;
  border: 1px solid var(--border, #ddd);
  border-radius: 6px;
}
</style>
<script id="v299r3-nb-rename">
(function(){
  function nbStoreSafe(){
    try{ if(typeof window.nbStore==='function') return window.nbStore(); }catch(e){}
    try{ if(typeof nbStore==='function') return nbStore(); }catch(e){}
    try{ return JSON.parse(localStorage.getItem('cg_nb_store_v1')||'{}'); }catch(e){ return {}; }
  }
  function nbSaveSafe(NB){
    try{ if(typeof window.nbSave==='function') return window.nbSave(NB); }catch(e){}
    try{ if(typeof nbSave==='function') return nbSave(NB); }catch(e){}
    try{ localStorage.setItem('cg_nb_store_v1', JSON.stringify(NB)); }catch(e){}
  }
  function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;'); }

  function startEdit(span){
    if(!span || span.querySelector('input.rename-input')) return;
    var li = span.closest('.nb-item'); if(!li) return;
    var nbId = li.getAttribute('data-nbid');
    var oldText = (span.textContent||'').trim();
    span.innerHTML = '<input class="rename-input" type="text" maxlength="120" value="'+esc(oldText)+'" />';
    var inp = span.querySelector('input.rename-input');
    try{ inp.focus(); inp.select(); }catch(_){}

    function commit(){
      var v = String(inp.value||'').trim();
      var NB = nbStoreSafe();
      try{
        if(NB && Array.isArray(NB.notebooks)){
          var nb = NB.notebooks.find(function(n){ return String(n.id)===String(nbId); });
          if(nb){
            nb.name = v || nb.name || '未命名';
            nb.updated_at = Date.now();
            nbSaveSafe(NB);
          }
        }
      }catch(_){}
      try{
        var view = document.getElementById('cg_nb_view');
        var curPgId = view ? view.dataset.pageId : null;
        if(typeof renderNbTree==='function'){ renderNbTree(nbId, curPgId); }
      }catch(_){}
    }
    function cancel(){ span.textContent = oldText; }

    inp.addEventListener('keydown', function(ev){
      if(ev.key==='Enter'){ ev.preventDefault(); commit(); }
      else if(ev.key==='Escape'){ ev.preventDefault(); cancel(); }
    });
    inp.addEventListener('blur', commit);
  }

  function handlerFromEvent(e){
    var tree = document.getElementById('cg_nb_tree');
    if(!tree) return null;
    var span = e.target && e.target.closest ? e.target.closest('.nb-item .row .name') : null;
    if(span && tree.contains(span)) return span;
    return null;
  }

  function bind(){
    var tree = document.getElementById('cg_nb_tree');
    if(!tree) return;

    if(!tree.__nbRenameCaptureDbl){
      tree.__nbRenameCaptureDbl = true;
      tree.addEventListener('dblclick', function(e){
        var span = handlerFromEvent(e);
        if(!span) return;
        e.stopPropagation(); if(e.stopImmediatePropagation) e.stopImmediatePropagation();
        e.preventDefault();
        startEdit(span);
      }, true); // capture
    }

    if(!tree.__nbRenameCaptureClick2){
      tree.__nbRenameCaptureClick2 = true;
      tree.addEventListener('click', function(e){
        if(e.detail !== 2) return; // only treat double-clicked click
        var span = handlerFromEvent(e);
        if(!span) return;
        e.stopPropagation(); if(e.stopImmediatePropagation) e.stopImmediatePropagation();
        e.preventDefault();
        startEdit(span);
      }, true); // capture
    }

    // Per-node fallback (in case something swallows capture-phase higher up)
    var nodes = tree.querySelectorAll('.nb-item .row .name');
    nodes.forEach(function(span){
      if(span.__nbRenameBound) return;
      span.__nbRenameBound = true;
      span.addEventListener('dblclick', function(e){
        e.stopPropagation(); if(e.stopImmediatePropagation) e.stopImmediatePropagation();
        e.preventDefault();
        startEdit(span);
      });
      span.addEventListener('click', function(e){
        if(e.detail !== 2) return;
        e.stopPropagation(); if(e.stopImmediatePropagation) e.stopImmediatePropagation();
        e.preventDefault();
        startEdit(span);
      }, true); // capture on target too
    });
  }

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', bind, {once:true}); }
  bind();
  try{
    var tree = document.getElementById('cg_nb_tree');
    if(tree){
      var mo = new MutationObserver(function(){ bind(); });
      mo.observe(tree, {childList:true, subtree:true});
    }
  }catch(_){}
})();
</script>


<script id="v2_9_11-mobile-js">
(function(){
  function ensureBackdrop(){
    var bd = document.getElementById('drawerBackdrop');
    if(!bd){
      bd = document.createElement('div');
      bd.id = 'drawerBackdrop';
      document.body.insertBefore(bd, document.body.firstChild);
    }
    return bd;
  }
  function closeDrawer(){
    document.body.removeAttribute('data-drawer');
    document.body.style.overflow = '';
  }
  function openDrawer(){
    document.body.setAttribute('data-drawer','open');
    document.body.style.overflow = 'hidden';
  }
  function isMobile(){ return window.matchMedia('(max-width: 900px)').matches; }

  function bind(){
    var btn = document.getElementById('navToggle');
    if(btn){
      btn.addEventListener('click', function(){
  var mode; try{ mode = localStorage.getItem('cg_view_mode_1'); }catch(_){ mode=null; }
  if(mode === 'notebooks'){
    if(document.body.getAttribute('data-nbdrawer')==='open'){
      document.body.removeAttribute('data-nbdrawer'); document.body.style.overflow='';
    }else{
      document.body.setAttribute('data-nbdrawer','open'); document.body.style.overflow='hidden';
    }
  }else{
    if(document.body.getAttribute('data-drawer')==='open'){ closeDrawer(); } else { openDrawer(); }
  }
});
    }
    var bd = ensureBackdrop();
    bd.addEventListener('click', function(){
  if(document.body.getAttribute('data-nbdrawer')==='open'){
    document.body.removeAttribute('data-nbdrawer'); document.body.style.overflow='';
  }
  if(document.body.getAttribute('data-drawer')==='open') closeDrawer();
});

    document.addEventListener('keydown', function(e){
      if(e.key==='Escape'){
  if(document.body.getAttribute('data-nbdrawer')==='open'){
    document.body.removeAttribute('data-nbdrawer'); document.body.style.overflow='';
  }
  if(document.body.getAttribute('data-drawer')==='open'){ closeDrawer(); }
}
    });
    window.addEventListener('resize', function(){
      if(!isMobile()){
  document.body.removeAttribute('data-nbdrawer'); document.body.style.overflow='';
  closeDrawer();
}
    });
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', bind, {once:true});
  }else{ bind(); }
})();
</script>


<script id="v2_9_12-nb-mobile-js">
(function(){
  function ensureBackdrop(){
    var bd = document.getElementById('drawerBackdrop');
    if(!bd){
      bd = document.createElement('div'); bd.id = 'drawerBackdrop';
      document.body.insertBefore(bd, document.body.firstChild);
    }
    return bd;
  }
  function closeNb(){ document.body.removeAttribute('data-nbdrawer'); document.body.style.overflow=''; }
  function openNb(){ document.body.setAttribute('data-nbdrawer','open'); document.body.style.overflow='hidden'; }
  function isMobile(){ return window.matchMedia('(max-width: 900px)').matches; }

  function bindNbToggles(){
    var t1 = document.getElementById('nbToggle_full');
    if(t1){ t1.addEventListener('click', ()=> document.body.getAttribute('data-nbdrawer')==='open' ? closeNb() : openNb()); }
    var t2 = document.getElementById('nbToggle_stage');
    if(t2){ t2.addEventListener('click', ()=> document.body.getAttribute('data-nbdrawer')==='open' ? closeNb() : openNb()); }
  }

  function bindBackdrop(){
    var bd = ensureBackdrop();
    bd.addEventListener('click', function(){
      if(document.body.getAttribute('data-nbdrawer')==='open'){ closeNb(); }
    });
  }

  function bindEsc(){
    document.addEventListener('keydown', function(e){
      if(e.key==='Escape' && document.body.getAttribute('data-nbdrawer')==='open'){ closeNb(); }
    });
  }

  function bindResize(){
    window.addEventListener('resize', function(){
      if(!isMobile()) closeNb();
    });
  }

  function ready(fn){
    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', fn, {once:true}); }
    else fn();
  }

  ready(function(){
    bindNbToggles();
    bindBackdrop();
    bindEsc();
    bindResize();
    const obs = new MutationObserver(()=> bindNbToggles());
    obs.observe(document.body, {childList:true, subtree:true});
  });
})();
</script>
<script id="v2_9_14-toolbar-fold-js">
  (function(){
    function isMobile(){ return window.matchMedia('(max-width: 900px)').matches; }
    function setOpen(open){
      if(open){ document.body.setAttribute('data-tbar','open'); }
      else{ document.body.removeAttribute('data-tbar'); }
      var btn = document.getElementById('toolbarCaret');
      if(btn){
        btn.textContent = open ? '▴' : '▾';
        btn.setAttribute('aria-label', open ? '收起功能栏' : '展开功能栏');
        btn.setAttribute('title', open ? '收起功能栏' : '展开功能栏');
      }
    }
    function toggle(){ setOpen(!(document.body.getAttribute('data-tbar')==='open')); }
    function bind(){
      var btn = document.getElementById('toolbarCaret');
      if(btn && !btn._bound){
        btn._bound = true;
        btn.addEventListener('click', toggle);
      }
    }
    function onResize(){
    if(!isMobile()){ 
      setOpen(true);                     // 桌面端永远展开
    }else{
      // 当还没有任何会话（未上传 JSON）时，默认展开工具栏
      var hasConvs = document.querySelector('aside .list .conv-item');
      setOpen(!hasConvs);
    }
  }
    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', bind, {once:true}); }
    else bind();
    window.addEventListener('resize', onResize);
    onResize(); // 初始化一次
  })();
  </script>
  

<script id="v2_9_15-move-appearance-btn">
(function(){
  function moveAppearanceButton(){
    try{
      var header = document.querySelector('header');
      var bm = document.getElementById('cg_bm_toggle');
      var btn = document.getElementById('openTheme');
      if(!header || !btn) return;
      // Restyle to look like other toolbar buttons
      btn.classList.remove('settings-fab');
      btn.classList.add('btn');
      btn.textContent = '外观';
      btn.title = '外观';
      btn.removeAttribute('style');
      // Insert just before the "书签" button if it exists
      if(bm && bm.parentNode === header){
        header.insertBefore(btn, bm);
      }else{
        header.appendChild(btn);
      }
    }catch(e){ console.warn('moveAppearanceButton failed', e); }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', moveAppearanceButton);
  }else{
    moveAppearanceButton();
  }
})();
</script>

<script id="custom-mobile">
  (function(){
    if (!window.matchMedia('(max-width: 900px)').matches) return;   // 仅移动端
  
    /* ① 把 “外观”⚙️按钮塞进 header，放在折叠箭头左边 */
    function injectThemeBtn(){
      const btn = document.getElementById('openTheme');
      const caret = document.getElementById('toolbarCaret');
      if(btn && caret && caret.parentElement !== btn.parentElement){
        btn.classList.add('btn','mobile-only');
        caret.parentElement.insertBefore(btn, caret);
      }
    }
  
    /* ② 强制视图模式为对话，防止 navToggle 误切到笔记抽屉 */
    try{ localStorage.setItem('cg_view_mode_1','dialogue'); }catch(e){}
  
    if(document.readyState==='loading'){
      document.addEventListener('DOMContentLoaded', injectThemeBtn, {once:true});
    }else{ injectThemeBtn(); }
  })();
  </script>
  

<!-- Charlie Fix B script: close drawer when clicking outside the left panel (mobile only) -->
<script>
(function(){
  function isMobile(){ try { return window.matchMedia('(max-width: 900px)').matches; } catch(e){ return window.innerWidth <= 900; } }
  function drawerIsOpen(){ return document.body && document.body.getAttribute('data-nbdrawer') === 'open'; }
  function closeDrawer(){
    document.body.removeAttribute('data-nbdrawer');
    // recover scrolling if previous logic locked it
    document.body.style.overflow = '';
  }
  // Use capture phase so we get the event even if other handlers stop propagation
  document.addEventListener('click', function(ev){
    if (!isMobile() || !drawerIsOpen()) return;
    var stage = document.querySelector('#cg_nb_stage');
    var left = stage ? stage.querySelector('.nb-left') : null;
    if (!left) return;
    // if click is NOT inside left drawer => treat as backdrop click and close
    if (!left.contains(ev.target)) {
      closeDrawer();
    }
  }, true);

  // Optional: swipe-right to close (nice on mobile)
  var touchX = null;
  document.addEventListener('touchstart', function(e){
    if (!isMobile() || !drawerIsOpen()) return;
    if (e.touches && e.touches.length) touchX = e.touches[0].clientX;
  }, {passive:true, capture:true});
  document.addEventListener('touchend', function(e){
    if (!isMobile() || !drawerIsOpen() || touchX == null) return;
    var endX = (e.changedTouches && e.changedTouches.length) ? e.changedTouches[0].clientX : null;
    if (endX != null && touchX < endX - 40 /* swipe right */) {
      closeDrawer();
    }
    touchX = null;
  }, {passive:true, capture:true});
})();
</script>
<!-- /Charlie Fix B script -->


<!-- V2.9.19 Mobile Double‑Tap Rename -->
<script id="v2_9_19-mobile-dblrename">
(function(){
  function isMobile(){ try { return window.matchMedia('(max-width: 900px)').matches; } catch(e){ return (window.innerWidth||0) <= 900; } }
  function bindDblTap(container, selector, onDbl){
    var lastTarget = null, lastTime = 0, lastX = 0, lastY = 0;
    var THRESH_MS = 350, MOVE_TOL = 12;
    container.addEventListener('touchend', function(e){
      if(!isMobile()) return;
      try{
        var t = (e.changedTouches && e.changedTouches[0]) || null;
        if(!t) return;
        var el = e.target && (e.target.closest ? e.target.closest(selector) : null);
        if(!el){ lastTarget = null; lastTime = 0; return; }
        var now = Date.now(), x = t.clientX, y = t.clientY;
        var sameEl = (lastTarget === el);
        var fast   = (now - lastTime) < THRESH_MS;
        var close  = Math.hypot(x - lastX, y - lastY) < MOVE_TOL;
        if(sameEl && fast && close){
          // Recognized as double-tap
          e.preventDefault(); e.stopPropagation();
          try { onDbl(el, e); } catch(_) {}
          lastTarget = null; lastTime = 0;
        }else{
          lastTarget = el; lastTime = now; lastX = x; lastY = y;
        }
      }catch(_){ /* noop */ }
    }, true); // capture to beat other handlers
  }

  document.addEventListener('DOMContentLoaded', function(){
    // 1) Notebook tree (left drawer): dbl‑tap rename notebook / page names
    var tree = document.getElementById('cg_nb_tree');
    if(tree){
      bindDblTap(tree, '.nb-item .row .name, .page .pg-name', function(span){
        // Prefer native notebook rename entry point if present
        if(typeof window.startEdit === 'function'){
          try { window.startEdit(span); return; } catch(_) {}
        }
        // Fallback: simulate the existing desktop dblclick handler
        try { span.dispatchEvent(new MouseEvent('dblclick', {bubbles:true, cancelable:true})); } catch(_) {}
      });
    }

    // 2) Main stage: dbl‑tap rename conversation entry titles
    var stage = document.getElementById('cg_nb_stage') || document;
    bindDblTap(stage, '.nb-entry-head .entry-title', function(span){
      // Existing desktop flow already listens for dblclick on entry-title
      try { span.dispatchEvent(new MouseEvent('dblclick', {bubbles:true, cancelable:true})); } catch(_) {}
    });
  }, {once:true});
})();
</script>


<!-- v2.9.20 version badge override -->
<script id="v2_9_30-version-badge">
(function(){
  try{
    var VER = 'V2.9.30';
    window.__BUILD_META__ = window.__BUILD_META__ || {};
    window.__BUILD_META__.version = VER;
    var tag = document.getElementById('cg_version_badge');
    if(tag){ tag.textContent = VER; }
    if(document && document.title){
      if(document.title.indexOf(VER) < 0){
        document.title = document.title.replace(/(·\s*V\d+\.\d+(?:\.\d+)*)/,'').trim() + ' · ' + VER;
      }
    }
  }catch(e){}
})();
</script>


<!-- v2.9.22 boot hook: clear one-shot auto-refresh marker -->
<script>
(function(){
  try{
    if (sessionStorage.getItem('cg_nb_auto_refreshed')==='1'){
      sessionStorage.removeItem('cg_nb_auto_refreshed');
    }
  }catch(e){}
})();
</script>


<!-- v2.9.23: delegation safety for #cg_clear_sel -->
<script>
(function(){
  try{
    document.addEventListener('click', function(e){
      var el = e.target;
      if(!el) return;
      if(el.id === 'cg_clear_sel' || (el.closest && el.closest('#cg_clear_sel'))){
        try{
          var checks = document.querySelectorAll('.cg-check');
          checks && checks.forEach(function(c){ try{ c.checked = false; }catch(_e){} });
          if (typeof updateBatchBar === 'function') try{ updateBatchBar(); }catch(_e){}
          e.preventDefault();
          e.stopPropagation();
        }catch(_e){}
      }
    }, true);
  }catch(_e){}
})();
</script>


<!-- v2.9.24: export modal mobile css fallback -->
<style id="v2_9_24-export-mobile">
@media (max-width: 900px){
  #cg_export_modal .cg-card{
    width: 96vw;
    max-width: 96vw;
    max-height: 90vh;
    margin: 0 2vw;
  }
  #cg_export_modal .cg-card-bd{
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }
}
</style>


<!-- v2.9.26: ensure export modal is above all -->
<style id="v2_9_26-export-zfix">
#cg_export_modal{ z-index:2147483647 !important; }
#cg_export_modal .cg-mask{ z-index: 0; }
#cg_export_modal .cg-card{ z-index: 1; }
</style>


<!-- v2.9.27: bookmarks mobile full-width -->
<style id="v2_9_27-bookmarks-mobile">
@media (max-width: 900px){
  #cg_bm_drawer{
    left: 0;
    right: 0;
    width: 100vw;
    max-width: 100vw;
  }
  #cg_bm_head{
    padding: 10px 12px;
  }
  #cg_bm_body{
    flex-direction: column;
  }
  #cg_bm_tags{
    width: auto;
    max-width: 100vw;
    border-right: 0;
    border-bottom: 1px solid var(--bm-border);
    display: flex;
    gap: 6px;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    padding: 10px;
  }
  #cg_bm_tags .tag{
    flex: 0 0 auto;
    white-space: nowrap;
  }
  #cg_bm_list{
    flex: 1;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    padding: 10px;
  }
}
</style>


<!-- v2.9.28r: bookmarks drawer pointer-events fix -->
<style id="v2_9_28r-bm-pointer">
#cg_bm_drawer{ pointer-events: none; }
#cg_bm_drawer.open{ pointer-events: auto; }
</style>


<!-- v2.9.29: rename input minor styles -->
<style id="v2_9_29-bm-rename-css">
#cg_bm_list .bm-rename-input{
  font-size: 14px;
  line-height: 22px;
}
</style>


<!-- v2.9.30: mobile robustness (vh, focus lock, long-press rename) -->
<script id="v2_9_30-mobile-core">
(function(){
  try{
    // 1) --vh variable for safe viewport height (iOS Safari)
    function __setVH(){
      try{
        var vh = (window.innerHeight || document.documentElement.clientHeight || 600) * 0.01;
        document.documentElement.style.setProperty('--vh', vh + 'px');
      }catch(_e){}
    }
    __setVH();
    window.addEventListener('resize', __setVH, {passive:true});

    // 2) Focus lock for virtual keyboard on mobile (avoid layout jump/scroll bleed)
    function __isEditable(el){
      if(!el) return false;
      var tag = (el.tagName||'').toLowerCase();
      return tag==='input' || tag==='textarea' || el.isContentEditable;
    }
    document.addEventListener('focusin', function(e){
      try{
        if(__isEditable(e.target)){
          document.body && document.body.setAttribute('data-kblock','1');
          // make sure the container stays visible
          try{ e.target.scrollIntoView({block:'center', behavior:'instant'}); }catch(_e){}
        }
      }catch(_e){}
    });
    document.addEventListener('focusout', function(e){
      try{ document.body && document.body.removeAttribute('data-kblock'); }catch(_e){}
    });

    // 3) Long-press rename fallback on bookmarks (complements double-tap)
    try{
      var list = document.getElementById('cg_bm_list');
      if(list && !list.__lpBound){
        list.__lpBound = true;
        var lpTimer = null, lpTarget = null;
        list.addEventListener('touchstart', function(ev){
          var el = ev.target;
          var titleEl = (el && el.classList && el.classList.contains('title')) ? el : (el && el.closest && el.closest('.bm-item .title'));
          if(!titleEl) return;
          lpTarget = titleEl;
          lpTimer = setTimeout(function(){
            try{
              // start rename using the helper from 2.9.29 if present
              if(typeof __startRename === 'function'){ __startRename(titleEl); }
              else {
                // fallback: synthesize dblclick
                var evt = new MouseEvent('dblclick', {bubbles:true});
                titleEl.dispatchEvent(evt);
              }
            }catch(_e){}
          }, 450);
        }, {passive:true});
        ['touchend','touchcancel','touchmove'].forEach(function(type){
          list.addEventListener(type, function(){ if(lpTimer){ clearTimeout(lpTimer); lpTimer=null; lpTarget=null; } }, {passive:true});
        });
      }
    }catch(_e){}
  }catch(_e){}
})();
</script>


<!-- v2.9.30: mobile CSS enhancements -->
<style id="v2_9_30-mobile-css">
@media (max-width: 900px){
  /* Use safe viewport height */
  #cg_bm_drawer { height: calc(var(--vh, 1vh) * 100); }
  #cg_nb_drawer { height: calc(var(--vh, 1vh) * 100); }
  #cg_export_modal .cg-card { max-height: calc(var(--vh, 1vh) * 90); }
  /* Avoid iOS zoom on inputs */
  #cg_bm_list .bm-rename-input{ font-size: 16px; line-height: 22px; }
}
/* Close-state should not intercept clicks for nb drawer */
#cg_nb_drawer{ pointer-events: none; }
body[data-nbdrawer="open"] #cg_nb_drawer{ pointer-events: auto; }
/* Focus-lock visual (optional): prevent background scroll while keyboard up */
body[data-kblock="1"]{ overflow: hidden; }
</style>


<script id="v2_9_30final-credit-js">
(function(){
  function attachNotesCredit(){
    try{
      var host = document.querySelector('#cg_nb_stage .nb-left');
      if(!host || host.__creditBound) return;
      host.__creditBound = true;
      var bar = document.createElement('div');
      bar.className = 'credit-bar';
      bar.innerHTML = '<button class="eye" title="隐藏/显示">❤</button><span class="txt">制作者：C&amp;X  ~献给Charlie~</span>';
      // restore state
      if(localStorage.getItem('cg_credit_hidden') === '1') bar.setAttribute('data-hidden','1');
      // events
      bar.querySelector('.eye').addEventListener('click', function(){
        var hid = bar.getAttribute('data-hidden') === '1' ? '0' : '1';
        if(hid === '1') bar.setAttribute('data-hidden','1'); else bar.removeAttribute('data-hidden');
        localStorage.setItem('cg_credit_hidden', hid);
      });
      host.appendChild(bar);
    }catch(e){ /* no-op */ }
  }
  function bindAsideCredit(){
    var bar = document.getElementById('cg_credit_bar');
    var eye = document.getElementById('cg_credit_eye');
    if(!bar || bar.__bound) return;
    bar.__bound = true;
    // restore state
    if(localStorage.getItem('cg_credit_hidden') === '1') bar.setAttribute('data-hidden','1');
    eye.addEventListener('click', function(){
      var hid = bar.getAttribute('data-hidden') === '1' ? '0' : '1';
      if(hid === '1') bar.setAttribute('data-hidden','1'); else bar.removeAttribute('data-hidden');
      localStorage.setItem('cg_credit_hidden', hid);
    });
  }
  // init
  document.addEventListener('DOMContentLoaded', function(){
    bindAsideCredit();
    attachNotesCredit();
    // Observe notebook stage for dynamic creation
    var stg = document.getElementById('cg_nb_stage');
    if(stg && !stg.__creditObs){
      stg.__creditObs = true;
      var mo = new MutationObserver(function(){ attachNotesCredit(); });
      mo.observe(stg, { childList:true, subtree:true });
    }
  });
})();
</script>

<style id="custom-theme-panel-desktop">
  /* 仅桌面端生效（移动端 ≤900px 不变） */
  @media (min-width: 901px){
    #themePanel{
      width: min(380px, 96vw) !important;   /* ← 电脑端目标宽度 */
      max-width: min(400px, 96vw) !important;
      right: 12px !important;               /* 继续靠右；如要居中，见下 */
      left: auto !important;
      transform: none !important;           /* 若之前有居中 transform，强制清空 */
    }
  }
</style>


<script id="nb-drawer-perf-2_2">
(function(){
  if(window.__NB_DRAWER_PERF_22__) return; window.__NB_DRAWER_PERF_22__=1;
  let __nbDrawerHydrated = false;

  function hydrateDrawer(){
    try{
      if (typeof window.renderNotebooks === 'function') window.renderNotebooks();
      if (typeof window.renderPages === 'function')     window.renderPages();
      __nbDrawerHydrated = true;
    }catch(e){}
  }

  // 初次空闲期预热
  try{
    (window.requestIdleCallback 
      ? requestIdleCallback(hydrateDrawer, {timeout: 300})
      : setTimeout(hydrateDrawer, 0));
  }catch(e){}

  // 数据变更时后台刷新一次
  try{
    (window.__BUS__ || {}).on?.('nb:changed', function(){
      (window.requestIdleCallback ? requestIdleCallback(hydrateDrawer, {timeout:200}) : setTimeout(hydrateDrawer,0));
    });
  }catch(e){}

  // 视图切换后也预热一次（包装 setMode / switchMode）
  ['setMode','switchMode'].forEach(function(name){
    if (typeof window[name] === 'function'){
      const orig = window[name];
      window[name] = function(){
        const r = orig.apply(this, arguments);
        try{
          (window.requestIdleCallback ? requestIdleCallback(hydrateDrawer, {timeout:200}) : setTimeout(hydrateDrawer,0));
        }catch(e){}
        return r;
      };
    }
  });

  // 统一开关：用 body[data-nbdrawer] 控制（与现有样式兼容）
  window.toggleNotebookDrawer = function(force){
    try{
      const body = document.body;
      const current = body.getAttribute('data-nbdrawer') === 'open';
      const wantOpen = (typeof force==='boolean') ? force : !current;
      if (wantOpen && !__nbDrawerHydrated){
        hydrateDrawer();
        requestAnimationFrame(function(){ body.setAttribute('data-nbdrawer','open'); });
        return;
      }
      body.setAttribute('data-nbdrawer', wantOpen ? 'open' : 'closed');
    }catch(e){}
  };

  // 绑定汉堡按钮：点击立即切换，不做重渲染工作
  try{
    const btn = document.getElementById('cg_nb_toggle');
    if(btn && !btn.__nb22__){
      btn.__nb22__=1;
      btn.addEventListener('click', function(e){
        e.preventDefault();
        window.toggleNotebookDrawer();
      }, {passive:false});
    }
  }catch(e){}

})();
</script>
</body>
</html>

<!-- Chat Web UI – v2.7.0 (2025-08-18)
     Features: bubble click selects in selection mode; top-centered Select All; global Shift-range selection -->

<style id="v270-select-toolbar">
  /* V2.9.1: Top-centered select toolbar (shows only in selection mode) */
  #cg_select_toolbar{
    position: sticky;
    top: 0;
    z-index: 100;
    display: none;
    justify-content: center;
    padding: 6px 0;
    margin: 0 0 6px 0;
    background: var(--nav-bg, #ffffff);
    border-bottom: 1px dashed var(--border, #e5e7eb);
  }
  #cg_select_toolbar.show{ display:flex; }
  #cg_select_toolbar .cg-btn{
    padding: 6px 10px;
    border: 1px solid var(--border, #e5e7eb);
    border-radius: 8px;
    background: #fff;
    cursor: pointer;
    font-size: 12px;
    box-shadow: 0 1px 0 rgba(0,0,0,.02);
  }

  /* Minor: make bubble cursor indicate clickability in selection mode */
  body.cg-select-on .chat .msg .bubble{ cursor: pointer; }
</style>


<script id="v270-select-and-shift">
(function(){
  'use strict';

  // --- Utilities ---
  const $ = (sel, root=document)=> root.querySelector(sel);
  const $$ = (sel, root=document)=> Array.from(root.querySelectorAll(sel));

  // Track selection mode
  const SELECT = { on: !!(window.SELECT_ON) };

  // ---- Shift-range selection for multiple groups ----
  const groups = [
    { name: 'chat', containerSel: '#chat, #conversation, .chat, .conversation', checkboxSel: '.cg-check' },
    { name: 'conv', containerSel: 'aside, .list, #sidebar', checkboxSel: '.conv-check, .conv-check input[type="checkbox"]' },
    { name: 'nb-nb', containerSel: '#cg_nb_tree', checkboxSel: 'input[data-act="sel-nb"]' },
    { name: 'nb-pg', containerSel: '#cg_nb_tree', checkboxSel: 'input[data-act="sel-pg"]' }
  ];
  const lastByGroup = Object.create(null);

  function currentChecks(g){
    const cont = $(g.containerSel) || document;
    // Flatten to actual checkbox inputs
    let arr = $$(g.checkboxSel, cont).map(node => {
      if (node.matches('input[type="checkbox"]')) return node;
      const inp = node.querySelector('input[type="checkbox"]');
      return inp || node;
    }).filter(Boolean);
    return arr;
  }

  function setRange(g, fromEl, toEl, checked){
    const arr = currentChecks(g);
    const a = arr.indexOf(fromEl), b = arr.indexOf(toEl);
    if(a === -1 || b === -1) return;
    const [start, end] = a <= b ? [a, b] : [b, a];
    for(let i = start; i <= end; i++){
      const el = arr[i];
      if(el.checked !== checked){
        el.checked = checked;
        try{ el.dispatchEvent(new Event('change', { bubbles: true })); }catch(e){}
      }
    }
  }

  function handleCheckboxClick(ev, g){
    const el = ev.target.closest('input[type="checkbox"]');
    if(!el) return;
    if(ev.shiftKey){
      const last = lastByGroup[g.name];
      if(last){ setRange(g, last, el, el.checked); }
    }
    lastByGroup[g.name] = el;
    // Update toolbar state if this is chat group
    if(g.name === 'chat'){ try{ updateSelectToolbar(); }catch(e){} }
  }

  function initShiftRangeAll(){
    // Use capture at document level to avoid missing dynamically added checkboxes
    document.addEventListener('click', function(ev){
      if(!(ev.target instanceof Element)) return;
      for(const g of groups){
        if(ev.target.matches(g.checkboxSel) || ev.target.closest(g.checkboxSel)){
          handleCheckboxClick(ev, g);
          break;
        }
      }
    }, true);
  }

  // ---- Top-centered "Select All" toolbar for chat ----
  let toolbar;
  function ensureSelectToolbar(){
    try{
      if(toolbar && toolbar.isConnected) return toolbar;
      const chat = $('#chat, #conversation, .chat, .conversation');
      if(!chat || !chat.parentNode) return null;
      toolbar = document.createElement('div');
      toolbar.id = 'cg_select_toolbar';
      toolbar.innerHTML = '<button class="cg-btn" id="cg_select_all_btn">全选</button>';
      chat.parentNode.insertBefore(toolbar, chat);
      toolbar.addEventListener('click', function(ev){
        const btn = ev.target.closest('#cg_select_all_btn');
        if(!btn) return;
        const root = $('#chat, #conversation, .chat, .conversation') || document;
        const boxes = $$('.msg .cg-check', root);
        const allChecked = boxes.length > 0 && boxes.every(cb => cb.checked);
        boxes.forEach(cb => {
          cb.checked = !allChecked;
          try{ cb.dispatchEvent(new Event('change', { bubbles: true })); }catch(e){}
        });
        updateSelectToolbar();
      });
      return toolbar;
    }catch(e){ return null; }
  }

  function updateSelectToolbar(){
    const tb = ensureSelectToolbar();
    if(!tb) return;
    const root = $('#chat, #conversation, .chat, .conversation') || document;
    const boxes = $$('.msg .cg-check', root);
    const allChecked = boxes.length > 0 && boxes.every(cb => cb.checked);
    const btn = $('#cg_select_all_btn', tb);
    if(btn) btn.textContent = allChecked ? '取消全选' : '全选';
    if(SELECT.on) tb.classList.add('show'); else tb.classList.remove('show');
    // Also try to sync any existing batch bar
    try{ if(typeof updateBatchBar==='function') updateBatchBar(); }catch(e){}
  }

  // ---- Bubble click toggles checkbox in selection mode ----
  function onBubbleClick(ev){
    if(!SELECT.on) return;
    const host = ev.target.closest('.msg');
    if(!host) return;
    // ignore interactive/inline elements
    if(ev.target.closest('input,button,a,label,textarea,select,summary,details,pre code,code,pre')) return;
    // ignore when user is selecting text
    const sel = window.getSelection && String(window.getSelection());
    if(sel && sel.trim()) return;

    const cb = host.querySelector('.cg-check');
    if(!cb) return;
    const will = !cb.checked;

    // Support shift-range when clicking bubble
    if(ev.shiftKey){
      const g = groups.find(x => x.name === 'chat');
      const last = lastByGroup['chat'];
      if(last){
        setRange(g, last, cb, will);
      }else{
        cb.checked = will;
        try{ cb.dispatchEvent(new Event('change', { bubbles: true })); }catch(e){}
      }
      lastByGroup['chat'] = cb;
    }else{
      cb.checked = will;
      try{ cb.dispatchEvent(new Event('change', { bubbles: true })); }catch(e){}
      lastByGroup['chat'] = cb;
    }
    updateSelectToolbar();
  }

  // ---- Hook into existing toggleSelectMode to show/hide toolbar & bubble binding ----
  const _toggle = window.toggleSelectMode;
  window.toggleSelectMode = function(flag){
    const ret = _toggle ? _toggle.call(this, flag) : undefined;
    try{
      SELECT.on = !!window.SELECT_ON;
      ensureSelectToolbar();
      if(SELECT.on){
        document.addEventListener('click', onBubbleClick, true);
        document.body.classList.add('cg-select-on');
      }else{
        document.removeEventListener('click', onBubbleClick, true);
        document.body.classList.remove('cg-select-on');
      }
      updateSelectToolbar();
    }catch(e){}
    return ret;
  };

  // ---- Boot ----
  document.addEventListener('DOMContentLoaded', function(){
    initShiftRangeAll();
    ensureSelectToolbar();
    if(SELECT.on){
      document.addEventListener('click', onBubbleClick, true);
      document.body.classList.add('cg-select-on');
    }
    updateSelectToolbar();
    // Version bump on badge/title if present
    try{
      const VER = 'V2.9.1';
      window.__BUILD_META__ = window.__BUILD_META__ || {};
      window.__BUILD_META__.version = VER;
      const badge = document.getElementById('cg_version_badge');
      if (badge) badge.textContent = VER;
      if (document.title && !document.title.includes(VER)) document.title = document.title + ' · ' + VER;
    }catch(e){}
  });

})();
</script>


<!-- V2.9.1 Hotfix (2025-08-18): make bubble-click & top Select-All independent of toggleSelectMode() wrapping -->
<script id="v271-hotfix">
(function(){
  'use strict';
  const $ = (s, r=document)=> r.querySelector(s);
  const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));

  // Robustly resolve chat container
  function chatRoot(){
    return $('#chat') || $('.chat') || $('#conversation') || $('.conversation') || $('#main') || $('main') || document.body;
  }

  // Determine if selection mode is currently on (either global flag or presence of cg-check)
  function isSelectOn(){
    try{ if (typeof window.SELECT_ON !== 'undefined') return !!window.SELECT_ON; }catch(e){}
    const root = chatRoot();
    return $$('.msg .cg-check', root).length > 0;
  }

  // --- Toolbar creation ---
  let toolbar;
  function ensureToolbar(){
    if (toolbar && toolbar.isConnected) return toolbar;
    const root = chatRoot();
    if (!root || !root.parentNode) return null;
    toolbar = document.createElement('div');
    toolbar.id = 'cg_select_toolbar';
    toolbar.innerHTML = '<button class="cg-btn" id="cg_select_all_btn">全选</button>';
    root.parentNode.insertBefore(toolbar, root);
    // Click handler for Select All
    toolbar.addEventListener('click', function(ev){
      const btn = ev.target.closest('#cg_select_all_btn');
      if(!btn) return;
      const boxes = $$('.msg .cg-check', chatRoot());
      if (!boxes.length) return;
      const allChecked = boxes.every(cb => cb.checked);
      boxes.forEach(cb => { 
        cb.checked = !allChecked; 
        try{ cb.dispatchEvent(new Event('change', { bubbles:true })); }catch(e){} 
      });
      updateToolbar();
    });
    return toolbar;
  }

  function updateToolbar(){
    const tb = ensureToolbar();
    if(!tb) return;
    const on = isSelectOn();
    if (on) tb.classList.add('show'); else tb.classList.remove('show');
    const boxes = $$('.msg .cg-check', chatRoot());
    const allChecked = boxes.length>0 && boxes.every(cb => cb.checked);
    const btn = $('#cg_select_all_btn', tb);
    if (btn) btn.textContent = allChecked ? '取消全选' : '全选';
  }

  // - Global bubble click delegate (always attached; reads isSelectOn() at click time)
  function onBubbleClick(ev){
    if (!isSelectOn()) return;
    if (!(ev.target instanceof Element)) return;
    const host = ev.target.closest('.msg');
    if (!host) return;
    // ignore interactive elements & text selection
    if (ev.target.closest('input,button,a,label,textarea,select,summary,details,pre code,code,pre')) return;
    const sel = window.getSelection && String(window.getSelection());
    if (sel && sel.trim()) return;
    const cb = host.querySelector('.cg-check');
    if (!cb) return;
    const will = !cb.checked;
    if (ev.shiftKey){
      // rely on existing v2.7.0 range code by clicking the checkbox (dispatching click) to trigger capture handler
      cb.checked = will;
      try{ cb.dispatchEvent(new Event('click', { bubbles:true })); }catch(e){}
      try{ cb.dispatchEvent(new Event('change', { bubbles:true })); }catch(e){}
    } else {
      cb.checked = will;
      try{ cb.dispatchEvent(new Event('change', { bubbles:true })); }catch(e){}
    }
    updateToolbar();
  }

  // Attach listeners
  document.addEventListener('click', onBubbleClick, true);

  // Observe DOM to keep toolbar in sync with checkbox injection/removal
  const mutObs = new MutationObserver(updateToolbar);
  const startObs = () => {
    const root = chatRoot();
    if (!root) return;
    try{ mutObs.disconnect(); }catch(e){}
    mutObs.observe(root, { childList:true, subtree:true });
    updateToolbar();
  };
  document.addEventListener('DOMContentLoaded', startObs);
  // Also poll as a fallback (rare cases)
  setInterval(updateToolbar, 800);

  // Cosmetic: ensure cursor pointer in selection mode even without .bubble class
  const style = document.createElement('style');
  style.textContent = 'body.cg-select-on .msg{ cursor: pointer; }';
  document.head.appendChild(style);

  // Best-effort: reflect body class with current status
  setInterval(()=>{
    if (isSelectOn()) document.body.classList.add('cg-select-on');
    else document.body.classList.remove('cg-select-on');
  }, 800);

  // Version bump
  try{
    const VER='V2.9.1';
    const badge=document.getElementById('cg_version_badge');
    if (badge) badge.textContent = VER;
    if (document.title && !document.title.includes(VER)) document.title = document.title.replace('V2.9.1', VER) + ' · ' + VER;
  }catch(e){}
})();
</script>
<!-- v2.9.7: expose render functions; use NB adapter in render*; add DOM-click fallback for directory navigation -->